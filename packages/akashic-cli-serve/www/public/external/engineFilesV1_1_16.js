(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.engineFilesV1_1_16=f()}})(function(){var define,module,exports;return function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r}()({1:[function(require,module,exports){module.exports=require("./lib/main.node")},{"./lib/main.node":2}],2:[function(require,module,exports){(function(){"use strict";var __extends=this&&this.__extends||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p];function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};var g;(function(g){var AssetLoadErrorType;(function(AssetLoadErrorType){AssetLoadErrorType[AssetLoadErrorType["Unspecified"]=0]="Unspecified";AssetLoadErrorType[AssetLoadErrorType["RetryLimitExceeded"]=1]="RetryLimitExceeded";AssetLoadErrorType[AssetLoadErrorType["NetworkError"]=2]="NetworkError";AssetLoadErrorType[AssetLoadErrorType["ClientError"]=3]="ClientError";AssetLoadErrorType[AssetLoadErrorType["ServerError"]=4]="ServerError"})(AssetLoadErrorType=g.AssetLoadErrorType||(g.AssetLoadErrorType={}))})(g||(g={}));var g;(function(g){var ExceptionFactory;(function(ExceptionFactory){function createPureVirtualError(methodName,cause){var e=new Error(methodName+" has no implementation.");e.name="PureVirtualError";e.cause=cause;return e}ExceptionFactory.createPureVirtualError=createPureVirtualError;function createAssertionError(message,cause){var e=new Error(message);e.name="AssertionError";e.cause=cause;return e}ExceptionFactory.createAssertionError=createAssertionError;function createTypeMismatchError(methodName,expected,actual,cause){var message="Type mismatch on "+methodName+","+" expected type is "+expected;if(arguments.length>2){try{var actualString;if(actual&&actual.constructor&&actual.constructor.name){actualString=actual.constructor.name}else{actualString=typeof actual}message+=", actual type is "+(actualString.length>40?actualString.substr(0,40):actualString)}catch(ex){}}message+=".";var e=new Error(message);e.name="TypeMismatchError";e.cause=cause;e.expected=expected;e.actual=actual;return e}ExceptionFactory.createTypeMismatchError=createTypeMismatchError;function createAssetLoadError(message,retriable,type,cause){if(retriable===void 0){retriable=true}if(type===void 0){type=g.AssetLoadErrorType.Unspecified}var e=new Error(message);e.name="AssetLoadError";e.cause=cause;e.retriable=retriable;e.type=type;return e}ExceptionFactory.createAssetLoadError=createAssetLoadError})(ExceptionFactory=g.ExceptionFactory||(g.ExceptionFactory={}))})(g||(g={}));var g;(function(g){var ResourceFactory=function(){function ResourceFactory(){}ResourceFactory.prototype.createImageAsset=function(id,assetPath,width,height){throw g.ExceptionFactory.createPureVirtualError("ResourceFactory#createImageAsset")};ResourceFactory.prototype.createVideoAsset=function(id,assetPath,width,height,system,loop,useRealSize){throw g.ExceptionFactory.createPureVirtualError("ResourceFactory#createVideoAsset")};ResourceFactory.prototype.createAudioAsset=function(id,assetPath,duration,system,loop,hint){throw g.ExceptionFactory.createPureVirtualError("ResourceFactory#createAudioAsset")};ResourceFactory.prototype.createTextAsset=function(id,assetPath){throw g.ExceptionFactory.createPureVirtualError("ResourceFactory#createTextAsset")};ResourceFactory.prototype.createAudioPlayer=function(system){throw g.ExceptionFactory.createPureVirtualError("ResourceFactory#createAudioPlayer")};ResourceFactory.prototype.createScriptAsset=function(id,assetPath){throw g.ExceptionFactory.createPureVirtualError("ResourceFactory#createScriptAsset")};ResourceFactory.prototype.createSurface=function(width,height){throw g.ExceptionFactory.createPureVirtualError("ResourceFactory#createSurface")};ResourceFactory.prototype.createGlyphFactory=function(fontFamily,fontSize,baselineHeight,fontColor,strokeWidth,strokeColor,strokeOnly,fontWeight){throw g.ExceptionFactory.createPureVirtualError("ResourceFactory#createGlphFactory")};ResourceFactory.prototype.createSurfaceAtlas=function(width,height){return new g.SurfaceAtlas(this.createSurface(width,height))};return ResourceFactory}();g.ResourceFactory=ResourceFactory})(g||(g={}));var g;(function(g){var RequireCachedValue=function(){function RequireCachedValue(value){this._value=value}RequireCachedValue.prototype._cachedValue=function(){return this._value};return RequireCachedValue}();g.RequireCachedValue=RequireCachedValue})(g||(g={}));var g;(function(g){var RandomGenerator=function(){function RandomGenerator(seed){this.seed=seed}RandomGenerator.prototype.get=function(min,max){throw g.ExceptionFactory.createPureVirtualError("RandomGenerator#get")};RandomGenerator.prototype.serialize=function(){throw g.ExceptionFactory.createPureVirtualError("RandomGenerator#serialize")};return RandomGenerator}();g.RandomGenerator=RandomGenerator})(g||(g={}));var g;(function(g){var Asset=function(){function Asset(id,path){this.id=id;this.originalPath=path;this.path=this._assetPathFilter(path);this.onDestroyed=new g.Trigger}Asset.prototype.destroy=function(){this.onDestroyed.fire(this);this.id=undefined;this.originalPath=undefined;this.path=undefined;this.onDestroyed.destroy();this.onDestroyed=undefined};Asset.prototype.destroyed=function(){return this.id===undefined};Asset.prototype.inUse=function(){return false};Asset.prototype._load=function(loader){throw g.ExceptionFactory.createPureVirtualError("Asset#_load")};Asset.prototype._assetPathFilter=function(path){return path};return Asset}();g.Asset=Asset;var ImageAsset=function(_super){__extends(ImageAsset,_super);function ImageAsset(id,assetPath,width,height){var _this=_super.call(this,id,assetPath)||this;_this.width=width;_this.height=height;return _this}ImageAsset.prototype.asSurface=function(){throw g.ExceptionFactory.createPureVirtualError("ImageAsset#asSurface")};return ImageAsset}(Asset);g.ImageAsset=ImageAsset;var VideoAsset=function(_super){__extends(VideoAsset,_super);function VideoAsset(id,assetPath,width,height,system,loop,useRealSize){var _this=_super.call(this,id,assetPath,width,height)||this;_this.realWidth=0;_this.realHeight=0;_this._system=system;_this._loop=loop;_this._useRealSize=useRealSize;return _this}VideoAsset.prototype.asSurface=function(){throw g.ExceptionFactory.createPureVirtualError("VideoAsset#asSurface")};VideoAsset.prototype.play=function(loop){this.getPlayer().play(this);return this.getPlayer()};VideoAsset.prototype.stop=function(){this.getPlayer().stop()};VideoAsset.prototype.getPlayer=function(){throw g.ExceptionFactory.createPureVirtualError("VideoAsset#getPlayer")};VideoAsset.prototype.destroy=function(){this._system=undefined;_super.prototype.destroy.call(this)};return VideoAsset}(ImageAsset);g.VideoAsset=VideoAsset;var AudioAsset=function(_super){__extends(AudioAsset,_super);function AudioAsset(id,assetPath,duration,system,loop,hint){var _this=_super.call(this,id,assetPath)||this;_this.duration=duration;_this.loop=loop;_this.hint=hint;_this._system=system;_this.data=undefined;return _this}AudioAsset.prototype.play=function(){var player=this._system.createPlayer();player.play(this);this._lastPlayedPlayer=player;return player};AudioAsset.prototype.stop=function(){var players=this._system.findPlayers(this);for(var i=0;i<players.length;++i)players[i].stop()};AudioAsset.prototype.inUse=function(){return this._system.findPlayers(this).length>0};AudioAsset.prototype.destroy=function(){if(this._system)this.stop();this.data=undefined;this._system=undefined;this._lastPlayedPlayer=undefined;_super.prototype.destroy.call(this)};return AudioAsset}(Asset);g.AudioAsset=AudioAsset;var TextAsset=function(_super){__extends(TextAsset,_super);function TextAsset(id,assetPath){var _this=_super.call(this,id,assetPath)||this;_this.data=undefined;return _this}TextAsset.prototype.destroy=function(){this.data=undefined;_super.prototype.destroy.call(this)};return TextAsset}(Asset);g.TextAsset=TextAsset;var ScriptAsset=function(_super){__extends(ScriptAsset,_super);function ScriptAsset(){return _super!==null&&_super.apply(this,arguments)||this}ScriptAsset.prototype.execute=function(execEnv){throw g.ExceptionFactory.createPureVirtualError("ScriptAsset#execute")};ScriptAsset.prototype.destroy=function(){this.script=undefined;_super.prototype.destroy.call(this)};return ScriptAsset}(Asset);g.ScriptAsset=ScriptAsset})(g||(g={}));var g;(function(g){var AssetLoadingInfo=function(){function AssetLoadingInfo(asset,handler){this.asset=asset;this.handlers=[handler];this.errorCount=0;this.loading=false}return AssetLoadingInfo}();function normalizeAudioSystemConfMap(confMap){confMap=confMap||{};var systemDefaults={music:{loop:true,hint:{streaming:true}},sound:{loop:false,hint:{streaming:false}}};for(var key in systemDefaults){if(!(key in confMap)){confMap[key]=systemDefaults[key]}}return confMap}var AssetManager=function(){function AssetManager(game,conf,audioSystemConfMap,moduleMainScripts){this.game=game;this.configuration=this._normalize(conf||{},normalizeAudioSystemConfMap(audioSystemConfMap));this._assets={};this._liveAssetVirtualPathTable={};this._liveAbsolutePathTable={};this._moduleMainScripts=moduleMainScripts?moduleMainScripts:{};this._refCounts={};this._loadings={}}AssetManager.prototype.destroy=function(){var assetIds=Object.keys(this._refCounts);for(var i=0;i<assetIds.length;++i){this._releaseAsset(assetIds[i])}this.game=undefined;this.configuration=undefined;this._assets=undefined;this._liveAssetVirtualPathTable=undefined;this._liveAbsolutePathTable=undefined;this._refCounts=undefined;this._loadings=undefined};AssetManager.prototype.destroyed=function(){return this.game===undefined};AssetManager.prototype.retryLoad=function(asset){if(!this._loadings.hasOwnProperty(asset.id))throw g.ExceptionFactory.createAssertionError("AssetManager#retryLoad: invalid argument.");var loadingInfo=this._loadings[asset.id];if(loadingInfo.errorCount>AssetManager.MAX_ERROR_COUNT){if(!this.configuration[asset.id])return;throw g.ExceptionFactory.createAssertionError("AssetManager#retryLoad: too many retrying.")}if(!loadingInfo.loading){loadingInfo.loading=true;asset._load(this)}};AssetManager.prototype.globalAssetIds=function(){var ret=[];var conf=this.configuration;for(var p in conf){if(!conf.hasOwnProperty(p))continue;if(conf[p].global)ret.push(p)}return ret};AssetManager.prototype.requestAsset=function(assetIdOrConf,handler){var assetId=typeof assetIdOrConf==="string"?assetIdOrConf:assetIdOrConf.id;var waiting=false;var loadingInfo;if(this._assets.hasOwnProperty(assetId)){++this._refCounts[assetId];handler._onAssetLoad(this._assets[assetId])}else if(this._loadings.hasOwnProperty(assetId)){loadingInfo=this._loadings[assetId];loadingInfo.handlers.push(handler);++this._refCounts[assetId];waiting=true}else{var a=this._createAssetFor(assetIdOrConf);loadingInfo=new AssetLoadingInfo(a,handler);this._loadings[assetId]=loadingInfo;this._refCounts[assetId]=1;waiting=true;loadingInfo.loading=true;a._load(this)}return waiting};AssetManager.prototype.unrefAsset=function(assetOrId){var assetId=typeof assetOrId==="string"?assetOrId:assetOrId.id;if(--this._refCounts[assetId]>0)return;this._releaseAsset(assetId)};AssetManager.prototype.requestAssets=function(assetIdOrConfs,handler){var waitingCount=0;for(var i=0,len=assetIdOrConfs.length;i<len;++i){if(this.requestAsset(assetIdOrConfs[i],handler)){++waitingCount}}return waitingCount};AssetManager.prototype.unrefAssets=function(assetOrIds){for(var i=0,len=assetOrIds.length;i<len;++i){this.unrefAsset(assetOrIds[i])}};AssetManager.prototype._normalize=function(configuration,audioSystemConfMap){var ret={};if(!(configuration instanceof Object))throw g.ExceptionFactory.createAssertionError("AssetManager#_normalize: invalid arguments.");for(var p in configuration){if(!configuration.hasOwnProperty(p))continue;var conf=Object.create(configuration[p]);if(!conf.path){throw g.ExceptionFactory.createAssertionError("AssetManager#_normalize: No path given for: "+p)}if(!conf.virtualPath){throw g.ExceptionFactory.createAssertionError("AssetManager#_normalize: No virtualPath given for: "+p)}if(!conf.type){throw g.ExceptionFactory.createAssertionError("AssetManager#_normalize: No type given for: "+p)}if(conf.type==="image"){if(typeof conf.width!=="number")throw g.ExceptionFactory.createAssertionError("AssetManager#_normalize: wrong width given for the image asset: "+p);if(typeof conf.height!=="number")throw g.ExceptionFactory.createAssertionError("AssetManager#_normalize: wrong height given for the image asset: "+p)}if(conf.type==="audio"){if(conf.duration===undefined)conf.duration=0;var audioSystemConf=audioSystemConfMap[conf.systemId];if(conf.loop===undefined){conf.loop=!!audioSystemConf&&!!audioSystemConf.loop}if(conf.hint===undefined){conf.hint=audioSystemConf?audioSystemConf.hint:{}}}if(conf.type==="video"){if(!conf.useRealSize){if(typeof conf.width!=="number")throw g.ExceptionFactory.createAssertionError("AssetManager#_normalize: wrong width given for the video asset: "+p);if(typeof conf.height!=="number")throw g.ExceptionFactory.createAssertionError("AssetManager#_normalize: wrong height given for the video asset: "+p);conf.useRealSize=false}}if(!conf.global)conf.global=false;ret[p]=conf}return ret};AssetManager.prototype._createAssetFor=function(idOrConf){var id;var uri;var conf;if(typeof idOrConf==="string"){id=idOrConf;conf=this.configuration[id];uri=this.configuration[id].path}else{var dynConf=idOrConf;id=dynConf.id;conf=dynConf;uri=dynConf.uri}var resourceFactory=this.game.resourceFactory;if(!conf)throw g.ExceptionFactory.createAssertionError("AssetManager#_createAssetFor: unknown asset ID: "+id);switch(conf.type){case"image":return resourceFactory.createImageAsset(id,uri,conf.width,conf.height);case"audio":var system=conf.systemId?this.game.audio[conf.systemId]:this.game.audio[this.game.defaultAudioSystemId];return resourceFactory.createAudioAsset(id,uri,conf.duration,system,conf.loop,conf.hint);case"text":return resourceFactory.createTextAsset(id,uri);case"script":return resourceFactory.createScriptAsset(id,uri);case"video":return resourceFactory.createVideoAsset(id,uri,conf.width,conf.height,new g.VideoSystem,conf.loop,conf.useRealSize);default:throw g.ExceptionFactory.createAssertionError("AssertionError#_createAssetFor: unknown asset type "+conf.type+" for asset ID: "+id)}};AssetManager.prototype._releaseAsset=function(assetId){var asset=this._assets[assetId]||this._loadings[assetId]&&this._loadings[assetId].asset;var path;if(asset){path=asset.path;if(asset.inUse()){if(asset instanceof g.AudioAsset){asset._system.requestDestroy(asset)}else if(asset instanceof g.VideoAsset){asset.destroy()}else{throw g.ExceptionFactory.createAssertionError("AssetManager#unrefAssets: Unsupported in-use "+asset.constructor.name)}}else{asset.destroy()}}delete this._refCounts[assetId];delete this._loadings[assetId];delete this._assets[assetId];if(this.configuration[assetId]){var virtualPath=this.configuration[assetId].virtualPath;if(virtualPath&&this._liveAssetVirtualPathTable.hasOwnProperty(virtualPath))delete this._liveAssetVirtualPathTable[virtualPath];if(path&&this._liveAbsolutePathTable.hasOwnProperty(path))delete this._liveAbsolutePathTable[path]}};AssetManager.prototype._countLoadingAsset=function(){return Object.keys(this._loadings).length};AssetManager.prototype._onAssetError=function(asset,error){if(this.destroyed()||asset.destroyed())return;var loadingInfo=this._loadings[asset.id];var hs=loadingInfo.handlers;loadingInfo.loading=false;++loadingInfo.errorCount;if(loadingInfo.errorCount>AssetManager.MAX_ERROR_COUNT&&error.retriable){error=g.ExceptionFactory.createAssetLoadError("Retry limit exceeded",false,g.AssetLoadErrorType.RetryLimitExceeded,error)}if(!error.retriable)delete this._loadings[asset.id];for(var i=0;i<hs.length;++i)hs[i]._onAssetError(asset,error,this)};AssetManager.prototype._onAssetLoad=function(asset){if(this.destroyed()||asset.destroyed())return;var loadingInfo=this._loadings[asset.id];loadingInfo.loading=false;delete this._loadings[asset.id];this._assets[asset.id]=asset;if(this.configuration[asset.id]){var virtualPath=this.configuration[asset.id].virtualPath;if(!this._liveAssetVirtualPathTable.hasOwnProperty(virtualPath)){this._liveAssetVirtualPathTable[virtualPath]=asset}else{if(this._liveAssetVirtualPathTable[virtualPath].path!==asset.path)throw g.ExceptionFactory.createAssertionError("AssetManager#_onAssetLoad(): duplicated asset path")}if(!this._liveAbsolutePathTable.hasOwnProperty(asset.path))this._liveAbsolutePathTable[asset.path]=virtualPath}var hs=loadingInfo.handlers;for(var i=0;i<hs.length;++i)hs[i]._onAssetLoad(asset)};return AssetManager}();AssetManager.MAX_ERROR_COUNT=3;g.AssetManager=AssetManager})(g||(g={}));var g;(function(g){function _require(game,path,currentModule){var targetScriptAsset;var resolvedPath;var liveAssetVirtualPathTable=game._assetManager._liveAssetVirtualPathTable;var moduleMainScripts=game._assetManager._moduleMainScripts;if(path.indexOf("/")===-1){if(game._assetManager._assets.hasOwnProperty(path)){targetScriptAsset=game._assetManager._assets[path];resolvedPath=game._assetManager._liveAbsolutePathTable[targetScriptAsset.path]}}if(/^\.\/|^\.\.\/|^\//.test(path)){if(currentModule){if(!currentModule._virtualDirname)throw g.ExceptionFactory.createAssertionError("g._require: require from DynamicAsset is not supported");resolvedPath=g.PathUtil.resolvePath(currentModule._virtualDirname,path)}else{if(!/^\.\//.test(path))throw g.ExceptionFactory.createAssertionError("g._require: entry point path must start with './'");resolvedPath=path.substring(2)}if(game._scriptCaches.hasOwnProperty(resolvedPath)){return game._scriptCaches[resolvedPath]._cachedValue()}else if(game._scriptCaches.hasOwnProperty(resolvedPath+".js")){return game._scriptCaches[resolvedPath+".js"]._cachedValue()}if(!targetScriptAsset)targetScriptAsset=g.Util.findAssetByPathAsFile(resolvedPath,liveAssetVirtualPathTable);if(!targetScriptAsset)targetScriptAsset=g.Util.findAssetByPathAsDirectory(resolvedPath,liveAssetVirtualPathTable)}else{if(moduleMainScripts[path]){resolvedPath=moduleMainScripts[path];targetScriptAsset=game._assetManager._liveAssetVirtualPathTable[resolvedPath]}if(!targetScriptAsset){var dirs=currentModule?currentModule.paths:[];dirs.push("node_modules");for(var i=0;i<dirs.length;++i){var dir=dirs[i];resolvedPath=g.PathUtil.resolvePath(dir,path);targetScriptAsset=g.Util.findAssetByPathAsFile(resolvedPath,liveAssetVirtualPathTable);if(targetScriptAsset)break;targetScriptAsset=g.Util.findAssetByPathAsDirectory(resolvedPath,liveAssetVirtualPathTable);if(targetScriptAsset)break}}}if(targetScriptAsset){if(game._scriptCaches.hasOwnProperty(resolvedPath))return game._scriptCaches[resolvedPath]._cachedValue();if(targetScriptAsset instanceof g.ScriptAsset){var context=new g.ScriptAssetContext(game,targetScriptAsset);game._scriptCaches[resolvedPath]=context;return context._executeScript(currentModule)}else if(targetScriptAsset instanceof g.TextAsset){if(targetScriptAsset&&g.PathUtil.resolveExtname(path)===".json"){var cache=game._scriptCaches[resolvedPath]=new g.RequireCachedValue(JSON.parse(targetScriptAsset.data));return cache._cachedValue()}}}throw g.ExceptionFactory.createAssertionError("g._require: can not find module: "+path)}g._require=_require;var Module=function(){function Module(game,id,path){var _this=this;var dirname=g.PathUtil.resolveDirname(path);var virtualPath=game._assetManager._liveAbsolutePathTable[path];var virtualDirname=virtualPath?g.PathUtil.resolveDirname(virtualPath):undefined;var _g=Object.create(g,{game:{value:game,enumerable:true},filename:{value:path,enumerable:true},dirname:{value:dirname,enumerable:true},module:{value:this,writable:true,enumerable:true,configurable:true}});this.id=id;this.filename=path;this.exports={};this.parent=null;this.loaded=false;this.children=[];this.paths=virtualDirname?g.PathUtil.makeNodeModulePaths(virtualDirname):[];this._dirname=dirname;this._virtualDirname=virtualDirname;this._g=_g;this.require=function(path){return path==="g"?_g:g._require(game,path,_this)}}return Module}();g.Module=Module})(g||(g={}));var g;(function(g){var ScriptAssetContext=function(){function ScriptAssetContext(game,asset){this._game=game;this._asset=asset;this._module=new g.Module(game,asset.path,asset.path);this._g=this._module._g;this._started=false}ScriptAssetContext.prototype._cachedValue=function(){if(!this._started)throw g.ExceptionFactory.createAssertionError("ScriptAssetContext#_cachedValue: not executed yet.");return this._module.exports};ScriptAssetContext.prototype._executeScript=function(currentModule){if(this._started)return this._module.exports;if(currentModule){this._module.parent=currentModule;currentModule.children.push(this._module)}this._started=true;this._asset.execute(this._g);this._module.loaded=true;return this._module.exports};return ScriptAssetContext}();g.ScriptAssetContext=ScriptAssetContext})(g||(g={}));var g;(function(g){var PlainMatrix=function(){function PlainMatrix(widthOrSrc,height,scaleX,scaleY,angle){if(widthOrSrc===undefined){this._modified=false;this._matrix=[1,0,0,1,0,0]}else if(typeof widthOrSrc==="number"){this._modified=false;this._matrix=new Array(6);this.update(widthOrSrc,height,scaleX,scaleY,angle,0,0)}else{this._modified=widthOrSrc._modified;this._matrix=[widthOrSrc._matrix[0],widthOrSrc._matrix[1],widthOrSrc._matrix[2],widthOrSrc._matrix[3],widthOrSrc._matrix[4],widthOrSrc._matrix[5]]}}PlainMatrix.prototype.update=function(width,height,scaleX,scaleY,angle,x,y){var r=angle*Math.PI/180;var _cos=Math.cos(r);var _sin=Math.sin(r);var a=_cos*scaleX;var b=_sin*scaleX;var c=_sin*scaleY;var d=_cos*scaleY;var w=width/2;var h=height/2;this._matrix[0]=a;this._matrix[1]=b;this._matrix[2]=-c;this._matrix[3]=d;this._matrix[4]=-a*w+c*h+w+x;this._matrix[5]=-b*w-d*h+h+y};PlainMatrix.prototype.updateByInverse=function(width,height,scaleX,scaleY,angle,x,y){var r=angle*Math.PI/180;var _cos=Math.cos(r);var _sin=Math.sin(r);var a=_cos/scaleX;var b=_sin/scaleY;var c=_sin/scaleX;var d=_cos/scaleY;var w=width/2;var h=height/2;this._matrix[0]=a;this._matrix[1]=-b;this._matrix[2]=c;this._matrix[3]=d;this._matrix[4]=-a*(w+x)-c*(h+y)+w;this._matrix[5]=b*(w+x)-d*(h+y)+h};PlainMatrix.prototype.multiply=function(matrix){var m1=this._matrix;var m2=matrix._matrix;var m10=m1[0];var m11=m1[1];var m12=m1[2];var m13=m1[3];m1[0]=m10*m2[0]+m12*m2[1];m1[1]=m11*m2[0]+m13*m2[1];m1[2]=m10*m2[2]+m12*m2[3];m1[3]=m11*m2[2]+m13*m2[3];m1[4]=m10*m2[4]+m12*m2[5]+m1[4];m1[5]=m11*m2[4]+m13*m2[5]+m1[5]};PlainMatrix.prototype.multiplyNew=function(matrix){var ret=this.clone();ret.multiply(matrix);return ret};PlainMatrix.prototype.reset=function(x,y){this._matrix[0]=1;this._matrix[1]=0;this._matrix[2]=0;this._matrix[3]=1;this._matrix[4]=x||0;this._matrix[5]=y||0};PlainMatrix.prototype.clone=function(){return new PlainMatrix(this)};PlainMatrix.prototype.multiplyInverseForPoint=function(point){var m=this._matrix;var _id=1/(m[0]*m[3]+m[2]*-m[1]);return{x:m[3]*_id*point.x+-m[2]*_id*point.y+(m[5]*m[2]-m[4]*m[3])*_id,y:m[0]*_id*point.y+-m[1]*_id*point.x+(-m[5]*m[0]+m[4]*m[1])*_id}};PlainMatrix.prototype.scale=function(x,y){var m=this._matrix;m[0]*=x;m[1]*=y;m[2]*=x;m[3]*=y;m[4]*=x;m[5]*=y};PlainMatrix.prototype.multiplyPoint=function(point){var m=this._matrix;var x=m[0]*point.x+m[2]*point.y+m[4];var y=m[1]*point.x+m[3]*point.y+m[5];return{x:x,y:y}};PlainMatrix.prototype.multplyPoint=function(point){return this.multiplyPoint(point)};return PlainMatrix}();g.PlainMatrix=PlainMatrix})(g||(g={}));var g;(function(g){var Util;(function(Util){function distance(p1x,p1y,p2x,p2y){return Math.sqrt(Math.pow(p1x-p2x,2)+Math.pow(p1y-p2y,2))}Util.distance=distance;function distanceBetweenOffsets(p1,p2){return Util.distance(p1.x,p1.y,p2.x,p2.y)}Util.distanceBetweenOffsets=distanceBetweenOffsets;function distanceBetweenAreas(p1,p2){return Util.distance(p1.x-p1.width/2,p1.y-p1.height/2,p2.x-p2.width/2,p2.y-p2.height/2)}Util.distanceBetweenAreas=distanceBetweenAreas;function createMatrix(width,height,scaleX,scaleY,angle){if(width===undefined)return new g.PlainMatrix;return new g.PlainMatrix(width,height,scaleX,scaleY,angle)}Util.createMatrix=createMatrix;function createSpriteFromE(scene,e,camera){var oldX=e.x;var oldY=e.y;var x=0;var y=0;var width=e.width;var height=e.height;var boundingRect=e.calculateBoundingRect(camera);if(!boundingRect){throw g.ExceptionFactory.createAssertionError("Util#createSpriteFromE: camera must look e")}width=boundingRect.right-boundingRect.left;height=boundingRect.bottom-boundingRect.top;if(boundingRect.left<e.x)x=e.x-boundingRect.left;if(boundingRect.top<e.y)y=e.y-boundingRect.top;e.moveTo(x,y);if(e._matrix)e._matrix._modified=true;var surface=scene.game.resourceFactory.createSurface(Math.ceil(width),Math.ceil(height));var renderer=surface.renderer();renderer.begin();e.render(renderer,camera);renderer.end();var s=new g.Sprite({scene:scene,src:surface,width:width,height:height});s.moveTo(boundingRect.left,boundingRect.top);e.moveTo(oldX,oldY);if(e._matrix)e._matrix._modified=true;return s}Util.createSpriteFromE=createSpriteFromE;function createSpriteFromScene(toScene,fromScene,camera){var surface=toScene.game.resourceFactory.createSurface(Math.ceil(fromScene.game.width),Math.ceil(fromScene.game.height));var renderer=surface.renderer();renderer.begin();var children=fromScene.children;for(var i=0;i<children.length;++i)children[i].render(renderer,camera);renderer.end();return new g.Sprite({scene:toScene,src:surface,width:fromScene.game.width,height:fromScene.game.height})}Util.createSpriteFromScene=createSpriteFromScene;function asSurface(src){if(!src)return src;if(src instanceof g.Surface)return src;if(src instanceof g.ImageAsset)return src.asSurface();throw g.ExceptionFactory.createTypeMismatchError("Util#asSurface","ImageAsset|Surface",src)}Util.asSurface=asSurface;function findAssetByPathAsFile(resolvedPath,liveAssetPathTable){if(liveAssetPathTable.hasOwnProperty(resolvedPath))return liveAssetPathTable[resolvedPath];if(liveAssetPathTable.hasOwnProperty(resolvedPath+".js"))return liveAssetPathTable[resolvedPath+".js"];return undefined}Util.findAssetByPathAsFile=findAssetByPathAsFile;function findAssetByPathAsDirectory(resolvedPath,liveAssetPathTable){var path;path=resolvedPath+"/package.json";if(liveAssetPathTable.hasOwnProperty(path)&&liveAssetPathTable[path]instanceof g.TextAsset){var pkg=JSON.parse(liveAssetPathTable[path].data);if(pkg&&typeof pkg.main==="string"){var asset=Util.findAssetByPathAsFile(g.PathUtil.resolvePath(resolvedPath,pkg.main),liveAssetPathTable);if(asset)return asset}}path=resolvedPath+"/index.js";if(liveAssetPathTable.hasOwnProperty(path))return liveAssetPathTable[path];return undefined}Util.findAssetByPathAsDirectory=findAssetByPathAsDirectory;function charCodeAt(str,idx){var code=str.charCodeAt(idx);if(55296<=code&&code<=56319){var hi=code;var low=str.charCodeAt(idx+1);return hi<<16|low}if(56320<=code&&code<=57343){return null}return code}Util.charCodeAt=charCodeAt;function setupAnimatingHandler(animatingHandler,surface){if(surface.isDynamic){surface.animatingStarted.handle(animatingHandler,animatingHandler._onAnimatingStarted);surface.animatingStopped.handle(animatingHandler,animatingHandler._onAnimatingStopped);if(surface.isPlaying()){animatingHandler._onAnimatingStarted()}}}Util.setupAnimatingHandler=setupAnimatingHandler;function migrateAnimatingHandler(animatingHandler,beforeSurface,afterSurface){animatingHandler._onAnimatingStopped();if(!beforeSurface.destroyed()&&beforeSurface.isDynamic){beforeSurface.animatingStarted.remove(animatingHandler,animatingHandler._onAnimatingStarted);beforeSurface.animatingStopped.remove(animatingHandler,animatingHandler._onAnimatingStopped)}if(afterSurface.isDynamic){afterSurface.animatingStarted.handle(animatingHandler,animatingHandler._onAnimatingStarted);afterSurface.animatingStopped.handle(animatingHandler,animatingHandler._onAnimatingStopped);if(afterSurface.isPlaying()){animatingHandler._onAnimatingStarted()}}}Util.migrateAnimatingHandler=migrateAnimatingHandler})(Util=g.Util||(g.Util={}))})(g||(g={}));var g;(function(g){var Collision;(function(Collision){function intersect(x1,y1,width1,height1,x2,y2,width2,height2){return x1<=x2+width2&&x2<=x1+width1&&y1<=y2+height2&&y2<=y1+height1}Collision.intersect=intersect;function intersectAreas(t1,t2){return Collision.intersect(t1.x,t1.y,t1.width,t1.height,t2.x,t2.y,t2.width,t2.height)}Collision.intersectAreas=intersectAreas;function within(t1x,t1y,t2x,t2y,distance){if(distance===void 0){distance=1}return distance>=g.Util.distance(t1x,t1y,t2x,t2y)}Collision.within=within;function withinAreas(t1,t2,distance){if(distance===void 0){distance=1}return distance>=g.Util.distanceBetweenAreas(t1,t2)}Collision.withinAreas=withinAreas})(Collision=g.Collision||(g.Collision={}))})(g||(g={}));var g;(function(g){var Trigger=function(){function Trigger(chain){this.chain=chain;this._handlers=[]}Trigger.prototype.handle=function(owner,handler,name){if(!this._handlers.length)this._activateChain();if(!handler){this._handlers.push({owner:undefined,handler:owner,name:name})}else{this._handlers.push({owner:owner,handler:handler,name:name})}};Trigger.prototype.destroy=function(){this._deactivateChain();this.chain=undefined;this._handlers=undefined};Trigger.prototype.destroyed=function(){return this._handlers===undefined};Trigger.prototype.hasHandler=function(){return this._handlers&&this._handlers.length>0};Trigger.prototype.handleInsert=function(index,owner,handler,name){if(!this._handlers.length)this._activateChain();if(!handler){this._handlers.splice(index,0,{owner:undefined,handler:owner,name:name})}else{this._handlers.splice(index,0,{owner:owner,handler:handler,name:name})}};Trigger.prototype.removeAll=function(owner){var handlers=[];var tmp;while(tmp=this._handlers.shift())if(tmp.owner!==owner)handlers.push(tmp);this._handlers=handlers;if(!this._handlers.length)this._deactivateChain()};Trigger.prototype.removeAllByHandler=function(handler){var handlers=[];var tmp;while(tmp=this._handlers.shift())if(tmp.handler!==handler)handlers.push(tmp);this._handlers=handlers;if(!this._handlers.length)this._deactivateChain()};Trigger.prototype.remove=function(owner,handler){var handlers=[];if(!handler){handler=owner;owner=undefined}for(var i=0;i<this._handlers.length;++i){var tmp=this._handlers[i];if(tmp.handler!==handler||tmp.owner!==owner)handlers.push(tmp)}this._handlers=handlers;if(!this._handlers.length)this._deactivateChain()};Trigger.prototype.removeByName=function(name){var handlers=[];for(var i=0;i<this._handlers.length;++i){var tmp=this._handlers[i];if(tmp.name!==name)handlers.push(tmp)}this._handlers=handlers;if(!this._handlers.length)this._deactivateChain()};Trigger.prototype.isHandled=function(owner,handler){if(!handler){handler=owner;owner=undefined}for(var i=0;i<this._handlers.length;++i){if(this._handlers[i].owner===owner&&this._handlers[i].handler===handler)return true}return false};Trigger.prototype.fire=function(param){if(!this._handlers||!this._handlers.length)return;var handlers=this._handlers.concat();for(var i=0;i<handlers.length;++i){var handler=handlers[i];if(handler.handler.call(handler.owner,param))this._remove(handler)}};Trigger.prototype._reset=function(){this._handlers=[];this._deactivateChain()};Trigger.prototype._activateChain=function(){if(!this.chain)return;if(this.chain.isHandled(this,this._onChainFire))return;this.chain.handle(this,this._onChainFire)};Trigger.prototype._deactivateChain=function(){if(!this.chain)return;if(!this.chain.isHandled(this,this._onChainFire))return;this.chain.remove(this,this._onChainFire)};Trigger.prototype._remove=function(handler){var index=this._handlers.indexOf(handler);if(index===-1)return;this._handlers.splice(index,1);if(!this._handlers.length)this._deactivateChain()};Trigger.prototype._onChainFire=function(e){this.fire(e)};return Trigger}();g.Trigger=Trigger;var ConditionalChainTrigger=function(_super){__extends(ConditionalChainTrigger,_super);function ConditionalChainTrigger(chain,filterOwner,filter){var _this=_super.call(this,chain)||this;_this.filterOwner=filterOwner;_this.filter=filter;return _this}ConditionalChainTrigger.prototype._onChainFire=function(e){if(this.filter&&!this.filter.call(this.filterOwner,e))return;this.fire(e)};return ConditionalChainTrigger}(Trigger);g.ConditionalChainTrigger=ConditionalChainTrigger})(g||(g={}));var g;(function(g){var Timer=function(){function Timer(interval,fps){this.interval=interval;this._scaledInterval=Math.round(interval*fps);this.elapsed=new g.Trigger;this._scaledElapsed=0}Timer.prototype.tick=function(){this._scaledElapsed+=1e3;while(this._scaledElapsed>=this._scaledInterval){if(!this.elapsed){break}this.elapsed.fire();this._scaledElapsed-=this._scaledInterval}};Timer.prototype.canDelete=function(){return!this.elapsed.hasHandler()};Timer.prototype.destroy=function(){this.interval=undefined;this.elapsed.destroy();this.elapsed=undefined;this._scaledInterval=0;this._scaledElapsed=0};Timer.prototype.destroyed=function(){return this.elapsed===undefined};return Timer}();g.Timer=Timer})(g||(g={}));var g;(function(g){var TimerIdentifier=function(){function TimerIdentifier(timer,handler,handlerOwner,fired,firedOwner){this._timer=timer;this._handler=handler;this._handlerOwner=handlerOwner;this._fired=fired;this._firedOwner=firedOwner;this._timer.elapsed.handle(this,this._fire)}TimerIdentifier.prototype.destroy=function(){this._timer.elapsed.remove(this,this._fire);this._timer=undefined;this._handler=undefined;this._handlerOwner=undefined;this._fired=undefined;this._firedOwner=undefined};TimerIdentifier.prototype.destroyed=function(){return this._timer===undefined};TimerIdentifier.prototype._fire=function(){this._handler.call(this._handlerOwner);if(this._fired){this._fired.call(this._firedOwner,this)}};return TimerIdentifier}();g.TimerIdentifier=TimerIdentifier;var TimerManager=function(){function TimerManager(trigger,fps){this._timers=[];this._trigger=trigger;this._identifiers=[];this._fps=fps;this._registered=false}TimerManager.prototype.destroy=function(){for(var i=0;i<this._identifiers.length;++i){this._identifiers[i].destroy()}for(var i=0;i<this._timers.length;++i){this._timers[i].destroy()}this._timers=undefined;this._trigger=undefined;this._identifiers=undefined;this._fps=undefined};TimerManager.prototype.destroyed=function(){return this._timers===undefined};TimerManager.prototype.createTimer=function(interval){if(!this._registered){this._trigger.handle(this,this._tick);this._registered=true}if(interval<0)throw g.ExceptionFactory.createAssertionError("TimerManager#createTimer: invalid interval");if(interval<1)interval=1;var acceptableMargin=Math.min(1e3,interval*this._fps);for(var i=0;i<this._timers.length;++i){if(this._timers[i].interval===interval){if(this._timers[i]._scaledElapsed<acceptableMargin){return this._timers[i]}}}var timer=new g.Timer(interval,this._fps);this._timers.push(timer);return timer};TimerManager.prototype.deleteTimer=function(timer){if(!timer.canDelete())return;var index=this._timers.indexOf(timer);if(index<0)throw g.ExceptionFactory.createAssertionError("TimerManager#deleteTimer: can not find timer");this._timers.splice(index,1);timer.destroy();if(!this._timers.length){if(!this._registered)throw g.ExceptionFactory.createAssertionError("TimerManager#deleteTimer: handler is not handled");this._trigger.remove(this,this._tick);this._registered=false}};TimerManager.prototype.setTimeout=function(milliseconds,owner,handler){if(handler===undefined){handler=owner;owner=null}var timer=this.createTimer(milliseconds);var identifier=new TimerIdentifier(timer,handler,owner,this._onTimeoutFired,this);this._identifiers.push(identifier);return identifier};TimerManager.prototype.clearTimeout=function(identifier){this._clear(identifier)};TimerManager.prototype.setInterval=function(interval,owner,handler){if(handler===undefined){handler=owner;owner=null}var timer=this.createTimer(interval);var identifier=new TimerIdentifier(timer,handler,owner);this._identifiers.push(identifier);return identifier};TimerManager.prototype.clearInterval=function(identifier){this._clear(identifier)};TimerManager.prototype._tick=function(){var timers=this._timers.concat();for(var i=0;i<timers.length;++i)timers[i].tick()};TimerManager.prototype._onTimeoutFired=function(identifier){var index=this._identifiers.indexOf(identifier);if(index<0)throw g.ExceptionFactory.createAssertionError("TimerManager#_onTimeoutFired: can not find identifier");this._identifiers.splice(index,1);var timer=identifier._timer;identifier.destroy();this.deleteTimer(timer)};TimerManager.prototype._clear=function(identifier){var index=this._identifiers.indexOf(identifier);if(index<0)throw g.ExceptionFactory.createAssertionError("TimerManager#_clear: can not find identifier");if(identifier.destroyed())throw g.ExceptionFactory.createAssertionError("TimerManager#_clear: invalid identifier");this._identifiers.splice(index,1);var timer=identifier._timer;identifier.destroy();this.deleteTimer(timer)};return TimerManager}();g.TimerManager=TimerManager})(g||(g={}));var g;(function(g){var AudioPlayer=function(){function AudioPlayer(system){this.played=new g.Trigger;this.stopped=new g.Trigger;this.currentAudio=undefined;this.volume=system.volume;this._muted=system._muted;this._playbackRate=system._playbackRate;this._system=system}AudioPlayer.prototype.play=function(audio){this.currentAudio=audio;this.played.fire({player:this,audio:audio})};AudioPlayer.prototype.stop=function(){var audio=this.currentAudio;if(!audio)return;this.currentAudio=undefined;this.stopped.fire({player:this,audio:audio})};AudioPlayer.prototype.canHandleStopped=function(){return true};AudioPlayer.prototype.changeVolume=function(volume){this.volume=volume};AudioPlayer.prototype._changeMuted=function(muted){this._muted=muted};AudioPlayer.prototype._changePlaybackRate=function(rate){this._playbackRate=rate};AudioPlayer.prototype._supportsPlaybackRate=function(){return false};AudioPlayer.prototype._onVolumeChanged=function(){};return AudioPlayer}();g.AudioPlayer=AudioPlayer})(g||(g={}));var g;(function(g){var AudioSystem=function(){function AudioSystem(id,game){var audioSystemManager=game._audioSystemManager;this.id=id;this.game=game;this._volume=1;this._destroyRequestedAssets={};this._muted=audioSystemManager._muted;this._playbackRate=audioSystemManager._playbackRate}Object.defineProperty(AudioSystem.prototype,"volume",{get:function(){return this._volume},set:function(value){if(value<0||value>1||isNaN(value)||typeof value!=="number")throw g.ExceptionFactory.createAssertionError("AudioSystem#volume: expected: 0.0-1.0, actual: "+value);this._volume=value;this._onVolumeChanged()},enumerable:true,configurable:true});AudioSystem.prototype.stopAll=function(){throw g.ExceptionFactory.createPureVirtualError("AudioSystem#stopAll")};AudioSystem.prototype.findPlayers=function(asset){throw g.ExceptionFactory.createPureVirtualError("AudioSystem#findPlayers")};AudioSystem.prototype.createPlayer=function(){throw g.ExceptionFactory.createPureVirtualError("AudioSystem#createPlayer")};AudioSystem.prototype.requestDestroy=function(asset){this._destroyRequestedAssets[asset.id]=asset};AudioSystem.prototype._reset=function(){this.stopAll();this._volume=1;this._destroyRequestedAssets={};this._muted=this.game._audioSystemManager._muted;this._playbackRate=this.game._audioSystemManager._playbackRate};AudioSystem.prototype._setMuted=function(value){var before=this._muted;this._muted=!!value;if(this._muted!==before){this._onMutedChanged()}};AudioSystem.prototype._setPlaybackRate=function(value){if(value<0||isNaN(value)||typeof value!=="number")throw g.ExceptionFactory.createAssertionError("AudioSystem#playbackRate: expected: greater or equal to 0.0, actual: "+value);var before=this._playbackRate;this._playbackRate=value;if(this._playbackRate!==before){this._onPlaybackRateChanged()}};AudioSystem.prototype._onVolumeChanged=function(){throw g.ExceptionFactory.createPureVirtualError("AudioSystem#_onVolumeChanged")};AudioSystem.prototype._onMutedChanged=function(){throw g.ExceptionFactory.createPureVirtualError("AudioSystem#_onMutedChanged")};AudioSystem.prototype._onPlaybackRateChanged=function(){throw g.ExceptionFactory.createPureVirtualError("AudioSystem#_onPlaybackRateChanged")};return AudioSystem}();g.AudioSystem=AudioSystem;var MusicAudioSystem=function(_super){__extends(MusicAudioSystem,_super);function MusicAudioSystem(id,game){var _this=_super.call(this,id,game)||this;_this._player=undefined;_this._suppressingAudio=undefined;return _this}Object.defineProperty(MusicAudioSystem.prototype,"player",{get:function(){if(!this._player){this._player=this.game.resourceFactory.createAudioPlayer(this);this._player.played.handle(this,this._onPlayerPlayed);this._player.stopped.handle(this,this._onPlayerStopped)}return this._player},set:function(v){this._player=v},enumerable:true,configurable:true});MusicAudioSystem.prototype.findPlayers=function(asset){if(this.player.currentAudio&&this.player.currentAudio.id===asset.id)return[this.player];return[]};MusicAudioSystem.prototype.createPlayer=function(){return this.player};MusicAudioSystem.prototype.stopAll=function(){if(!this._player)return;this._player.stop()};MusicAudioSystem.prototype._reset=function(){_super.prototype._reset.call(this);if(this._player){this._player.played.remove({owner:this,func:this._onPlayerPlayed});this._player.stopped.remove({owner:this,func:this._onPlayerStopped})}this._player=undefined;this._suppressingAudio=undefined};MusicAudioSystem.prototype._onVolumeChanged=function(){this.player.changeVolume(this._volume)};MusicAudioSystem.prototype._onMutedChanged=function(){this.player._changeMuted(this._muted)};MusicAudioSystem.prototype._onPlaybackRateChanged=function(){var player=this.player;player._changePlaybackRate(this._playbackRate);if(!player._supportsPlaybackRate()){this._onUnsupportedPlaybackRateChanged()}};MusicAudioSystem.prototype._onUnsupportedPlaybackRateChanged=function(){if(this._playbackRate===1){if(this._suppressingAudio){var audio=this._suppressingAudio;this._suppressingAudio=undefined;if(!audio.destroyed()){this.player.play(audio)}}}};MusicAudioSystem.prototype._onPlayerPlayed=function(e){if(e.player!==this._player)throw g.ExceptionFactory.createAssertionError("MusicAudioSystem#_onPlayerPlayed: unexpected audio player");if(e.player._supportsPlaybackRate())return;if(this._playbackRate!==1){e.player.stop();this._suppressingAudio=e.audio}};MusicAudioSystem.prototype._onPlayerStopped=function(e){if(this._destroyRequestedAssets[e.audio.id]){delete this._destroyRequestedAssets[e.audio.id];e.audio.destroy()}};return MusicAudioSystem}(AudioSystem);g.MusicAudioSystem=MusicAudioSystem;var SoundAudioSystem=function(_super){__extends(SoundAudioSystem,_super);function SoundAudioSystem(id,game){var _this=_super.call(this,id,game)||this;_this.players=[];return _this}SoundAudioSystem.prototype.createPlayer=function(){var player=this.game.resourceFactory.createAudioPlayer(this);if(player.canHandleStopped())this.players.push(player);player.played.handle(this,this._onPlayerPlayed);player.stopped.handle(this,this._onPlayerStopped);return player};SoundAudioSystem.prototype.findPlayers=function(asset){var ret=[];for(var i=0;i<this.players.length;++i){if(this.players[i].currentAudio&&this.players[i].currentAudio.id===asset.id)ret.push(this.players[i])}return ret};SoundAudioSystem.prototype.stopAll=function(){var players=this.players.concat();for(var i=0;i<players.length;++i){players[i].stop()}};SoundAudioSystem.prototype._reset=function(){_super.prototype._reset.call(this);for(var i=0;i<this.players.length;++i){var player=this.players[i];player.played.remove({owner:this,func:this._onPlayerPlayed});player.stopped.remove({owner:this,func:this._onPlayerStopped})}this.players=[]};SoundAudioSystem.prototype._onMutedChanged=function(){var players=this.players;for(var i=0;i<players.length;++i){players[i]._changeMuted(this._muted)}};SoundAudioSystem.prototype._onPlaybackRateChanged=function(){var players=this.players;for(var i=0;i<players.length;++i){players[i]._changePlaybackRate(this._playbackRate)}};SoundAudioSystem.prototype._onPlayerPlayed=function(e){if(e.player._supportsPlaybackRate())return;if(this._playbackRate!==1){e.player.stop()}};SoundAudioSystem.prototype._onPlayerStopped=function(e){var index=this.players.indexOf(e.player);if(index<0)return;e.player.stopped.remove(this,this._onPlayerStopped);this.players.splice(index,1);if(this._destroyRequestedAssets[e.audio.id]){delete this._destroyRequestedAssets[e.audio.id];e.audio.destroy()}};SoundAudioSystem.prototype._onVolumeChanged=function(){for(var i=0;i<this.players.length;++i){this.players[i].changeVolume(this._volume)}};return SoundAudioSystem}(AudioSystem);g.SoundAudioSystem=SoundAudioSystem})(g||(g={}));var g;(function(g){var VideoPlayer=function(){function VideoPlayer(loop){this._loop=!!loop;this.played=new g.Trigger;this.stopped=new g.Trigger;this.currentVideo=undefined;this.volume=1}VideoPlayer.prototype.play=function(videoAsset){this.currentVideo=videoAsset;this.played.fire({player:this,video:videoAsset});videoAsset.asSurface().animatingStarted.fire()};VideoPlayer.prototype.stop=function(){var videoAsset=this.currentVideo;this.stopped.fire({player:this,video:videoAsset});videoAsset.asSurface().animatingStopped.fire()};VideoPlayer.prototype.changeVolume=function(volume){this.volume=volume};return VideoPlayer}();g.VideoPlayer=VideoPlayer})(g||(g={}));var g;(function(g){var VideoSystem=function(){function VideoSystem(){}return VideoSystem}();g.VideoSystem=VideoSystem})(g||(g={}));var g;(function(g){var Object2D=function(){function Object2D(param){if(!param){this.x=0;this.y=0;this.width=0;this.height=0;this.opacity=1;this.scaleX=1;this.scaleY=1;this.angle=0;this.compositeOperation=undefined;this._matrix=undefined}else{this.x=param.x||0;this.y=param.y||0;this.width=param.width||0;this.height=param.height||0;this.opacity="opacity"in param?param.opacity:1;this.scaleX="scaleX"in param?param.scaleX:1;this.scaleY="scaleY"in param?param.scaleY:1;this.angle=param.angle||0;this.compositeOperation=param.compositeOperation;this._matrix=undefined}}Object2D.prototype.moveTo=function(posOrX,y){if(typeof posOrX==="number"&&typeof y!=="number"){throw g.ExceptionFactory.createAssertionError("Object2D#moveTo: arguments must be CommonOffset or pair of x and y as a number.")}if(typeof posOrX==="number"){this.x=posOrX;this.y=y}else{this.x=posOrX.x;this.y=posOrX.y}};Object2D.prototype.moveBy=function(x,y){this.x+=x;this.y+=y};Object2D.prototype.resizeTo=function(sizeOrWidth,height){if(typeof sizeOrWidth==="number"&&typeof height!=="number"){throw g.ExceptionFactory.createAssertionError("Object2D#resizeTo: arguments must be CommonSize or pair of width and height as a number.")}if(typeof sizeOrWidth==="number"){this.width=sizeOrWidth;this.height=height}else{this.width=sizeOrWidth.width;this.height=sizeOrWidth.height}};Object2D.prototype.resizeBy=function(width,height){this.width+=width;this.height+=height};Object2D.prototype.scale=function(scale){this.scaleX=scale;this.scaleY=scale};Object2D.prototype.getMatrix=function(){if(!this._matrix){this._matrix=g.Util.createMatrix()}else if(!this._matrix._modified){return this._matrix}this._updateMatrix();this._matrix._modified=false;return this._matrix};Object2D.prototype._updateMatrix=function(){if(this.angle||this.scaleX!==1||this.scaleY!==1){this._matrix.update(this.width,this.height,this.scaleX,this.scaleY,this.angle,this.x,this.y)}else{this._matrix.reset(this.x,this.y)}};return Object2D}();g.Object2D=Object2D})(g||(g={}));var g;(function(g){var E=function(_super){__extends(E,_super);function E(sceneOrParam){var _this=this;if(sceneOrParam instanceof g.Scene){var scene=sceneOrParam;_this=_super.call(this)||this;_this.children=undefined;_this.parent=undefined;_this._touchable=false;_this.state=0;_this._hasTouchableChildren=false;_this._update=undefined;_this._message=undefined;_this._pointDown=undefined;_this._pointMove=undefined;_this._pointUp=undefined;_this._targetCameras=undefined;_this.local=scene.local!==g.LocalTickMode.NonLocal;scene.register(_this);scene.game.logger.debug("[deprecated] E or Subclass of E: This constructor is deprecated. "+"Refer to the API documentation and use each constructor(param: ParameterObject) instead.")}else{var param=sceneOrParam;_this=_super.call(this,param)||this;_this.children=undefined;_this.parent=undefined;_this._touchable=false;_this.state=0;_this._hasTouchableChildren=false;_this._update=undefined;_this._message=undefined;_this._pointDown=undefined;_this._pointMove=undefined;_this._pointUp=undefined;_this._targetCameras=undefined;_this.tag=param.tag;_this.local=param.scene.local!==g.LocalTickMode.NonLocal||!!param.local;if(param.children){for(var i=0;i<param.children.length;++i)_this.append(param.children[i])}if(param.parent){param.parent.append(_this)}if(param.targetCameras)_this.targetCameras=param.targetCameras;if("touchable"in param)_this.touchable=param.touchable;if(!!param.hidden)_this.hide();_this.id=param.id;param.scene.register(_this)}return _this}Object.defineProperty(E.prototype,"update",{get:function(){if(!this._update)this._update=new g.Trigger(this.scene.update);return this._update},enumerable:true,configurable:true});Object.defineProperty(E.prototype,"message",{get:function(){if(!this._message)this._message=new g.Trigger(this.scene.message);return this._message},enumerable:true,configurable:true});Object.defineProperty(E.prototype,"pointDown",{get:function(){if(!this._pointDown)this._pointDown=new g.ConditionalChainTrigger(this.scene.pointDownCapture,this,this._isTargetOperation);return this._pointDown},enumerable:true,configurable:true});Object.defineProperty(E.prototype,"pointUp",{get:function(){if(!this._pointUp)this._pointUp=new g.ConditionalChainTrigger(this.scene.pointUpCapture,this,this._isTargetOperation);return this._pointUp},enumerable:true,configurable:true});Object.defineProperty(E.prototype,"pointMove",{get:function(){if(!this._pointMove)this._pointMove=new g.ConditionalChainTrigger(this.scene.pointMoveCapture,this,this._isTargetOperation);return this._pointMove},enumerable:true,configurable:true});Object.defineProperty(E.prototype,"targetCameras",{get:function(){return this._targetCameras||(this._targetCameras=[])},set:function(v){this._targetCameras=v},enumerable:true,configurable:true});Object.defineProperty(E.prototype,"touchable",{get:function(){return this._touchable},set:function(v){if(this._touchable===v)return;this._touchable=v;if(v){this._enableTouchPropagation()}else{this._disableTouchPropagation()}},enumerable:true,configurable:true});E.prototype.render=function(renderer,camera){this.state&=~4;if(this.state&1)return;var cams=this._targetCameras;if(cams&&cams.length>0&&(!camera||cams.indexOf(camera)===-1))return;if(this.state&8){renderer.translate(this.x,this.y);var goDown=this.renderSelf(renderer,camera);if(goDown&&this.children){var children=this.children;var len=children.length;for(var i=0;i<len;++i)children[i].render(renderer,camera)}renderer.translate(-this.x,-this.y);return}renderer.save();if(this.angle||this.scaleX!==1||this.scaleY!==1){renderer.transform(this.getMatrix()._matrix)}else{renderer.translate(this.x,this.y)}if(this.opacity!==1)renderer.opacity(this.opacity);if(this.compositeOperation!==undefined)renderer.setCompositeOperation(this.compositeOperation);var goDown=this.renderSelf(renderer,camera);if(goDown&&this.children){var children=this.children;for(var i=0;i<children.length;++i)children[i].render(renderer,camera)}renderer.restore()};E.prototype.renderSelf=function(renderer,camera){return true};E.prototype.game=function(){return this.scene.game};E.prototype.append=function(e){this.insertBefore(e,undefined)};E.prototype.insertBefore=function(e,target){if(e.parent)e.remove();if(!this.children)this.children=[];e.parent=this;var index=-1;if(target!==undefined&&(index=this.children.indexOf(target))>-1){this.children.splice(index,0,e)}else{this.children.push(e)}if(e._touchable||e._hasTouchableChildren){this._hasTouchableChildren=true;this._enableTouchPropagation()}this.modified(true)};E.prototype.remove=function(e){if(e===undefined){this.parent.remove(this);return}var index=this.children?this.children.indexOf(e):-1;if(index<0)throw g.ExceptionFactory.createAssertionError("E#remove: invalid child");this.children[index].parent=undefined;this.children.splice(index,1);if(e._touchable||e._hasTouchableChildren){if(!this._findTouchableChildren(this)){this._hasTouchableChildren=false;this._disableTouchPropagation()}}this.modified(true)};E.prototype.destroy=function(){if(this.parent)this.remove();if(this.children){while(this.children.length)this.children[this.children.length-1].destroy();this.children=undefined}if(this._update){this._update.destroy();this._update=undefined}if(this._message){this._message.destroy();this._message=undefined}if(this._pointDown){this._pointDown.destroy();this._pointDown=undefined}if(this._pointMove){this._pointMove.destroy();this._pointMove=undefined}if(this._pointUp){this._pointUp.destroy();this._pointUp=undefined}this.scene.unregister(this)};E.prototype.destroyed=function(){return this.scene===undefined};E.prototype.modified=function(isBubbling){if(this._matrix)this._matrix._modified=true;if(this.angle||this.scaleX!==1||this.scaleY!==1||this.opacity!==1||this.compositeOperation!==undefined){this.state&=~8}else{this.state|=8}if(this.state&4)return;this.state|=4;if(this.parent)this.parent.modified(true)};E.prototype.shouldFindChildrenByPoint=function(point){return true};E.prototype.findPointSourceByPoint=function(point,m,force,camera){if(this.state&1)return undefined;var cams=this._targetCameras;if(cams&&cams.length>0&&(!camera||cams.indexOf(camera)===-1))return undefined;m=m?m.multiplyNew(this.getMatrix()):this.getMatrix().clone();var p=m.multiplyInverseForPoint(point);if(this._hasTouchableChildren||force&&this.children&&this.children.length){if(this.shouldFindChildrenByPoint(p)){for(var i=this.children.length-1;i>=0;--i){var child=this.children[i];if(force||child._touchable||child._hasTouchableChildren){var target=child.findPointSourceByPoint(point,m,force,camera);if(target)return target}}}}if(!(force||this._touchable))return undefined;if(0<=p.x&&this.width>p.x&&0<=p.y&&this.height>p.y){return{target:this,point:p}}return undefined};E.prototype.visible=function(){return(this.state&1)!==1};E.prototype.show=function(){if(!(this.state&1))return;this.state&=~1;if(this.parent){this.parent.modified(true)}};E.prototype.hide=function(){if(this.state&1)return;this.state|=1;if(this.parent){this.parent.modified(true)}};E.prototype.calculateBoundingRect=function(c){return this._calculateBoundingRect(undefined,c)};E.prototype._calculateBoundingRect=function(m,c){var matrix=this.getMatrix();if(m){matrix=m.multiplyNew(matrix)}if(!this.visible()||c&&(!this._targetCameras||this._targetCameras.indexOf(c)===-1)){return undefined}var thisBoundingRect={left:0,right:this.width,top:0,bottom:this.height};var targetCoordinates=[{x:thisBoundingRect.left,y:thisBoundingRect.top},{x:thisBoundingRect.left,y:thisBoundingRect.bottom},{x:thisBoundingRect.right,y:thisBoundingRect.top},{x:thisBoundingRect.right,y:thisBoundingRect.bottom}];var convertedPoint=matrix.multiplyPoint(targetCoordinates[0]);var result={left:convertedPoint.x,right:convertedPoint.x,top:convertedPoint.y,bottom:convertedPoint.y};for(var i=1;i<targetCoordinates.length;++i){convertedPoint=matrix.multiplyPoint(targetCoordinates[i]);if(result.left>convertedPoint.x)result.left=convertedPoint.x;if(result.right<convertedPoint.x)result.right=convertedPoint.x;if(result.top>convertedPoint.y)result.top=convertedPoint.y;if(result.bottom<convertedPoint.y)result.bottom=convertedPoint.y}if(this.children!==undefined){for(var i=0;i<this.children.length;++i){var nowResult=this.children[i]._calculateBoundingRect(matrix,c);if(nowResult){if(result.left>nowResult.left)result.left=nowResult.left;if(result.right<nowResult.right)result.right=nowResult.right;if(result.top>nowResult.top)result.top=nowResult.top;if(result.bottom<nowResult.bottom)result.bottom=nowResult.bottom}}}return result};E.prototype._enableTouchPropagation=function(){var p=this.parent;while(p instanceof E&&!p._hasTouchableChildren){p._hasTouchableChildren=true;p=p.parent}};E.prototype._disableTouchPropagation=function(){var p=this.parent;while(p instanceof E&&p._hasTouchableChildren){if(this._findTouchableChildren(p))break;p._hasTouchableChildren=false;p=p.parent}};E.prototype._isTargetOperation=function(e){if(this.state&1)return false;if(e instanceof g.PointEvent)return this._touchable&&e.target===this;return false};E.prototype._findTouchableChildren=function(e){if(e.children){for(var i=0;i<e.children.length;++i){if(e.children[i].touchable)return e.children[i];var tmp=this._findTouchableChildren(e.children[i]);if(tmp)return tmp}}return undefined};return E}(g.Object2D);g.E=E})(g||(g={}));var g;(function(g){var CacheableE=function(_super){__extends(CacheableE,_super);function CacheableE(sceneOrParam){var _this=_super.call(this,sceneOrParam)||this;_this._shouldRenderChildren=true;_this._cache=undefined;_this._renderer=undefined;_this._renderedCamera=undefined;return _this}CacheableE.prototype.invalidate=function(){this.state&=~2;this.modified()};CacheableE.prototype.renderSelf=function(renderer,camera){var padding=CacheableE.PADDING;if(this._renderedCamera!==camera){this.state&=~2;this._renderedCamera=camera}if(!(this.state&2)){this._cacheSize=this.calculateCacheSize();var w=Math.ceil(this._cacheSize.width)+padding*2;var h=Math.ceil(this._cacheSize.height)+padding*2;var isNew=!this._cache||this._cache.width<w||this._cache.height<h;if(isNew){if(this._cache&&!this._cache.destroyed()){this._cache.destroy()}this._cache=this.scene.game.resourceFactory.createSurface(w,h);this._renderer=this._cache.renderer()}var cacheRenderer=this._renderer;cacheRenderer.begin();if(!isNew){cacheRenderer.clear()}cacheRenderer.save();cacheRenderer.translate(padding,padding);this.renderCache(cacheRenderer,camera);cacheRenderer.restore();this.state|=2;cacheRenderer.end()}if(this._cache&&this._cacheSize.width>0&&this._cacheSize.height>0){renderer.translate(-padding,-padding);this.renderSelfFromCache(renderer);renderer.translate(padding,padding)}return this._shouldRenderChildren};CacheableE.prototype.renderSelfFromCache=function(renderer){renderer.drawImage(this._cache,0,0,this._cacheSize.width+CacheableE.PADDING,this._cacheSize.height+CacheableE.PADDING,0,0)};CacheableE.prototype.renderCache=function(renderer,camera){throw g.ExceptionFactory.createPureVirtualError("CacheableE#renderCache")};CacheableE.prototype.destroy=function(){if(this._cache&&!this._cache.destroyed()){this._cache.destroy()}this._cache=undefined;_super.prototype.destroy.call(this)};CacheableE.prototype.calculateCacheSize=function(){return{width:this.width,height:this.height}};return CacheableE}(g.E);CacheableE.PADDING=1;g.CacheableE=CacheableE})(g||(g={}));var g;(function(g){var StorageRegion;(function(StorageRegion){StorageRegion[StorageRegion["Slots"]=1]="Slots";StorageRegion[StorageRegion["Scores"]=2]="Scores";StorageRegion[StorageRegion["Counts"]=3]="Counts";StorageRegion[StorageRegion["Values"]=4]="Values"})(StorageRegion=g.StorageRegion||(g.StorageRegion={}));var StorageOrder;(function(StorageOrder){StorageOrder[StorageOrder["Asc"]=0]="Asc";StorageOrder[StorageOrder["Desc"]=1]="Desc"})(StorageOrder=g.StorageOrder||(g.StorageOrder={}));var StorageCondition;(function(StorageCondition){StorageCondition[StorageCondition["Equal"]=1]="Equal";StorageCondition[StorageCondition["GreaterThan"]=2]="GreaterThan";StorageCondition[StorageCondition["LessThan"]=3]="LessThan"})(StorageCondition=g.StorageCondition||(g.StorageCondition={}));var StorageCountsOperation;(function(StorageCountsOperation){StorageCountsOperation[StorageCountsOperation["Incr"]=1]="Incr";StorageCountsOperation[StorageCountsOperation["Decr"]=2]="Decr"})(StorageCountsOperation=g.StorageCountsOperation||(g.StorageCountsOperation={}));var StorageValueStore=function(){function StorageValueStore(keys,values){this._keys=keys;this._values=values}StorageValueStore.prototype.get=function(keyOrIndex){if(this._values===undefined){return[]}if(typeof keyOrIndex==="number"){return this._values[keyOrIndex]}else{var index=this._keys.indexOf(keyOrIndex);if(index!==-1){return this._values[index]}for(var i=0;i<this._keys.length;++i){var target=this._keys[i];if(target.region===keyOrIndex.region&&target.regionKey===keyOrIndex.regionKey&&target.userId===keyOrIndex.userId&&target.gameId===keyOrIndex.gameId){return this._values[i]}}}return[]};StorageValueStore.prototype.getOne=function(keyOrIndex){var values=this.get(keyOrIndex);if(!values)return undefined;return values[0]};return StorageValueStore}();g.StorageValueStore=StorageValueStore;var StorageLoader=function(){function StorageLoader(storage,keys,serialization){this._loaded=false;this._storage=storage;this._valueStore=new StorageValueStore(keys);this._handler=undefined;this._valueStoreSerialization=serialization}StorageLoader.prototype._load=function(handler){this._handler=handler;if(this._storage._load){this._storage._load.call(this._storage,this._valueStore._keys,this,this._valueStoreSerialization)}};StorageLoader.prototype._onLoaded=function(values,serialization){this._valueStore._values=values;this._loaded=true;if(serialization)this._valueStoreSerialization=serialization;if(this._handler)this._handler._onStorageLoaded()};StorageLoader.prototype._onError=function(error){if(this._handler)this._handler._onStorageLoadError(error)};return StorageLoader}();g.StorageLoader=StorageLoader;var Storage=function(){function Storage(game){this._game=game}Storage.prototype.write=function(key,value,option){if(this._write){this._write(key,value,option)}};Storage.prototype.requestValuesForJoinPlayer=function(keys){this._requestedKeysForJoinPlayer=keys};Storage.prototype._createLoader=function(keys,serialization){return new StorageLoader(this,keys,serialization)};Storage.prototype._registerWrite=function(write){this._write=write};Storage.prototype._registerLoad=function(load){this._load=load};return Storage}();g.Storage=Storage})(g||(g={}));var g;(function(g){var SceneAssetHolder=function(){function SceneAssetHolder(param){this.waitingAssetsCount=param.assetIds.length;this._scene=param.scene;this._assetManager=param.assetManager;this._assetIds=param.assetIds;this._assets=[];this._handler=param.handler;this._handlerOwner=param.handlerOwner||null;this._direct=!!param.direct;this._requested=false}SceneAssetHolder.prototype.request=function(){if(this.waitingAssetsCount===0)return false;if(this._requested)return true;this._requested=true;this._assetManager.requestAssets(this._assetIds,this);return true};SceneAssetHolder.prototype.destroy=function(){if(this._requested){this._assetManager.unrefAssets(this._assets)}this.waitingAssetsCount=0;this._scene=undefined;this._assetIds=undefined;this._handler=undefined;this._requested=false};SceneAssetHolder.prototype.destroyed=function(){return!this._scene};SceneAssetHolder.prototype.callHandler=function(){this._handler.call(this._handlerOwner)};SceneAssetHolder.prototype._onAssetError=function(asset,error,assetManager){if(this.destroyed()||this._scene.destroyed())return;var failureInfo={asset:asset,error:error,cancelRetry:false};this._scene.assetLoadFailed.fire(failureInfo);if(error.retriable&&!failureInfo.cancelRetry){this._assetManager.retryLoad(asset)}else{if(this._assetManager.configuration[asset.id]){this._scene.game.terminateGame();this._scene.game._abortGame()}}this._scene.assetLoadCompleted.fire(asset)};SceneAssetHolder.prototype._onAssetLoad=function(asset){if(this.destroyed()||this._scene.destroyed())return;this._scene.assets[asset.id]=asset;this._scene.assetLoaded.fire(asset);this._scene.assetLoadCompleted.fire(asset);this._assets.push(asset);--this.waitingAssetsCount;if(this.waitingAssetsCount<0)throw g.ExceptionFactory.createAssertionError("SceneAssetHolder#_onAssetLoad: broken waitingAssetsCount");if(this.waitingAssetsCount>0)return;if(this._direct){this.callHandler()}else{this._scene.game._callSceneAssetHolderHandler(this)}};return SceneAssetHolder}();g.SceneAssetHolder=SceneAssetHolder;var SceneState;(function(SceneState){SceneState[SceneState["Destroyed"]=0]="Destroyed";SceneState[SceneState["Standby"]=1]="Standby";SceneState[SceneState["Active"]=2]="Active";SceneState[SceneState["Deactive"]=3]="Deactive";SceneState[SceneState["BeforeDestroyed"]=4]="BeforeDestroyed"})(SceneState=g.SceneState||(g.SceneState={}));var SceneLoadState;(function(SceneLoadState){SceneLoadState[SceneLoadState["Initial"]=0]="Initial";SceneLoadState[SceneLoadState["Ready"]=1]="Ready";SceneLoadState[SceneLoadState["ReadyFired"]=2]="ReadyFired";SceneLoadState[SceneLoadState["LoadedFired"]=3]="LoadedFired"})(SceneLoadState=g.SceneLoadState||(g.SceneLoadState={}));var Scene=function(){function Scene(gameOrParam,assetIds){var game;var local;var tickGenerationMode;if(gameOrParam instanceof g.Game){game=gameOrParam;local=g.LocalTickMode.NonLocal;tickGenerationMode=g.TickGenerationMode.ByClock;game.logger.debug("[deprecated] Scene:This constructor is deprecated. Refer to the API documentation and use Scene(param: SceneParameterObject) instead.")}else{var param=gameOrParam;game=param.game;assetIds=param.assetIds;if(!param.storageKeys){this._storageLoader=undefined;this.storageValues=undefined}else{this._storageLoader=game.storage._createLoader(param.storageKeys,param.storageValuesSerialization);this.storageValues=this._storageLoader._valueStore}local=param.local===undefined?g.LocalTickMode.NonLocal:param.local===false?g.LocalTickMode.NonLocal:param.local===true?g.LocalTickMode.FullLocal:param.local;tickGenerationMode=param.tickGenerationMode!==undefined?param.tickGenerationMode:g.TickGenerationMode.ByClock;this.name=param.name}if(!assetIds)assetIds=[];this.game=game;this.local=local;this.tickGenerationMode=tickGenerationMode;this.loaded=new g.Trigger;this._ready=new g.Trigger;this.assets={};this._loaded=false;this._prefetchRequested=false;this._loadingState=SceneLoadState.Initial;this.update=new g.Trigger;this._timer=new g.TimerManager(this.update,this.game.fps);this.assetLoaded=new g.Trigger;this.assetLoadFailed=new g.Trigger;this.assetLoadCompleted=new g.Trigger;this.message=new g.Trigger;this.pointDownCapture=new g.Trigger;this.pointMoveCapture=new g.Trigger;this.pointUpCapture=new g.Trigger;this.operation=new g.Trigger;this.children=[];this.state=SceneState.Standby;this.stateChanged=new g.Trigger;this._assetHolders=[];this._sceneAssetHolder=new SceneAssetHolder({scene:this,assetManager:this.game._assetManager,assetIds:assetIds,handler:this._onSceneAssetsLoad,handlerOwner:this,direct:true})}Scene.prototype.modified=function(isBubbling){this.game.modified=true};Scene.prototype.destroy=function(){this.state=SceneState.BeforeDestroyed;this.stateChanged.fire(this.state);var gameDb=this.game.db;for(var p in gameDb){if(gameDb.hasOwnProperty(p)&&gameDb[p].scene===this)gameDb[p].destroy()}var gameDb=this.game._localDb;for(var p in gameDb){if(gameDb.hasOwnProperty(p)&&gameDb[p].scene===this)gameDb[p].destroy()}this._timer.destroy();this.update.destroy();this.message.destroy();this.pointDownCapture.destroy();this.pointMoveCapture.destroy();this.pointUpCapture.destroy();this.operation.destroy();this.loaded.destroy();this.assetLoaded.destroy();this.assetLoadFailed.destroy();this.assetLoadCompleted.destroy();this.assets={};for(var i=0;i<this._assetHolders.length;++i)this._assetHolders[i].destroy();this._sceneAssetHolder.destroy();this._storageLoader=undefined;this.game=undefined;this.state=SceneState.Destroyed;this.stateChanged.fire(this.state);this.stateChanged.destroy()};Scene.prototype.destroyed=function(){return this.game===undefined};Scene.prototype.createTimer=function(interval){return this._timer.createTimer(interval)};Scene.prototype.deleteTimer=function(timer){this._timer.deleteTimer(timer)};Scene.prototype.setInterval=function(interval,owner,handler){return this._timer.setInterval(interval,owner,handler)};Scene.prototype.clearInterval=function(identifier){this._timer.clearInterval(identifier)};Scene.prototype.setTimeout=function(milliseconds,owner,handler){return this._timer.setTimeout(milliseconds,owner,handler)};Scene.prototype.clearTimeout=function(identifier){this._timer.clearTimeout(identifier)};Scene.prototype.isCurrentScene=function(){return this.game.scene()===this};Scene.prototype.gotoScene=function(next,toPush){if(!this.isCurrentScene())throw g.ExceptionFactory.createAssertionError("Scene#gotoScene: this scene is not the current scene");if(toPush){this.game.pushScene(next)}else{this.game.replaceScene(next)}};Scene.prototype.end=function(){if(!this.isCurrentScene())throw g.ExceptionFactory.createAssertionError("Scene#end: this scene is not the current scene");this.game.popScene()};Scene.prototype.register=function(e){this.game.register(e);e.scene=this};Scene.prototype.unregister=function(e){e.scene=undefined;this.game.unregister(e)};Scene.prototype.append=function(e){this.insertBefore(e,undefined)};Scene.prototype.insertBefore=function(e,target){if(e.parent)e.remove();e.parent=this;var index=-1;if(target!==undefined&&(index=this.children.indexOf(target))>-1){this.children.splice(index,0,e)}else{this.children.push(e)}this.modified(true)};Scene.prototype.remove=function(e){var index=this.children.indexOf(e);if(index===-1)return;this.children[index].parent=undefined;this.children.splice(index,1);this.modified(true)};Scene.prototype.findPointSourceByPoint=function(point,force,camera){var mayConsumeLocalTick=this.local!==g.LocalTickMode.NonLocal;var children=this.children;var m=undefined;if(camera&&camera instanceof g.Camera2D)m=camera.getMatrix();for(var i=children.length-1;i>=0;--i){var ret=children[i].findPointSourceByPoint(point,m,force,camera);if(ret){ret.local=ret.target.local||mayConsumeLocalTick;return ret}}return{target:undefined,point:undefined,local:mayConsumeLocalTick}};Scene.prototype.prefetch=function(){if(this._loaded){return}if(this._prefetchRequested)return;this._prefetchRequested=true;this._sceneAssetHolder.request()};Scene.prototype.serializeStorageValues=function(){if(!this._storageLoader)return undefined;return this._storageLoader._valueStoreSerialization};Scene.prototype.requestAssets=function(assetIds,handler){if(this._loadingState<SceneLoadState.ReadyFired){throw g.ExceptionFactory.createAssertionError("Scene#requestAsset(): can be called after loaded.")}var holder=new SceneAssetHolder({scene:this,assetManager:this.game._assetManager,assetIds:assetIds,handler:handler});this._assetHolders.push(holder);holder.request()};Scene.prototype._activate=function(){this.state=SceneState.Active;this.stateChanged.fire(this.state)};Scene.prototype._deactivate=function(){this.state=SceneState.Deactive;this.stateChanged.fire(this.state)};Scene.prototype._needsLoading=function(){return this._sceneAssetHolder.waitingAssetsCount>0||this._storageLoader&&!this._storageLoader._loaded};Scene.prototype._load=function(){if(this._loaded)return;this._loaded=true;var needsWait=this._sceneAssetHolder.request();if(this._storageLoader){this._storageLoader._load(this);needsWait=true}if(!needsWait)this._notifySceneReady()};Scene.prototype._onSceneAssetsLoad=function(){if(!this._loaded){return}if(this._storageLoader&&!this._storageLoader._loaded){return}this._notifySceneReady()};Scene.prototype._onStorageLoadError=function(error){this.game.terminateGame();this.game._abortGame()};Scene.prototype._onStorageLoaded=function(){if(this._sceneAssetHolder.waitingAssetsCount===0)this._notifySceneReady()};Scene.prototype._notifySceneReady=function(){this._loadingState=SceneLoadState.Ready;this.game._fireSceneReady(this)};Scene.prototype._fireReady=function(){this._ready.fire(this);this._loadingState=SceneLoadState.ReadyFired};Scene.prototype._fireLoaded=function(){this.loaded.fire(this);this._loadingState=SceneLoadState.LoadedFired};return Scene}();g.Scene=Scene})(g||(g={}));var g;(function(g){var LoadingScene=function(_super){__extends(LoadingScene,_super);function LoadingScene(param){var _this=this;param.local=true;_this=_super.call(this,param)||this;_this.targetReset=new g.Trigger;_this.targetReady=new g.Trigger;_this.targetAssetLoaded=new g.Trigger;_this._explicitEnd=!!param.explicitEnd;_this._targetScene=undefined;return _this}LoadingScene.prototype.destroy=function(){this._clearTargetScene();_super.prototype.destroy.call(this)};LoadingScene.prototype.reset=function(targetScene){this._clearTargetScene();this._targetScene=targetScene;if(this._loadingState<g.SceneLoadState.LoadedFired){this.loaded.handle(this,this._doReset)}else{this._doReset()}};LoadingScene.prototype.getTargetWaitingAssetsCount=function(){return this._targetScene?this._targetScene._sceneAssetHolder.waitingAssetsCount:0};LoadingScene.prototype.end=function(){if(!this._targetScene||this._targetScene._loadingState<g.SceneLoadState.Ready){var state=this._targetScene?g.SceneLoadState[this._targetScene._loadingState]:"(no scene)";var msg="LoadingScene#end(): the target scene is in invalid state: "+state;throw g.ExceptionFactory.createAssertionError(msg)}this.game.popScene(true);this.game._fireSceneLoaded(this._targetScene);this._clearTargetScene()};LoadingScene.prototype._clearTargetScene=function(){if(!this._targetScene)return;this._targetScene._ready.removeAll(this);this._targetScene.assetLoaded.removeAll(this);this._targetScene=undefined};LoadingScene.prototype._doReset=function(){this.targetReset.fire(this._targetScene);if(this._targetScene._loadingState<g.SceneLoadState.ReadyFired){this._targetScene._ready.handle(this,this._fireTriggerOnTargetReady);this._targetScene.assetLoaded.handle(this,this._fireTriggerOnTargetAssetLoad);this._targetScene._load()}else{this._fireTriggerOnTargetReady(this._targetScene)}return true};LoadingScene.prototype._fireTriggerOnTargetAssetLoad=function(asset){this._onTargetAssetLoad(asset);this.targetAssetLoaded.fire(asset)};LoadingScene.prototype._fireTriggerOnTargetReady=function(scene){this.targetReady.fire(scene);if(!this._explicitEnd){this.end()}};LoadingScene.prototype._onTargetAssetLoad=function(asset){return true};return LoadingScene}(g.Scene);g.LoadingScene=LoadingScene})(g||(g={}));var g;(function(g){var CameraCancellingE=function(_super){__extends(CameraCancellingE,_super);function CameraCancellingE(param){var _this=_super.call(this,param)||this;_this._canceller=new g.Object2D;return _this}CameraCancellingE.prototype.renderSelf=function(renderer,camera){if(!this.children)return false;if(camera){var c=camera;var canceller=this._canceller;if(c.x!==canceller.x||c.y!==canceller.y||c.angle!==canceller.angle||c.scaleX!==canceller.scaleX||c.scaleY!==canceller.scaleY){canceller.x=c.x;canceller.y=c.y;canceller.angle=c.angle;canceller.scaleX=c.scaleX;canceller.scaleY=c.scaleY;if(canceller._matrix){canceller._matrix._modified=true}}renderer.save();renderer.transform(canceller.getMatrix()._matrix)}var children=this.children;for(var i=0;i<children.length;++i)children[i].render(renderer,camera);if(camera){renderer.restore()}return false};return CameraCancellingE}(g.E);var DefaultLoadingScene=function(_super){__extends(DefaultLoadingScene,_super);function DefaultLoadingScene(param){var _this=_super.call(this,{game:param.game,name:"akashic:default-loading-scene"})||this;_this._barWidth=Math.min(param.game.width,Math.max(100,param.game.width/2));_this._barHeight=5;_this._gauge=undefined;_this._gaugeUpdateCount=0;_this._totalWaitingAssetCount=0;_this.loaded.handle(_this,_this._onLoaded);_this.targetReset.handle(_this,_this._onTargetReset);_this.targetAssetLoaded.handle(_this,_this._onTargetAssetLoaded);return _this}DefaultLoadingScene.prototype._onLoaded=function(){var gauge;this.append(new CameraCancellingE({scene:this,children:[new g.FilledRect({scene:this,width:this.game.width,height:this.game.height,cssColor:"rgba(0, 0, 0, 0.8)",children:[new g.FilledRect({scene:this,x:(this.game.width-this._barWidth)/2,y:(this.game.height-this._barHeight)/2,width:this._barWidth,height:this._barHeight,cssColor:"gray",children:[gauge=new g.FilledRect({scene:this,width:0,height:this._barHeight,cssColor:"white"})]})]})]}));gauge.update.handle(this,this._onUpdateGuage);this._gauge=gauge;return true};DefaultLoadingScene.prototype._onUpdateGuage=function(){var BLINK_RANGE=50;var BLINK_PER_SEC=2/3;++this._gaugeUpdateCount;var c=Math.round(255-BLINK_RANGE+Math.sin(this._gaugeUpdateCount/this.game.fps*BLINK_PER_SEC*(2*Math.PI))*BLINK_RANGE);this._gauge.cssColor="rgb("+c+","+c+","+c+")";this._gauge.modified()};DefaultLoadingScene.prototype._onTargetReset=function(targetScene){if(this._gauge){this._gauge.width=0;this._gauge.modified()}this._totalWaitingAssetCount=targetScene._sceneAssetHolder.waitingAssetsCount};DefaultLoadingScene.prototype._onTargetAssetLoaded=function(asset){var waitingAssetsCount=this._targetScene._sceneAssetHolder.waitingAssetsCount;this._gauge.width=Math.ceil((1-waitingAssetsCount/this._totalWaitingAssetCount)*this._barWidth);this._gauge.modified()};return DefaultLoadingScene}(g.LoadingScene);g.DefaultLoadingScene=DefaultLoadingScene})(g||(g={}));var g;(function(g){var Sprite=function(_super){__extends(Sprite,_super);function Sprite(sceneOrParam,src,width,height){var _this=this;if(sceneOrParam instanceof g.Scene){var scene=sceneOrParam;_this=_super.call(this,scene)||this;_this.surface=g.Util.asSurface(src);_this.width=width!==undefined?width:_this.surface.width;_this.height=height!==undefined?height:_this.surface.height;_this.srcWidth=_this.width;_this.srcHeight=_this.height;_this.srcX=0;_this.srcY=0;_this._stretchMatrix=undefined;_this._beforeSurface=_this.surface;g.Util.setupAnimatingHandler(_this,_this.surface)}else{var param=sceneOrParam;_this=_super.call(this,param)||this;_this.surface=g.Util.asSurface(param.src);if(!("width"in param))_this.width=_this.surface.width;if(!("height"in param))_this.height=_this.surface.height;_this.srcWidth="srcWidth"in param?param.srcWidth:_this.width;_this.srcHeight="srcHeight"in param?param.srcHeight:_this.height;_this.srcX=param.srcX||0;_this.srcY=param.srcY||0;_this._stretchMatrix=undefined;_this._beforeSurface=_this.surface;g.Util.setupAnimatingHandler(_this,_this.surface);_this._invalidateSelf()}return _this}Sprite.prototype._onUpdate=function(){this.modified()};Sprite.prototype._onAnimatingStarted=function(){if(!this.update.isHandled(this,this._onUpdate)){this.update.handle(this,this._onUpdate)}};Sprite.prototype._onAnimatingStopped=function(){if(!this.destroyed()){this.update.remove(this,this._onUpdate)}};Sprite.prototype.renderSelf=function(renderer,camera){if(this.srcWidth<=0||this.srcHeight<=0){return true}if(this._stretchMatrix){renderer.save();renderer.transform(this._stretchMatrix._matrix)}renderer.drawImage(this.surface,this.srcX,this.srcY,this.srcWidth,this.srcHeight,0,0);if(this._stretchMatrix)renderer.restore();return true};Sprite.prototype.invalidate=function(){this._invalidateSelf();this.modified()};Sprite.prototype.destroy=function(destroySurface){if(this.surface&&!this.surface.destroyed()){if(destroySurface){this.surface.destroy()}else if(this.surface.isDynamic){this.surface.animatingStarted.remove(this,this._onAnimatingStarted);this.surface.animatingStopped.remove(this,this._onAnimatingStopped)}}this.surface=undefined;_super.prototype.destroy.call(this)};Sprite.prototype._invalidateSelf=function(){if(this.width===this.srcWidth&&this.height===this.srcHeight){this._stretchMatrix=undefined}else{this._stretchMatrix=g.Util.createMatrix();this._stretchMatrix.scale(this.width/this.srcWidth,this.height/this.srcHeight)}if(this.surface!==this._beforeSurface){g.Util.migrateAnimatingHandler(this,this._beforeSurface,this.surface);this._beforeSurface=this.surface}};return Sprite}(g.E);g.Sprite=Sprite})(g||(g={}));var g;(function(g){var FrameSprite=function(_super){__extends(FrameSprite,_super);function FrameSprite(sceneOrParam,src,width,height){var _this=this;if(sceneOrParam instanceof g.Scene){var scene=sceneOrParam;_this=_super.call(this,scene,src,width,height)||this;_this._lastUsedIndex=0;_this.frameNumber=0;_this.frames=[0];_this.interval=undefined;_this._timer=undefined}else{var param=sceneOrParam;_this=_super.call(this,param)||this;_this._lastUsedIndex=0;_this.frameNumber=param.frameNumber||0;_this.frames="frames"in param?param.frames:[0];_this.interval=param.interval;_this._timer=undefined;_this._modifiedSelf()}return _this}FrameSprite.createBySprite=function(sprite,width,height){var frameSprite=new FrameSprite({scene:sprite.scene,src:sprite.surface,width:width===undefined?sprite.width:width,height:height===undefined?sprite.height:height});frameSprite.srcHeight=height===undefined?sprite.srcHeight:height;frameSprite.srcWidth=width===undefined?sprite.srcWidth:width;return frameSprite};FrameSprite.prototype.start=function(){if(this.interval===undefined)this.interval=1e3/this.game().fps;if(this._timer)this._free();this._timer=this.scene.createTimer(this.interval);this._timer.elapsed.handle(this,this._onElapsed)};FrameSprite.prototype.destroy=function(destroySurface){this.stop();_super.prototype.destroy.call(this,destroySurface)};FrameSprite.prototype.stop=function(){if(this._timer)this._free()};FrameSprite.prototype.modified=function(isBubbling){this._modifiedSelf(isBubbling);_super.prototype.modified.call(this,isBubbling)};FrameSprite.prototype._onElapsed=function(){if(++this.frameNumber>=this.frames.length)this.frameNumber=0;this.modified()};FrameSprite.prototype._free=function(){if(!this._timer)return;this._timer.elapsed.remove(this,this._onElapsed);if(this._timer.canDelete())this.scene.deleteTimer(this._timer);this._timer=undefined};FrameSprite.prototype._changeFrame=function(){var frame=this.frames[this.frameNumber];var sep=Math.floor(this.surface.width/this.srcWidth);this.srcX=frame%sep*this.srcWidth;this.srcY=Math.floor(frame/sep)*this.srcHeight;this._lastUsedIndex=frame};FrameSprite.prototype._modifiedSelf=function(isBubbling){if(this._lastUsedIndex!==this.frames[this.frameNumber])this._changeFrame()};return FrameSprite}(g.Sprite);g.FrameSprite=FrameSprite})(g||(g={}));var g;(function(g){var Tile=function(_super){__extends(Tile,_super);function Tile(sceneOrParam,src,tileWidth,tileHeight,tileData){var _this=this;if(sceneOrParam instanceof g.Scene){var scene=sceneOrParam;_this=_super.call(this,scene)||this;_this.tileWidth=tileWidth;_this.tileHeight=tileHeight;_this.tileData=tileData;_this.tileChips=g.Util.asSurface(src);_this.height=_this.tileHeight*_this.tileData.length;_this.width=_this.tileWidth*_this.tileData[0].length;_this._tilesInRow=Math.floor(_this.tileChips.width/_this.tileWidth)}else{var param=sceneOrParam;_this=_super.call(this,param)||this;_this.tileWidth=param.tileWidth;_this.tileHeight=param.tileHeight;_this.tileData=param.tileData;_this.tileChips=g.Util.asSurface(param.src);_this.height=_this.tileHeight*_this.tileData.length;_this.width=_this.tileWidth*_this.tileData[0].length}_this._beforeTileChips=_this.tileChips;g.Util.setupAnimatingHandler(_this,_this.tileChips);_this._invalidateSelf();return _this}Tile.prototype._onUpdate=function(){this.invalidate()};Tile.prototype._onAnimatingStarted=function(){if(!this.update.isHandled(this,this._onUpdate)){this.update.handle(this,this._onUpdate)}};Tile.prototype._onAnimatingStopped=function(){if(!this.destroyed()){this.update.remove(this,this._onUpdate)}};Tile.prototype.renderCache=function(renderer){if(!this.tileData)throw g.ExceptionFactory.createAssertionError("Tile#_renderCache: don't have a tile data");if(this.tileWidth<=0||this.tileHeight<=0){return}for(var y=0;y<this.tileData.length;++y){var row=this.tileData[y];for(var x=0;x<row.length;++x){var tile=row[x];if(tile<0){continue}var tileX=this.tileWidth*(tile%this._tilesInRow);var tileY=this.tileHeight*Math.floor(tile/this._tilesInRow);var dx=this.tileWidth*x;var dy=this.tileHeight*y;renderer.drawImage(this.tileChips,tileX,tileY,this.tileWidth,this.tileHeight,dx,dy)}}};Tile.prototype.invalidate=function(){this._invalidateSelf();_super.prototype.invalidate.call(this)};Tile.prototype.destroy=function(destroySurface){if(destroySurface&&this.tileChips&&!this.tileChips.destroyed()){this.tileChips.destroy()}this.tileChips=undefined;_super.prototype.destroy.call(this)};Tile.prototype._invalidateSelf=function(){this._tilesInRow=Math.floor(this.tileChips.width/this.tileWidth);if(this.tileChips!==this._beforeTileChips){g.Util.migrateAnimatingHandler(this,this._beforeTileChips,this.tileChips);this._beforeTileChips=this.tileChips}};return Tile}(g.CacheableE);g.Tile=Tile})(g||(g={}));var g;(function(g){var EventType;(function(EventType){EventType[EventType["Unknown"]=0]="Unknown";EventType[EventType["Join"]=1]="Join";EventType[EventType["Leave"]=2]="Leave";EventType[EventType["Timestamp"]=3]="Timestamp";EventType[EventType["Seed"]=4]="Seed";EventType[EventType["PointDown"]=5]="PointDown";EventType[EventType["PointMove"]=6]="PointMove";EventType[EventType["PointUp"]=7]="PointUp";EventType[EventType["Message"]=8]="Message";EventType[EventType["Operation"]=9]="Operation"})(EventType=g.EventType||(g.EventType={}));var PointEvent=function(){function PointEvent(pointerId,target,point,player,local,priority){this.priority=priority;this.local=local;this.player=player;this.pointerId=pointerId;this.target=target;this.point=point}return PointEvent}();g.PointEvent=PointEvent;var PointDownEvent=function(_super){__extends(PointDownEvent,_super);function PointDownEvent(pointerId,target,point,player,local,priority){var _this=_super.call(this,pointerId,target,point,player,local,priority)||this;_this.type=EventType.PointDown;return _this}return PointDownEvent}(PointEvent);g.PointDownEvent=PointDownEvent;var PointUpEvent=function(_super){__extends(PointUpEvent,_super);function PointUpEvent(pointerId,target,point,prevDelta,startDelta,player,local,priority){var _this=_super.call(this,pointerId,target,point,player,local,priority)||this;_this.type=EventType.PointUp;_this.prevDelta=prevDelta;_this.startDelta=startDelta;return _this}return PointUpEvent}(PointEvent);g.PointUpEvent=PointUpEvent;var PointMoveEvent=function(_super){__extends(PointMoveEvent,_super);function PointMoveEvent(pointerId,target,point,prevDelta,startDelta,player,local,priority){var _this=_super.call(this,pointerId,target,point,player,local,priority)||this;_this.type=EventType.PointMove;_this.prevDelta=prevDelta;_this.startDelta=startDelta;return _this}return PointMoveEvent}(PointEvent);g.PointMoveEvent=PointMoveEvent;var MessageEvent=function(){function MessageEvent(data,player,local,priority){this.type=EventType.Message;this.priority=priority;this.local=local;this.player=player;this.data=data}return MessageEvent}();g.MessageEvent=MessageEvent;var OperationEvent=function(){function OperationEvent(code,data,player,local,priority){this.type=EventType.Operation;this.priority=priority;this.local=local;this.player=player;this.code=code;this.data=data}return OperationEvent}();g.OperationEvent=OperationEvent;var JoinEvent=function(){function JoinEvent(player,storageValues,priority){this.type=EventType.Join;this.priority=priority;this.player=player;this.storageValues=storageValues}return JoinEvent}();g.JoinEvent=JoinEvent;var LeaveEvent=function(){function LeaveEvent(player,priority){this.type=EventType.Leave;this.priority=priority;this.player=player}return LeaveEvent}();g.LeaveEvent=LeaveEvent;var TimestampEvent=function(){function TimestampEvent(timestamp,player,priority){this.type=EventType.Timestamp;this.priority=priority;this.player=player;this.timestamp=timestamp}return TimestampEvent}();g.TimestampEvent=TimestampEvent;var SeedEvent=function(){function SeedEvent(generator,priority){this.type=EventType.Seed;this.priority=priority;this.generator=generator}return SeedEvent}();g.SeedEvent=SeedEvent})(g||(g={}));var g;(function(g){var LogLevel;(function(LogLevel){LogLevel[LogLevel["Error"]=0]="Error";LogLevel[LogLevel["Warn"]=1]="Warn";LogLevel[LogLevel["Info"]=2]="Info";LogLevel[LogLevel["Debug"]=3]="Debug"})(LogLevel=g.LogLevel||(g.LogLevel={}));var Logger=function(){function Logger(game){this.game=game;this.logging=new g.Trigger}Logger.prototype.destroy=function(){this.game=undefined;this.logging.destroy();this.logging=undefined};Logger.prototype.destroyed=function(){return!this.game};Logger.prototype.error=function(message,cause){this.logging.fire({game:this.game,level:LogLevel.Error,message:message,cause:cause})};Logger.prototype.warn=function(message,cause){this.logging.fire({game:this.game,level:LogLevel.Warn,message:message,cause:cause})};Logger.prototype.info=function(message,cause){this.logging.fire({game:this.game,level:LogLevel.Info,message:message,cause:cause})};Logger.prototype.debug=function(message,cause){this.logging.fire({game:this.game,level:LogLevel.Debug,message:message,cause:cause})};return Logger}();g.Logger=Logger})(g||(g={}));var g;(function(g){var Game=function(){function Game(gameConfiguration,resourceFactory,assetBase,selfId,operationPluginViewInfo){gameConfiguration=this._normalizeConfiguration(gameConfiguration);this.fps=gameConfiguration.fps;this.width=gameConfiguration.width;this.height=gameConfiguration.height;this.renderers=[];this.scenes=[];this.random=[];this.age=0;this.assetBase=assetBase||"";this.resourceFactory=resourceFactory;this.selfId=selfId||undefined;this.playId=undefined;this._audioSystemManager=new g.AudioSystemManager(this);this.audio={music:new g.MusicAudioSystem("music",this),sound:new g.SoundAudioSystem("sound",this)};this.defaultAudioSystemId="sound";this.storage=new g.Storage(this);this.assets={};this.join=new g.Trigger;this.leave=new g.Trigger;this.seed=new g.Trigger;this._eventTriggerMap={};this._eventTriggerMap[g.EventType.Join]=this.join;this._eventTriggerMap[g.EventType.Leave]=this.leave;this._eventTriggerMap[g.EventType.Seed]=this.seed;this._eventTriggerMap[g.EventType.Message]=undefined;this._eventTriggerMap[g.EventType.PointDown]=undefined;this._eventTriggerMap[g.EventType.PointMove]=undefined;this._eventTriggerMap[g.EventType.PointUp]=undefined;this._eventTriggerMap[g.EventType.Operation]=undefined;this.resized=new g.Trigger;this._loaded=new g.Trigger;this._started=new g.Trigger;this.isLoaded=false;this.snapshotRequest=new g.Trigger;this.external={};this.logger=new g.Logger(this);this._main=gameConfiguration.main;this._mainParameter=undefined;this._configuration=gameConfiguration;this._assetManager=new g.AssetManager(this,gameConfiguration.assets,gameConfiguration.audio,gameConfiguration.moduleMainScripts);var operationPluginsField=gameConfiguration.operationPlugins||[];this._operationPluginManager=new g.OperationPluginManager(this,operationPluginViewInfo,operationPluginsField);this._operationPluginOperated=new g.Trigger;this._operationPluginManager.operated.handle(this._operationPluginOperated,this._operationPluginOperated.fire);this._sceneChanged=new g.Trigger;this._sceneChanged.handle(this,this._updateEventTriggers);this._initialScene=new g.Scene({game:this,assetIds:this._assetManager.globalAssetIds(),local:true,name:"akashic:initial-scene"});this._initialScene.loaded.handle(this,this._onInitialSceneLoaded);this._reset({age:0})}Object.defineProperty(Game.prototype,"focusingCamera",{get:function(){return this._focusingCamera},set:function(c){if(c===this._focusingCamera)return;if(this.modified)this.render(this._focusingCamera);this._focusingCamera=c},enumerable:true,configurable:true});Game.prototype.pushScene=function(scene){this._sceneChangeRequests.push({type:0,scene:scene})};Game.prototype.replaceScene=function(scene,preserveCurrent){this._sceneChangeRequests.push({type:1,scene:scene,preserveCurrent:preserveCurrent})};Game.prototype.popScene=function(preserveCurrent){this._sceneChangeRequests.push({type:2,preserveCurrent:preserveCurrent})};Game.prototype.scene=function(){if(!this.scenes.length)return undefined;return this.scenes[this.scenes.length-1]};Game.prototype.tick=function(advanceAge){var scene=undefined;if(this._isTerminated)return false;if(this.scenes.length){scene=this.scenes[this.scenes.length-1];if(this.events.length){var events=this.events;this.events=[];for(var i=0;i<events.length;++i){var trigger=this._eventTriggerMap[events[i].type];if(trigger)trigger.fire(events[i])}}scene.update.fire();if(advanceAge===true||advanceAge===undefined&&scene.local!==g.LocalTickMode.FullLocal){++this.age}}if(this._sceneChangeRequests.length){this._flushSceneChangeRequests();return scene!==this.scenes[this.scenes.length-1]}return false};Game.prototype.render=function(camera){if(!camera)camera=this.focusingCamera;var renderers=this.renderers;for(var i=0;i<renderers.length;++i)renderers[i].draw(this,camera);this.modified=false};Game.prototype.findPointSource=function(point,camera){if(!camera)camera=this.focusingCamera;return this.scene().findPointSourceByPoint(point,false,camera)};Game.prototype.register=function(e){if(e.local){if(e.id===undefined){e.id=--this._localIdx}else{if(e.id>0)throw g.ExceptionFactory.createAssertionError("Game#register: invalid local id: "+e.id);if(this._localDb.hasOwnProperty(String(e.id)))throw g.ExceptionFactory.createAssertionError("Game#register: conflicted id: "+e.id);if(this._localIdx>e.id)this._localIdx=e.id}this._localDb[e.id]=e}else{if(e.id===undefined){e.id=++this._idx}else{if(e.id<0)throw g.ExceptionFactory.createAssertionError("Game#register: invalid non-local id: "+e.id);if(this.db.hasOwnProperty(String(e.id)))throw g.ExceptionFactory.createAssertionError("Game#register: conflicted id: "+e.id);if(this._idx<e.id)this._idx=e.id}this.db[e.id]=e}};Game.prototype.unregister=function(e){if(e.local){delete this._localDb[e.id]}else{delete this.db[e.id]}};Game.prototype.leaveGame=function(){this._leaveGame()};Game.prototype.terminateGame=function(){this._leaveGame();this._isTerminated=true};Game.prototype.raiseEvent=function(e){throw g.ExceptionFactory.createPureVirtualError("Game#raiseEvent")};Game.prototype.raiseTick=function(events){throw g.ExceptionFactory.createPureVirtualError("Game#raiseTick")};Game.prototype.addEventFilter=function(filter,handleEmpty){throw g.ExceptionFactory.createPureVirtualError("Game#addEventFilter")};Game.prototype.removeEventFilter=function(filter){throw g.ExceptionFactory.createPureVirtualError("Game#removeEventFilter")};Game.prototype.shouldSaveSnapshot=function(){throw g.ExceptionFactory.createPureVirtualError("Game#shouldSaveSnapshot")};Game.prototype.saveSnapshot=function(snapshot,timestamp){throw g.ExceptionFactory.createPureVirtualError("Game#saveSnapshot")};Game.prototype._fireSceneReady=function(scene){this._sceneChangeRequests.push({type:3,scene:scene})};Game.prototype._fireSceneLoaded=function(scene){if(scene._loadingState<g.SceneLoadState.LoadedFired){this._sceneChangeRequests.push({type:4,scene:scene})}};Game.prototype._callSceneAssetHolderHandler=function(assetHolder){this._sceneChangeRequests.push({type:5,assetHolder:assetHolder})};Game.prototype._normalizeConfiguration=function(gameConfiguration){if(!gameConfiguration)throw g.ExceptionFactory.createAssertionError("Game#_normalizeConfiguration: invalid arguments");if(!("assets"in gameConfiguration))gameConfiguration.assets={};if(!("fps"in gameConfiguration))gameConfiguration.fps=30;if(typeof gameConfiguration.fps!=="number")throw g.ExceptionFactory.createAssertionError("Game#_normalizeConfiguration: fps must be given as a number");if(!(0<=gameConfiguration.fps&&gameConfiguration.fps<=60))throw g.ExceptionFactory.createAssertionError("Game#_normalizeConfiguration: fps must be a number in (0, 60].");if(typeof gameConfiguration.width!=="number")throw g.ExceptionFactory.createAssertionError("Game#_normalizeConfiguration: width must be given as a number");if(typeof gameConfiguration.height!=="number")throw g.ExceptionFactory.createAssertionError("Game#_normalizeConfiguration: height must be given as a number");return gameConfiguration};Game.prototype._setAudioPlaybackRate=function(playbackRate){this._audioSystemManager._setPlaybackRate(playbackRate)};Game.prototype._setMuted=function(muted){this._audioSystemManager._setMuted(muted)};Game.prototype._decodeOperationPluginOperation=function(code,op){var plugins=this._operationPluginManager.plugins;if(!plugins[code]||!plugins[code].decode)return op;return plugins[code].decode(op)};Game.prototype._reset=function(param){this._operationPluginManager.stopAll();if(this.scene()){while(this.scene()!==this._initialScene){this.popScene();this._flushSceneChangeRequests()}if(!this.isLoaded){this.scenes.pop()}}if(param){if(param.age!==undefined)this.age=param.age;if(param.randGen!==undefined)this.random[0]=param.randGen}this._audioSystemManager._reset();this._loaded.removeAllByHandler(this._start);this.join._reset();this.leave._reset();this.seed._reset();this.resized._reset();this._idx=0;this._localIdx=0;this._cameraIdx=0;this.db={};this._localDb={};this.events=[];this.modified=true;this.loadingScene=undefined;this._focusingCamera=undefined;this._scriptCaches={};this.snapshotRequest._reset();this._sceneChangeRequests=[];this._isTerminated=false;this.vars={};switch(this._configuration.defaultLoadingScene){case"none":this._defaultLoadingScene=new g.LoadingScene({game:this});break;default:this._defaultLoadingScene=new g.DefaultLoadingScene({game:this});break}};Game.prototype._destroy=function(){this._operationPluginManager.destroy();if(this.scene()){while(this.scene()!==this._initialScene){this.popScene();this._flushSceneChangeRequests()}}this._initialScene.destroy();if(this.loadingScene&&!this.loadingScene.destroyed()){this.loadingScene.destroy()}if(!this._defaultLoadingScene.destroyed()){this._defaultLoadingScene.destroy()}this.db=undefined;this.renderers=undefined;this.scenes=undefined;this.random=undefined;this.events=undefined;this.join.destroy();this.join=undefined;this.leave.destroy();this.leave=undefined;this.seed.destroy();this.seed=undefined;this.modified=false;this.age=0;this.assets=undefined;this.isLoaded=false;this.loadingScene=undefined;this.assetBase="";this.selfId=undefined;var audioSystemIds=Object.keys(this.audio);for(var i=0;i<audioSystemIds.length;++i)this.audio[audioSystemIds[i]].stopAll();this.audio=undefined;this.defaultAudioSystemId=undefined;this.logger.destroy();this.logger=undefined;this.snapshotRequest.destroy();this.snapshotRequest=undefined;this.resourceFactory=undefined;this.storage=undefined;this.playId=undefined;this.operationPlugins=undefined;this.resized.destroy();this.resized=undefined;this._eventTriggerMap=undefined;this._initialScene=undefined;this._defaultLoadingScene=undefined;this._sceneChanged.destroy();this._sceneChanged=undefined;this._scriptCaches=undefined;this._loaded.destroy();this._loaded=undefined;this._started.destroy();this._started=undefined;this._main=undefined;this._mainParameter=undefined;this._assetManager.destroy();this._assetManager=undefined;this._audioSystemManager._game=undefined;this._audioSystemManager=undefined;this._operationPluginManager=undefined;this._operationPluginOperated.destroy();this._operationPluginOperated=undefined;this._idx=0;this._localDb={};this._localIdx=0;this._cameraIdx=0;this._isTerminated=true;this._focusingCamera=undefined;this._configuration=undefined;this._sceneChangeRequests=[]};Game.prototype._loadAndStart=function(param){this._mainParameter=param||{};if(!this.isLoaded){this._loaded.handle(this,this._start);this.pushScene(this._initialScene);this._flushSceneChangeRequests()}else{this._start()}};Game.prototype._startLoadingGlobalAssets=function(){if(this.isLoaded)throw g.ExceptionFactory.createAssertionError("Game#_startLoadingGlobalAssets: already loaded.");this.pushScene(this._initialScene);this._flushSceneChangeRequests()};Game.prototype._updateEventTriggers=function(scene){this.modified=true;if(!scene){this._eventTriggerMap[g.EventType.Message]=undefined;this._eventTriggerMap[g.EventType.PointDown]=undefined;this._eventTriggerMap[g.EventType.PointMove]=undefined;this._eventTriggerMap[g.EventType.PointUp]=undefined;this._eventTriggerMap[g.EventType.Operation]=undefined;return}this._eventTriggerMap[g.EventType.Message]=scene.message;this._eventTriggerMap[g.EventType.PointDown]=scene.pointDownCapture;this._eventTriggerMap[g.EventType.PointMove]=scene.pointMoveCapture;this._eventTriggerMap[g.EventType.PointUp]=scene.pointUpCapture;this._eventTriggerMap[g.EventType.Operation]=scene.operation;scene._activate()};Game.prototype._onInitialSceneLoaded=function(){this._initialScene.loaded.remove(this,this._onInitialSceneLoaded);this.assets=this._initialScene.assets;this.isLoaded=true;this._loaded.fire()};Game.prototype._leaveGame=function(){throw g.ExceptionFactory.createPureVirtualError("Game#_leaveGame")};Game.prototype._abortGame=function(){};Game.prototype._flushSceneChangeRequests=function(){do{var reqs=this._sceneChangeRequests;this._sceneChangeRequests=[];for(var i=0;i<reqs.length;++i){var req=reqs[i];switch(req.type){case 0:var oldScene=this.scene();if(oldScene){oldScene._deactivate()}this._doPushScene(req.scene);break;case 1:this._doPopScene(req.preserveCurrent,false);this._doPushScene(req.scene);break;case 2:this._doPopScene(req.preserveCurrent,true);break;case 3:req.scene._fireReady();break;case 4:req.scene._fireLoaded();break;case 5:req.assetHolder.callHandler();break;default:throw g.ExceptionFactory.createAssertionError("Game#_flushSceneChangeRequests: unknown scene change request.")}}}while(this._sceneChangeRequests.length>0)};Game.prototype._doPopScene=function(preserveCurrent,fireSceneChanged){var scene=this.scenes.pop();if(scene===this._initialScene)throw g.ExceptionFactory.createAssertionError("Game#_doPopScene: invalid call; attempting to pop the initial scene");if(!preserveCurrent)scene.destroy();if(fireSceneChanged)this._sceneChanged.fire(this.scene())};Game.prototype._start=function(){this._operationPluginManager.initialize();this.operationPlugins=this._operationPluginManager.plugins;if(!this._main){if(!this._mainParameter.snapshot){if(!this.assets.mainScene)throw g.ExceptionFactory.createAssertionError("Game#_start: global asset 'mainScene' not found.");var mainScene=g._require(this,"mainScene")();this.pushScene(mainScene);this._flushSceneChangeRequests()}else{if(!this.assets.snapshotLoader)throw g.ExceptionFactory.createAssertionError("Game#_start: global asset 'snapshotLoader' not found.");var loader=g._require(this,"snapshotLoader");loader(this._mainParameter.snapshot);this._flushSceneChangeRequests()}this._started.fire();return}var mainFun=g._require(this,this._main);if(!mainFun||typeof mainFun!=="function")throw g.ExceptionFactory.createAssertionError("Game#_start: Entry point '"+this._main+"' not found.");mainFun(this._mainParameter);this._flushSceneChangeRequests();this._started.fire()};Game.prototype._doPushScene=function(scene,loadingScene){if(!loadingScene)loadingScene=this.loadingScene||this._defaultLoadingScene;this.scenes.push(scene);if(scene._needsLoading()&&scene._loadingState<g.SceneLoadState.LoadedFired){if(this._defaultLoadingScene._needsLoading())throw g.ExceptionFactory.createAssertionError("Game#_doPushScene: _defaultLoadingScene must not depend on any assets/storages.");this._doPushScene(loadingScene,this._defaultLoadingScene);loadingScene.reset(scene)}else{this._sceneChanged.fire(scene);if(!scene._loaded){scene._load();this._fireSceneLoaded(scene)}}this.modified=true};return Game}();g.Game=Game})(g||(g={}));var g;(function(g){var Camera2D=function(_super){__extends(Camera2D,_super);function Camera2D(gameOrParam){var _this=this;if(gameOrParam instanceof g.Game){var game=gameOrParam;_this=_super.call(this)||this;_this.game=game;_this.local=false;_this.name=undefined;_this._modifiedCount=0;_this.width=game.width;_this.height=game.height;game.logger.debug("[deprecated] Camera2D:This constructor is deprecated. "+"Refer to the API documentation and use Camera2D(param: Camera2DParameterObject) instead.")}else{var param=gameOrParam;_this=_super.call(this,param)||this;_this.game=param.game;_this.local=!!param.local;_this.name=param.name;_this._modifiedCount=0;_this.width=param.game.width;_this.height=param.game.height}_this.id=_this.local?undefined:_this.game._cameraIdx++;return _this}Camera2D.deserialize=function(ser,game){var s=ser;s.param.game=game;var ret=new Camera2D(s.param);ret.id=s.id;return ret};Camera2D.prototype.modified=function(){this._modifiedCount=(this._modifiedCount+1)%32768;if(this._matrix)this._matrix._modified=true;this.game.modified=true};Camera2D.prototype.serialize=function(){var ser={id:this.id,param:{game:undefined,local:this.local,name:this.name,x:this.x,y:this.y,width:this.width,height:this.height,opacity:this.opacity,scaleX:this.scaleX,scaleY:this.scaleY,angle:this.angle,compositeOperation:this.compositeOperation}};return ser};Camera2D.prototype._applyTransformToRenderer=function(renderer){if(this.angle||this.scaleX!==1||this.scaleY!==1){renderer.transform(this.getMatrix()._matrix)}else{renderer.translate(-this.x,-this.y)}if(this.opacity!==1)renderer.opacity(this.opacity)};Camera2D.prototype._updateMatrix=function(){if(this.angle||this.scaleX!==1||this.scaleY!==1){this._matrix.updateByInverse(this.width,this.height,this.scaleX,this.scaleY,this.angle,this.x,this.y)}else{this._matrix.reset(-this.x,-this.y)}};return Camera2D}(g.Object2D);g.Camera2D=Camera2D})(g||(g={}));var g;(function(g){var Renderer=function(){function Renderer(){}Renderer.prototype.draw=function(game,camera){var scene=game.scene();if(!scene)return;this.begin();this.save();this.clear();if(camera){this.save();camera._applyTransformToRenderer(this)}var children=scene.children;for(var i=0;i<children.length;++i)children[i].render(this,camera);if(camera){this.restore()}this.restore();this.end()};Renderer.prototype.begin=function(){};Renderer.prototype.clear=function(){throw g.ExceptionFactory.createPureVirtualError("Renderer#clear")};Renderer.prototype.drawImage=function(surface,offsetX,offsetY,width,height,destOffsetX,destOffsetY){throw g.ExceptionFactory.createPureVirtualError("Renderer#drawImage")};Renderer.prototype.drawSprites=function(surface,offsetX,offsetY,width,height,canvasOffsetX,canvasOffsetY,count){throw g.ExceptionFactory.createPureVirtualError("Renderer#drawSprites")};Renderer.prototype.drawSystemText=function(text,x,y,maxWidth,fontSize,textAlign,textBaseline,textColor,fontFamily,strokeWidth,strokeColor,strokeOnly){throw g.ExceptionFactory.createPureVirtualError("Renderer#drawSystemText")};Renderer.prototype.translate=function(x,y){throw g.ExceptionFactory.createPureVirtualError("Renderer#translate")};Renderer.prototype.transform=function(matrix){throw g.ExceptionFactory.createPureVirtualError("Renderer#transform")};Renderer.prototype.opacity=function(opacity){throw g.ExceptionFactory.createPureVirtualError("Renderer#opacity")};Renderer.prototype.save=function(){throw g.ExceptionFactory.createPureVirtualError("Renderer#save")};Renderer.prototype.restore=function(){throw g.ExceptionFactory.createPureVirtualError("Renderer#restore")};Renderer.prototype.fillRect=function(x,y,width,height,cssColor){throw g.ExceptionFactory.createPureVirtualError("Renderer#fillRect")};Renderer.prototype.setCompositeOperation=function(operation){throw g.ExceptionFactory.createPureVirtualError("Renderer#setCompositeOperation")};Renderer.prototype.setTransform=function(matrix){throw g.ExceptionFactory.createPureVirtualError("Renderer#setTransform")};Renderer.prototype.setOpacity=function(opacity){throw g.ExceptionFactory.createPureVirtualError("Renderer#setOpacity")};Renderer.prototype.end=function(){};return Renderer}();g.Renderer=Renderer})(g||(g={}));var g;(function(g){var Surface=function(){function Surface(width,height,drawable,isDynamic){if(isDynamic===void 0){isDynamic=false}if(width%1!==0||height%1!==0){throw g.ExceptionFactory.createAssertionError("Surface#constructor: width and height must be integers")}this.width=width;this.height=height;if(drawable)this._drawable=drawable;this.isDynamic=isDynamic;if(this.isDynamic){this.animatingStarted=new g.Trigger;this.animatingStopped=new g.Trigger}else{this.animatingStarted=undefined;this.animatingStopped=undefined}}Surface.prototype.renderer=function(){throw g.ExceptionFactory.createPureVirtualError("Surface#renderer")};Surface.prototype.isPlaying=function(){throw g.ExceptionFactory.createPureVirtualError("Surface#isPlaying()")};Surface.prototype.destroy=function(){if(this.animatingStarted){this.animatingStarted.destroy()}if(this.animatingStopped){this.animatingStopped.destroy()}this._destroyed=true};Surface.prototype.destroyed=function(){return!!this._destroyed};return Surface}();g.Surface=Surface})(g||(g={}));var g;(function(g){var Label=function(_super){__extends(Label,_super);function Label(sceneOrParam,text,font,fontSize){var _this=this;if(sceneOrParam instanceof g.Scene){var scene=sceneOrParam;_this=_super.call(this,scene)||this;_this.text=text;_this.bitmapFont=font;_this.font=font;_this.textAlign=g.TextAlign.Left;_this.glyphs=new Array(text.length);_this.fontSize=fontSize;_this.maxWidth=undefined;_this.widthAutoAdjust=true;_this.textColor=undefined;_this._textWidth=0;_this._game=undefined;_this._overhangLeft=0;_this._overhangRight=0;_this._invalidateSelf()}else{var param=sceneOrParam;if(!param.font&&!param.bitmapFont){throw g.ExceptionFactory.createAssertionError("Label#constructor: 'font' or 'bitmapFont' must be given to LabelParameterObject")}_this=_super.call(this,param)||this;_this.text=param.text;_this.bitmapFont=param.bitmapFont;_this.font=param.font?param.font:param.bitmapFont;_this.textAlign="textAlign"in param?param.textAlign:g.TextAlign.Left;_this.glyphs=new Array(param.text.length);_this.fontSize=param.fontSize;_this.maxWidth=param.maxWidth;_this.widthAutoAdjust="widthAutoAdjust"in param?param.widthAutoAdjust:true;_this.textColor=param.textColor;_this._textWidth=0;_this._game=undefined;_this._overhangLeft=0;_this._overhangRight=0;_this._invalidateSelf()}return _this}Label.prototype.aligning=function(width,textAlign){this.width=width;this.widthAutoAdjust=false;this.textAlign=textAlign};Label.prototype.invalidate=function(){this._invalidateSelf();_super.prototype.invalidate.call(this)};Label.prototype.renderSelfFromCache=function(renderer){var destOffsetX;switch(this.textAlign){case g.TextAlign.Center:destOffsetX=this.widthAutoAdjust?this._overhangLeft:0;break;case g.TextAlign.Right:destOffsetX=this.widthAutoAdjust?this._overhangLeft:this._overhangRight;break;default:destOffsetX=this._overhangLeft;break}renderer.drawImage(this._cache,0,0,this._cacheSize.width+g.CacheableE.PADDING,this._cacheSize.height+g.CacheableE.PADDING,destOffsetX,0)};Label.prototype.renderCache=function(renderer){if(!this.fontSize||this.height<=0||this._textWidth<=0){return}var scale=this.maxWidth>0&&this.maxWidth<this._textWidth?this.maxWidth/this._textWidth:1;var offsetX=0;switch(this.textAlign){case g.TextAlign.Center:offsetX=this.width/2-(this._textWidth+this._overhangLeft)/2*scale;break;case g.TextAlign.Right:offsetX=this.width-(this._textWidth+this._overhangLeft)*scale;break;default:offsetX-=this._overhangLeft*scale;break}renderer.translate(offsetX,0);if(scale!==1){renderer.transform([scale,0,0,1,0,0])}renderer.save();var glyphScale=this.fontSize/this.font.size;for(var i=0;i<this.glyphs.length;++i){var glyph=this.glyphs[i];var glyphWidth=glyph.advanceWidth*glyphScale;if(glyph.surface){renderer.save();renderer.transform([glyphScale,0,0,glyphScale,0,0]);renderer.drawImage(glyph.surface,glyph.x,glyph.y,glyph.width,glyph.height,glyph.offsetX,glyph.offsetY);renderer.restore()}renderer.translate(glyphWidth,0)}renderer.restore();renderer.save();if(this.textColor){renderer.setCompositeOperation(g.CompositeOperation.SourceAtop);renderer.fillRect(0,0,this._textWidth,this.height,this.textColor)}renderer.restore()};Label.prototype.destroy=function(){_super.prototype.destroy.call(this)};Label.prototype._invalidateSelf=function(){if(this.bitmapFont!==undefined){this.font=this.bitmapFont}this.glyphs.length=0;this._textWidth=0;if(!this.fontSize){this.height=0;return}var effectiveTextLastIndex=this.text.length-1;for(var i=this.text.length-1;i>=0;--i){var code=g.Util.charCodeAt(this.text,i);if(!code){continue}var glyph=this.font.glyphForCharacter(code);if(glyph&&glyph.width!==0&&glyph.advanceWidth!==0){effectiveTextLastIndex=i;break}}var maxHeight=0;var glyphScale=this.font.size>0?this.fontSize/this.font.size:0;for(var i=0;i<=effectiveTextLastIndex;++i){var code_1=g.Util.charCodeAt(this.text,i);if(!code_1){continue}var glyph=this.font.glyphForCharacter(code_1);if(!glyph){var str=code_1&4294901760?String.fromCharCode((code_1&4294901760)>>>16,code_1&65535):String.fromCharCode(code_1);this.game().logger.warn("Label#_invalidateSelf(): failed to get a glyph for '"+str+"' "+"(BitmapFont might not have the glyph or DynamicFont might create a glyph larger than its atlas).");continue}if(glyph.width<0||glyph.height<0){continue}if(glyph.x<0||glyph.y<0){continue}this.glyphs.push(glyph);var overhang=0;if(i===0){this._overhangLeft=Math.min(glyph.offsetX,0);overhang=-this._overhangLeft}if(i===effectiveTextLastIndex){this._overhangRight=Math.max(glyph.width+glyph.offsetX-glyph.advanceWidth,0);overhang+=this._overhangRight}this._textWidth+=(glyph.advanceWidth+overhang)*glyphScale;var height=glyph.offsetY+glyph.height;if(maxHeight<height){maxHeight=height}}if(this.widthAutoAdjust){this.width=this._textWidth}this.height=maxHeight*glyphScale};return Label}(g.CacheableE);g.Label=Label})(g||(g={}));var g;(function(g_1){var Glyph=function(){function Glyph(code,x,y,width,height,offsetX,offsetY,advanceWidth,surface,isSurfaceValid){if(offsetX===void 0){offsetX=0}if(offsetY===void 0){offsetY=0}if(advanceWidth===void 0){advanceWidth=width}if(isSurfaceValid===void 0){isSurfaceValid=!!surface}this.code=code;this.x=x;this.y=y;this.width=width;this.height=height;this.offsetX=offsetX;this.offsetY=offsetY;this.advanceWidth=advanceWidth;this.surface=surface;this.isSurfaceValid=isSurfaceValid;this._atlas=null}Glyph.prototype.renderingWidth=function(fontSize){if(!this.width||!this.height){return 0}return fontSize/this.height*this.width};return Glyph}();g_1.Glyph=Glyph;var BitmapFont=function(){function BitmapFont(srcOrParam,map,defaultGlyphWidth,defaultGlyphHeight,missingGlyph){if(srcOrParam instanceof g_1.Surface||srcOrParam instanceof g_1.Asset){this.surface=g_1.Util.asSurface(srcOrParam);this.map=map;this.defaultGlyphWidth=defaultGlyphWidth;this.defaultGlyphHeight=defaultGlyphHeight;this.missingGlyph=missingGlyph;this.size=defaultGlyphHeight}else{var param=srcOrParam;this.surface=g_1.Util.asSurface(param.src);this.map=param.map;this.defaultGlyphWidth=param.defaultGlyphWidth;this.defaultGlyphHeight=param.defaultGlyphHeight;this.missingGlyph=param.missingGlyph;this.size=param.defaultGlyphHeight}}BitmapFont.prototype.glyphForCharacter=function(code){var g=this.map[code]||this.missingGlyph;if(!g){return null}var w=g.width===undefined?this.defaultGlyphWidth:g.width;var h=g.height===undefined?this.defaultGlyphHeight:g.height;var offsetX=g.offsetX||0;var offsetY=g.offsetY||0;var advanceWidth=g.advanceWidth===undefined?w:g.advanceWidth;var surface=w===0||h===0?undefined:this.surface;return new Glyph(code,g.x,g.y,w,h,offsetX,offsetY,advanceWidth,surface,true)};BitmapFont.prototype.destroy=function(){if(this.surface&&!this.surface.destroyed()){this.surface.destroy()}this.map=undefined};BitmapFont.prototype.destroyed=function(){return!this.map};return BitmapFont}();g_1.BitmapFont=BitmapFont})(g||(g={}));var g;(function(g){var FilledRect=function(_super){__extends(FilledRect,_super);function FilledRect(sceneOrParam,cssColor,width,height){var _this=this;if(sceneOrParam instanceof g.Scene){var scene=sceneOrParam;_this=_super.call(this,scene)||this;if(typeof cssColor!=="string")throw g.ExceptionFactory.createTypeMismatchError("ColorBox#constructor(cssColor)","string",cssColor);_this.cssColor=cssColor;_this.width=width;_this.height=height}else{var param=sceneOrParam;_this=_super.call(this,param)||this;if(typeof param.cssColor!=="string")throw g.ExceptionFactory.createTypeMismatchError("ColorBox#constructor(cssColor)","string",cssColor);_this.cssColor=param.cssColor}return _this}FilledRect.prototype.renderSelf=function(renderer){renderer.fillRect(0,0,this.width,this.height,this.cssColor);return true};return FilledRect}(g.E);g.FilledRect=FilledRect})(g||(g={}));var g;(function(g){var Pane=function(_super){__extends(Pane,_super);function Pane(sceneOrParam,width,height,backgroundImage,padding,backgroundEffector){var _this=this;if(sceneOrParam instanceof g.Scene){var scene=sceneOrParam;_this=_super.call(this,scene)||this;_this.width=_this._oldWidth=width;_this.height=_this._oldHeight=height;_this.backgroundImage=g.Util.asSurface(backgroundImage);_this.backgroundEffector=backgroundEffector;_this._shouldRenderChildren=false;_this._padding=padding;_this._initialize();_this._paddingChanged=false;_this._bgSurface=undefined;_this._bgRenderer=undefined}else{var param=sceneOrParam;_this=_super.call(this,param)||this;_this._oldWidth=param.width;_this._oldHeight=param.height;_this.backgroundImage=g.Util.asSurface(param.backgroundImage);_this.backgroundEffector=param.backgroundEffector;_this._shouldRenderChildren=false;_this._padding=param.padding;_this._initialize();_this._paddingChanged=false;_this._bgSurface=undefined;_this._bgRenderer=undefined}return _this}Object.defineProperty(Pane.prototype,"padding",{get:function(){return this._padding},set:function(padding){this._padding=padding;this._paddingChanged=true},enumerable:true,configurable:true});Pane.prototype.modified=function(isBubbling){if(isBubbling)this.state&=~2;_super.prototype.modified.call(this)};Pane.prototype.shouldFindChildrenByPoint=function(point){var p=this._normalizedPadding;if(p.left<point.x&&this.width-p.right>point.x&&p.top<point.y&&this.height-p.bottom>point.y){return true}return false};Pane.prototype.renderCache=function(renderer,camera){if(this.width<=0||this.height<=0){return}this._renderBackground();this._renderChildren(camera);if(this._bgSurface){renderer.drawImage(this._bgSurface,0,0,this.width,this.height,0,0)}else if(this.backgroundImage){renderer.drawImage(this.backgroundImage,0,0,this.width,this.height,0,0)}if(this._childrenArea.width<=0||this._childrenArea.height<=0){return}renderer.save();if(this._childrenArea.x!==0||this._childrenArea.y!==0){renderer.translate(this._childrenArea.x,this._childrenArea.y)}renderer.drawImage(this._childrenSurface,0,0,this._childrenArea.width,this._childrenArea.height,0,0);renderer.restore()};Pane.prototype.destroy=function(destroySurface){if(destroySurface&&this.backgroundImage&&!this.backgroundImage.destroyed()){this.backgroundImage.destroy()}if(this._bgSurface&&!this._bgSurface.destroyed()){this._bgSurface.destroy()}if(this._childrenSurface&&!this._childrenSurface.destroyed()){this._childrenSurface.destroy()}this.backgroundImage=undefined;this._bgSurface=undefined;this._childrenSurface=undefined;_super.prototype.destroy.call(this)};Pane.prototype._renderBackground=function(){if(this._bgSurface&&!this._bgSurface.destroyed()){this._bgSurface.destroy()}if(this.backgroundImage&&this.backgroundEffector){this._bgSurface=this.backgroundEffector.render(this.backgroundImage,this.width,this.height)}else{this._bgSurface=undefined}};Pane.prototype._renderChildren=function(camera){var isNew=this._oldWidth!==this.width||this._oldHeight!==this.height||this._paddingChanged;if(isNew){this._initialize();this._paddingChanged=false;this._oldWidth=this.width;this._oldHeight=this.height}this._childrenRenderer.begin();if(!isNew){this._childrenRenderer.clear()}if(this.children){var children=this.children;for(var i=0;i<children.length;++i){children[i].render(this._childrenRenderer,camera)}}this._childrenRenderer.end()};Pane.prototype._initialize=function(){var p=this._padding===undefined?0:this._padding;var r;if(typeof p==="number"){r={top:p,bottom:p,left:p,right:p}}else{r=this._padding}this._childrenArea={x:r.left,y:r.top,width:this.width-r.left-r.right,height:this.height-r.top-r.bottom};var resourceFactory=this.scene.game.resourceFactory;if(this._childrenSurface&&!this._childrenSurface.destroyed()){this._childrenSurface.destroy()}this._childrenSurface=resourceFactory.createSurface(Math.ceil(this._childrenArea.width),Math.ceil(this._childrenArea.height));this._childrenRenderer=this._childrenSurface.renderer();this._normalizedPadding=r};Pane.prototype._calculateBoundingRect=function(m,c){var matrix=this.getMatrix();if(m){matrix=m.multiplyNew(matrix)}if(!this.visible()||c&&(!this._targetCameras||this._targetCameras.indexOf(c)===-1)){return undefined}var thisBoundingRect={left:0,right:this.width,top:0,bottom:this.height};var targetCoordinates=[{x:thisBoundingRect.left,y:thisBoundingRect.top},{x:thisBoundingRect.left,y:thisBoundingRect.bottom},{x:thisBoundingRect.right,y:thisBoundingRect.top},{x:thisBoundingRect.right,y:thisBoundingRect.bottom}];var convertedPoint=matrix.multiplyPoint(targetCoordinates[0]);var result={left:convertedPoint.x,right:convertedPoint.x,top:convertedPoint.y,bottom:convertedPoint.y};for(var i=1;i<targetCoordinates.length;++i){convertedPoint=matrix.multiplyPoint(targetCoordinates[i]);if(result.left>convertedPoint.x)result.left=convertedPoint.x;if(result.right<convertedPoint.x)result.right=convertedPoint.x;if(result.top>convertedPoint.y)result.top=convertedPoint.y;if(result.bottom<convertedPoint.y)result.bottom=convertedPoint.y}return result};return Pane}(g.CacheableE);g.Pane=Pane})(g||(g={}));var g;(function(g){var TextInputMethod=function(){function TextInputMethod(game){this.game=game}TextInputMethod.prototype.open=function(defaultText,callback){throw g.ExceptionFactory.createPureVirtualError("TextInputMethod#open")};return TextInputMethod}();g.TextInputMethod=TextInputMethod})(g||(g={}));var g;(function(g){var OperationHandler=function(){function OperationHandler(code,owner,handler){this._code=code;this._handler=handler;this._handlerOwner=owner}OperationHandler.prototype.onOperation=function(op){var iop;if(op instanceof Array){iop={_code:this._code,data:op}}else{iop=op;iop._code=this._code}this._handler.call(this._handlerOwner,iop)};return OperationHandler}();var OperationPluginManager=function(){function OperationPluginManager(game,viewInfo,infos){this.operated=new g.Trigger;this.plugins={};this._game=game;this._viewInfo=viewInfo;this._infos=infos;this._initialized=false}OperationPluginManager.prototype.initialize=function(){if(!this._initialized){this._initialized=true;this._loadOperationPlugins()}this._doAutoStart()};OperationPluginManager.prototype.destroy=function(){this.stopAll();this.operated.destroy();this.operated=undefined;this.plugins=undefined;this._game=undefined;this._viewInfo=undefined;this._infos=undefined};OperationPluginManager.prototype.stopAll=function(){if(!this._initialized)return;for(var i=0;i<this._infos.length;++i){var info=this._infos[i];if(info._plugin)info._plugin.stop()}};OperationPluginManager.prototype._doAutoStart=function(){for(var i=0;i<this._infos.length;++i){var info=this._infos[i];if(!info.manualStart&&info._plugin)info._plugin.start()}};OperationPluginManager.prototype._loadOperationPlugins=function(){for(var i=0;i<this._infos.length;++i){var info=this._infos[i];if(!info.script)continue;var pluginClass=g._require(this._game,info.script);if(!pluginClass.isSupported())continue;var plugin=new pluginClass(this._game,this._viewInfo,info.option);var code=info.code;if(this.plugins[code]){throw new Error("Plugin#code conflicted for code: "+code)}this.plugins[code]=plugin;info._plugin=plugin;var handler=new OperationHandler(code,this.operated,this.operated.fire);plugin.operationTrigger.handle(handler,handler.onOperation)}};return OperationPluginManager}();g.OperationPluginManager=OperationPluginManager})(g||(g={}));var g;(function(g){})(g||(g={}));var g;(function(g){var FontWeight;(function(FontWeight){FontWeight[FontWeight["Normal"]=0]="Normal";FontWeight[FontWeight["Bold"]=1]="Bold"})(FontWeight=g.FontWeight||(g.FontWeight={}));var SurfaceAtlasSlot=function(){function SurfaceAtlasSlot(x,y,width,height){this.x=x;this.y=y;this.width=width;this.height=height;this.prev=null;this.next=null}return SurfaceAtlasSlot}();g.SurfaceAtlasSlot=SurfaceAtlasSlot;function getSurfaceAtlasSlot(slot,width,height){while(slot){if(slot.width>=width&&slot.height>=height){return slot}slot=slot.next}return null}function calcAtlasSize(hint){var width=Math.ceil(Math.min(hint.initialAtlasWidth,hint.maxAtlasWidth));var height=Math.ceil(Math.min(hint.initialAtlasHeight,hint.maxAtlasHeight));return{width:width,height:height}}var SurfaceAtlas=function(){function SurfaceAtlas(surface){this._surface=surface;this._emptySurfaceAtlasSlotHead=new SurfaceAtlasSlot(0,0,this._surface.width,this._surface.height);this._accessScore=0;this._usedRectangleAreaSize={width:0,height:0}}SurfaceAtlas.prototype._acquireSurfaceAtlasSlot=function(width,height){width+=1;height+=1;var slot=getSurfaceAtlasSlot(this._emptySurfaceAtlasSlotHead,width,height);if(!slot){return null}var remainWidth=slot.width-width;var remainHeight=slot.height-height;var left;var right;if(remainWidth<=remainHeight){left=new SurfaceAtlasSlot(slot.x+width,slot.y,remainWidth,height);right=new SurfaceAtlasSlot(slot.x,slot.y+height,slot.width,remainHeight)}else{left=new SurfaceAtlasSlot(slot.x,slot.y+height,width,remainHeight);right=new SurfaceAtlasSlot(slot.x+width,slot.y,remainWidth,slot.height)}left.prev=slot.prev;left.next=right;if(left.prev===null){this._emptySurfaceAtlasSlotHead=left}else{left.prev.next=left}right.prev=left;right.next=slot.next;if(right.next){right.next.prev=right}var acquiredSlot=new SurfaceAtlasSlot(slot.x,slot.y,width,height);this._updateUsedRectangleAreaSize(acquiredSlot);return acquiredSlot};SurfaceAtlas.prototype._updateUsedRectangleAreaSize=function(slot){var slotRight=slot.x+slot.width;var slotBottom=slot.y+slot.height;if(slotRight>this._usedRectangleAreaSize.width){this._usedRectangleAreaSize.width=slotRight}if(slotBottom>this._usedRectangleAreaSize.height){this._usedRectangleAreaSize.height=slotBottom}};SurfaceAtlas.prototype.addSurface=function(surface,rect){var slot=this._acquireSurfaceAtlasSlot(rect.width,rect.height);if(!slot){return null}var renderer=this._surface.renderer();renderer.begin();renderer.drawImage(surface,rect.x,rect.y,rect.width,rect.height,slot.x,slot.y);renderer.end();return slot};SurfaceAtlas.prototype.destroy=function(){this._surface.destroy()};SurfaceAtlas.prototype.destroyed=function(){return this._surface.destroyed()};SurfaceAtlas.prototype.duplicateSurface=function(resourceFactory){var src=this._surface;var dst=resourceFactory.createSurface(this._usedRectangleAreaSize.width,this._usedRectangleAreaSize.height);var renderer=dst.renderer();renderer.begin();renderer.drawImage(src,0,0,this._usedRectangleAreaSize.width,this._usedRectangleAreaSize.height,0,0);renderer.end();return dst};return SurfaceAtlas}();g.SurfaceAtlas=SurfaceAtlas;var DynamicFont=function(){function DynamicFont(fontFamilyOrParam,size,game,hint,fontColor,strokeWidth,strokeColor,strokeOnly){if(hint===void 0){hint={}}if(fontColor===void 0){fontColor="black"}if(strokeWidth===void 0){strokeWidth=0}if(strokeColor===void 0){strokeColor="black"}if(strokeOnly===void 0){strokeOnly=false}if(typeof fontFamilyOrParam==="number"){this.fontFamily=fontFamilyOrParam;this.size=size;this.hint=hint;this.fontColor=fontColor;this.strokeWidth=strokeWidth;this.strokeColor=strokeColor;this.strokeOnly=strokeOnly;this._resourceFactory=game.resourceFactory;this._glyphFactory=this._resourceFactory.createGlyphFactory(fontFamilyOrParam,size,hint.baselineHeight,fontColor,strokeWidth,strokeColor,strokeOnly);game.logger.debug("[deprecated] DynamicFont: This constructor is deprecated. "+"Refer to the API documentation and use constructor(param: DynamicFontParameterObject) instead.")}else{var param=fontFamilyOrParam;this.fontFamily=param.fontFamily;this.size=param.size;this.hint="hint"in param?param.hint:{};this.fontColor="fontColor"in param?param.fontColor:"black";this.fontWeight="fontWeight"in param?param.fontWeight:FontWeight.Normal;this.strokeWidth="strokeWidth"in param?param.strokeWidth:0;this.strokeColor="strokeColor"in param?param.strokeColor:"black";this.strokeOnly="strokeOnly"in param?param.strokeOnly:false;this._resourceFactory=param.game.resourceFactory;this._glyphFactory=this._resourceFactory.createGlyphFactory(this.fontFamily,this.size,this.hint.baselineHeight,this.fontColor,this.strokeWidth,this.strokeColor,this.strokeOnly,this.fontWeight)}this._glyphs={};this._atlases=[];this._currentAtlasIndex=0;this._destroyed=false;this.hint.initialAtlasWidth=this.hint.initialAtlasWidth?this.hint.initialAtlasWidth:2048;this.hint.initialAtlasHeight=this.hint.initialAtlasHeight?this.hint.initialAtlasHeight:2048;this.hint.maxAtlasWidth=this.hint.maxAtlasWidth?this.hint.maxAtlasWidth:2048;this.hint.maxAtlasHeight=this.hint.maxAtlasHeight?this.hint.maxAtlasHeight:2048;this.hint.maxAtlasNum=this.hint.maxAtlasNum?this.hint.maxAtlasNum:1;this._atlasSize=calcAtlasSize(this.hint);this._atlases.push(this._resourceFactory.createSurfaceAtlas(this._atlasSize.width,this._atlasSize.height));if(hint.presetChars){for(var i=0,len=hint.presetChars.length;i<len;i++){var code=g.Util.charCodeAt(hint.presetChars,i);if(!code){continue}this.glyphForCharacter(code)}}}DynamicFont.prototype.glyphForCharacter=function(code){var glyph=this._glyphs[code];if(!(glyph&&glyph.isSurfaceValid)){glyph=this._glyphFactory.create(code);if(glyph.surface){if(glyph.width>this._atlasSize.width||glyph.height>this._atlasSize.height){return null}var atlas_1=this._addToAtlas(glyph);if(!atlas_1){this._reallocateAtlas();atlas_1=this._addToAtlas(glyph);if(!atlas_1){return null}}glyph._atlas=atlas_1}this._glyphs[code]=glyph}for(var i=0;i<this._atlases.length;i++){var atlas=this._atlases[i];if(atlas===glyph._atlas){atlas._accessScore+=1}atlas._accessScore/=2}return glyph};DynamicFont.prototype.asBitmapFont=function(missingGlyphChar){var _this=this;if(this._atlases.length!==1){return null}var missingGlyphCharCodePoint;if(missingGlyphChar){missingGlyphCharCodePoint=g.Util.charCodeAt(missingGlyphChar,0);this.glyphForCharacter(missingGlyphCharCodePoint)}var glyphAreaMap={};Object.keys(this._glyphs).forEach(function(_key){var key=Number(_key);var glyph=_this._glyphs[key];var glyphArea={x:glyph.x,y:glyph.y,width:glyph.width,height:glyph.height,offsetX:glyph.offsetX,offsetY:glyph.offsetY,advanceWidth:glyph.advanceWidth};glyphAreaMap[key]=glyphArea});var missingGlyph=glyphAreaMap[missingGlyphCharCodePoint];var surface=this._atlases[0].duplicateSurface(this._resourceFactory);var bitmapFont=new g.BitmapFont(surface,glyphAreaMap,0,this.size,missingGlyph);return bitmapFont};DynamicFont.prototype._removeLowUseAtlas=function(){var minScore=Number.MAX_VALUE;var lowScoreAtlasIndex=-1;for(var i=0;i<this._atlases.length;i++){if(this._atlases[i]._accessScore<=minScore){minScore=this._atlases[i]._accessScore;lowScoreAtlasIndex=i}}var removedAtlas=this._atlases.splice(lowScoreAtlasIndex,1)[0];return removedAtlas};DynamicFont.prototype._reallocateAtlas=function(){if(this._atlases.length>=this.hint.maxAtlasNum){var atlas=this._removeLowUseAtlas();var glyphs=this._glyphs;for(var key in glyphs){if(glyphs.hasOwnProperty(key)){var glyph=glyphs[key];if(glyph.surface===atlas._surface){glyph.surface=null;glyph.isSurfaceValid=false;glyph._atlas=null}}}atlas.destroy()}this._atlases.push(this._resourceFactory.createSurfaceAtlas(this._atlasSize.width,this._atlasSize.height));this._currentAtlasIndex=this._atlases.length-1};DynamicFont.prototype._addToAtlas=function(glyph){var atlas=null;var slot=null;var area={x:glyph.x,y:glyph.y,width:glyph.width,height:glyph.height};for(var i=0;i<this._atlases.length;i++){var index=(this._currentAtlasIndex+i)%this._atlases.length;atlas=this._atlases[index];slot=atlas.addSurface(glyph.surface,area);if(slot){this._currentAtlasIndex=index;break}}if(!slot){return null}glyph.surface.destroy();glyph.surface=atlas._surface;glyph.x=slot.x;glyph.y=slot.y;return atlas};DynamicFont.prototype.destroy=function(){for(var i=0;i<this._atlases.length;i++){this._atlases[i].destroy()}this._glyphs=null;this._glyphFactory=null;this._destroyed=true};DynamicFont.prototype.destroyed=function(){return this._destroyed};return DynamicFont}();g.DynamicFont=DynamicFont})(g||(g={}));var g;(function(g){var AudioSystemManager=function(){function AudioSystemManager(game){this._game=game;this._muted=false;this._playbackRate=1}AudioSystemManager.prototype._reset=function(){this._muted=false;this._playbackRate=1;var systems=this._game.audio;for(var id in systems){if(!systems.hasOwnProperty(id))continue;systems[id]._reset()}};AudioSystemManager.prototype._setMuted=function(muted){if(this._muted===muted)return;this._muted=muted;var systems=this._game.audio;for(var id in systems){if(!systems.hasOwnProperty(id))continue;systems[id]._setMuted(muted)}};AudioSystemManager.prototype._setPlaybackRate=function(rate){if(this._playbackRate===rate)return;this._playbackRate=rate;var systems=this._game.audio;for(var id in systems){if(!systems.hasOwnProperty(id))continue;systems[id]._setPlaybackRate(rate)}};return AudioSystemManager}();g.AudioSystemManager=AudioSystemManager})(g||(g={}));var g;(function(g){var CompositeOperation;(function(CompositeOperation){CompositeOperation[CompositeOperation["SourceOver"]=0]="SourceOver";CompositeOperation[CompositeOperation["SourceAtop"]=1]="SourceAtop";CompositeOperation[CompositeOperation["Lighter"]=2]="Lighter";CompositeOperation[CompositeOperation["Copy"]=3]="Copy"})(CompositeOperation=g.CompositeOperation||(g.CompositeOperation={}))})(g||(g={}));var g;(function(g){var GlyphFactory=function(){function GlyphFactory(fontFamily,fontSize,baselineHeight,fontColor,strokeWidth,strokeColor,strokeOnly,fontWeight){if(baselineHeight===void 0){baselineHeight=fontSize}if(fontColor===void 0){fontColor="black"}if(strokeWidth===void 0){strokeWidth=0}if(strokeColor===void 0){strokeColor="black"}if(strokeOnly===void 0){strokeOnly=false}if(fontWeight===void 0){fontWeight=g.FontWeight.Normal}this.fontFamily=fontFamily;this.fontSize=fontSize;this.fontWeight=fontWeight;this.baselineHeight=baselineHeight;this.fontColor=fontColor;this.strokeWidth=strokeWidth;this.strokeColor=strokeColor;this.strokeOnly=strokeOnly}GlyphFactory.prototype.create=function(code){throw g.ExceptionFactory.createPureVirtualError("GlyphFactory#create")};return GlyphFactory}();g.GlyphFactory=GlyphFactory})(g||(g={}));var g;(function(g){var LocalTickMode;(function(LocalTickMode){LocalTickMode[LocalTickMode["NonLocal"]=0]="NonLocal";LocalTickMode[LocalTickMode["FullLocal"]=1]="FullLocal";LocalTickMode[LocalTickMode["InterpolateLocal"]=2]="InterpolateLocal"})(LocalTickMode=g.LocalTickMode||(g.LocalTickMode={}))})(g||(g={}));var g;(function(g){var MultiLineLabel=function(_super){__extends(MultiLineLabel,_super);function MultiLineLabel(sceneOrParam,text,font,fontSize,width,lineBreak){if(lineBreak===void 0){lineBreak=true}var _this=this;if(sceneOrParam instanceof g.Scene){var scene=sceneOrParam;_this=_super.call(this,scene)||this;_this.text=text;_this.bitmapFont=font;_this.fontSize=fontSize;_this.width=width;_this.lineBreak=lineBreak;_this.lineGap=0;_this.textAlign=g.TextAlign.Left;_this.textColor=undefined}else{var param=sceneOrParam;_this=_super.call(this,param)||this;_this.text=param.text;_this.bitmapFont=param.bitmapFont;_this.fontSize=param.fontSize;_this.width=param.width;_this.lineBreak="lineBreak"in param?param.lineBreak:true;_this.lineGap=param.lineGap||0;_this.textAlign="textAlign"in param?param.textAlign:g.TextAlign.Left;_this.textColor=param.textColor}_this._lines=[];_this._beforeText=undefined;_this._beforeLineBreak=undefined;_this._beforeBitmapFont=undefined;_this._beforeFontSize=undefined;_this._beforeTextAlign=undefined;_this._beforeWidth=undefined;_this._invalidateSelf();return _this}MultiLineLabel.prototype.invalidate=function(){this._invalidateSelf();_super.prototype.invalidate.call(this)};MultiLineLabel.prototype.renderCache=function(renderer){if(this.fontSize===0)return;renderer.save();for(var i=0;i<this._lines.length;++i){if(this._lines[i].width<=0)continue;renderer.drawImage(this._lines[i].surface,0,0,this._lines[i].width,this.fontSize,this._offsetX(this._lines[i].width),i*(this.fontSize+this.lineGap))}if(this.textColor){renderer.setCompositeOperation(g.CompositeOperation.SourceAtop);renderer.fillRect(0,0,this.width,this.height,this.textColor)}renderer.restore()};MultiLineLabel.prototype.destroy=function(){this._destroyLines();_super.prototype.destroy.call(this)};MultiLineLabel.prototype._offsetX=function(width){switch(this.textAlign){case g.TextAlign.Left:return 0;case g.TextAlign.Right:return this.width-width;case g.TextAlign.Center:return(this.width-width)/2;default:return 0}};MultiLineLabel.prototype._lineBrokenText=function(){var splited=this.text.split(/\r\n|\r|\n/);if(this.lineBreak){var lines=[];for(var i=0;i<splited.length;++i){var t=splited[i];var lineWidth=0;var start=0;for(var j=0;j<t.length;++j){var glyph=this.bitmapFont.glyphForCharacter(t.charCodeAt(j));var w=glyph.renderingWidth(this.fontSize);if(lineWidth+w>this.width){lines.push(t.substring(start,j));start=j;lineWidth=0}lineWidth+=w}lines.push(t.substring(start,t.length))}return lines}else{return splited}};MultiLineLabel.prototype._invalidateSelf=function(){if(this.fontSize<0)throw g.ExceptionFactory.createAssertionError("MultiLineLabel#_invalidateSelf: fontSize must not be negative.");if(this.lineGap<-1*this.fontSize)throw g.ExceptionFactory.createAssertionError("MultiLineLabel#_invalidateSelf: lineGap must be greater than -1 * fontSize.");if(this._beforeText!==this.text||this._beforeFontSize!==this.fontSize||this._beforeBitmapFont!==this.bitmapFont||this._beforeLineBreak!==this.lineBreak||this._beforeWidth!==this.width&&this._beforeLineBreak===true){this._createLines()}this.height=this.fontSize+(this.fontSize+this.lineGap)*(this._lines.length-1);this._beforeText=this.text;this._beforeTextAlign=this.textAlign;this._beforeFontSize=this.fontSize;this._beforeLineBreak=this.lineBreak;this._beforeBitmapFont=this.bitmapFont;this._beforeWidth=this.width};MultiLineLabel.prototype._createLineInfo=function(str){if(this.fontSize===0){return{text:str,width:0}}var lineWidth=0;var glyphs=[];for(var i=0;i<str.length;++i){var glyph=this.bitmapFont.glyphForCharacter(str.charCodeAt(i));if(!glyph.width||!glyph.height){continue}glyphs.push(glyph);lineWidth+=glyph.renderingWidth(this.fontSize)}if(lineWidth===0){return{text:str,width:0}}var textSurface=this.scene.game.resourceFactory.createSurface(Math.ceil(lineWidth),Math.ceil(this.fontSize));var textRenderer=textSurface.renderer();textRenderer.begin();textRenderer.save();for(var i=0;i<glyphs.length;++i){var glyph=glyphs[i];textRenderer.save();var glyphScale=this.fontSize/glyph.height;textRenderer.transform([glyphScale,0,0,glyphScale,0,0]);textRenderer.drawImage(this.bitmapFont.surface,glyph.x,glyph.y,glyph.width,glyph.height,0,0);textRenderer.restore();textRenderer.translate(glyph.renderingWidth(this.fontSize),0)}textRenderer.restore();textRenderer.end();return{text:str,width:lineWidth,surface:textSurface}};MultiLineLabel.prototype._createLines=function(){var lineText=this._lineBrokenText();var lines=[];for(var i=0;i<lineText.length;++i){if(this._lines[i]!==undefined&&lineText[i]===this._lines[i].text&&this._beforeBitmapFont===this.bitmapFont&&this._beforeFontSize===this.fontSize){lines.push(this._lines[i])}else{if(this._lines[i]&&this._lines[i].surface&&!this._lines[i].surface.destroyed()){this._lines[i].surface.destroy()}lines.push(this._createLineInfo(lineText[i]))}}for(var i=lines.length;i<this._lines.length;i++){if(this._lines[i].surface&&!this._lines[i].surface.destroyed()){this._lines[i].surface.destroy()}}this._lines=lines};MultiLineLabel.prototype._destroyLines=function(){for(var i=0;i<this._lines.length;i++){if(this._lines[i].surface&&!this._lines[i].surface.destroyed()){this._lines[i].surface.destroy()}}this._lines=undefined};return MultiLineLabel}(g.CacheableE);g.MultiLineLabel=MultiLineLabel})(g||(g={}));var g;(function(g){var NinePatchSurfaceEffector=function(){function NinePatchSurfaceEffector(game,borderWidth){if(borderWidth===void 0){borderWidth=4}this.game=game;if(typeof borderWidth==="number"){this.borderWidth={top:borderWidth,bottom:borderWidth,left:borderWidth,right:borderWidth}}else{this.borderWidth=borderWidth}}NinePatchSurfaceEffector.prototype.render=function(srcSurface,width,height){var surface=this.game.resourceFactory.createSurface(Math.ceil(width),Math.ceil(height));var renderer=surface.renderer();renderer.begin();var sx1=this.borderWidth.left;var sx2=srcSurface.width-this.borderWidth.right;var sy1=this.borderWidth.top;var sy2=srcSurface.height-this.borderWidth.bottom;var dx1=this.borderWidth.left;var dx2=width-this.borderWidth.right;var dy1=this.borderWidth.top;var dy2=height-this.borderWidth.bottom;var srcCorners=[{x:0,y:0,width:this.borderWidth.left,height:this.borderWidth.top},{x:sx2,y:0,width:this.borderWidth.right,height:this.borderWidth.top},{x:0,y:sy2,width:this.borderWidth.left,height:this.borderWidth.bottom},{x:sx2,y:sy2,width:this.borderWidth.right,height:this.borderWidth.bottom}];var destCorners=[{x:0,y:0},{x:dx2,y:0},{x:0,y:dy2},{x:dx2,y:dy2}];var i=0;for(i=0;i<srcCorners.length;++i){var c=srcCorners[i];renderer.save();renderer.translate(destCorners[i].x,destCorners[i].y);renderer.drawImage(srcSurface,c.x,c.y,c.width,c.height,0,0);renderer.restore()}var srcBorders=[{x:sx1,y:0,width:sx2-sx1,height:this.borderWidth.top},{x:0,y:sy1,width:this.borderWidth.left,height:sy2-sy1},{x:sx2,y:sy1,width:this.borderWidth.right,height:sy2-sy1},{x:sx1,y:sy2,width:sx2-sx1,height:this.borderWidth.bottom}];var destBorders=[{x:dx1,y:0,width:dx2-dx1,height:this.borderWidth.top},{x:0,y:dy1,width:this.borderWidth.left,height:dy2-dy1},{x:dx2,y:dy1,width:this.borderWidth.right,height:dy2-dy1},{x:dx1,y:dy2,width:dx2-dx1,height:this.borderWidth.bottom}];for(i=0;i<srcBorders.length;++i){var s=srcBorders[i];var d=destBorders[i];renderer.save();renderer.translate(d.x,d.y);renderer.transform([d.width/s.width,0,0,d.height/s.height,0,0]);renderer.drawImage(srcSurface,s.x,s.y,s.width,s.height,0,0);renderer.restore()}var sw=sx2-sx1;var sh=sy2-sy1;var dw=dx2-dx1;var dh=dy2-dy1;renderer.save();renderer.translate(dx1,dy1);renderer.transform([dw/sw,0,0,dh/sh,0,0]);renderer.drawImage(srcSurface,sx1,sy1,sw,sh,0,0);renderer.restore();renderer.end();return surface};return NinePatchSurfaceEffector}();g.NinePatchSurfaceEffector=NinePatchSurfaceEffector})(g||(g={}));var g;(function(g){var PathUtil;(function(PathUtil){function resolvePath(base,path){function split(str){var ret=str.split("/");if(ret[ret.length-1]==="")ret.pop();return ret}if(path==="")return base;var baseComponents=PathUtil.splitPath(base);var parts=split(baseComponents.path).concat(split(path));var resolved=[];for(var i=0;i<parts.length;++i){var part=parts[i];switch(part){case"..":var popped=resolved.pop();if(popped===undefined||popped===""||popped===".")throw g.ExceptionFactory.createAssertionError("PathUtil.resolvePath: invalid arguments");break;case".":if(resolved.length===0){resolved.push(".")}break;case"":resolved=[""];break;default:resolved.push(part)}}return baseComponents.host+resolved.join("/")}PathUtil.resolvePath=resolvePath;function resolveDirname(path){var index=path.lastIndexOf("/");if(index===-1)return path;return path.substr(0,index)}PathUtil.resolveDirname=resolveDirname;function resolveExtname(path){for(var i=path.length-1;i>=0;--i){var c=path.charAt(i);if(c==="."){return path.substr(i)}else if(c==="/"){return""}}return""}PathUtil.resolveExtname=resolveExtname;function makeNodeModulePaths(path){var pathComponents=PathUtil.splitPath(path);var host=pathComponents.host;path=pathComponents.path;if(path[path.length-1]==="/"){path=path.slice(0,path.length-1)}var parts=path.split("/");var firstDir=parts.indexOf("node_modules");var root=firstDir>0?firstDir-1:0;var dirs=[];for(var i=parts.length-1;i>=root;--i){if(parts[i]==="node_modules")continue;var dirParts=parts.slice(0,i+1);dirParts.push("node_modules");var dir=dirParts.join("/");dirs.push(host+dir)}return dirs}PathUtil.makeNodeModulePaths=makeNodeModulePaths;function addExtname(path,ext){var index=path.indexOf("?");if(index===-1){return path+"."+ext}return path.substring(0,index)+"."+ext+path.substring(index,path.length)}PathUtil.addExtname=addExtname;function splitPath(path){var host="";var doubleSlashIndex=path.indexOf("//");if(doubleSlashIndex>=0){var hostSlashIndex=path.indexOf("/",doubleSlashIndex+2);if(hostSlashIndex>=0){host=path.slice(0,hostSlashIndex);path=path.slice(hostSlashIndex)}else{host=path;path="/"}}else{host=""}return{host:host,path:path}}PathUtil.splitPath=splitPath})(PathUtil=g.PathUtil||(g.PathUtil={}))})(g||(g={}));var g;(function(g){var TextBaseline;(function(TextBaseline){TextBaseline[TextBaseline["Top"]=0]="Top";TextBaseline[TextBaseline["Middle"]=1]="Middle";TextBaseline[TextBaseline["Alphabetic"]=2]="Alphabetic";TextBaseline[TextBaseline["Bottom"]=3]="Bottom"})(TextBaseline=g.TextBaseline||(g.TextBaseline={}));var FontFamily;(function(FontFamily){FontFamily[FontFamily["SansSerif"]=0]="SansSerif";FontFamily[FontFamily["Serif"]=1]="Serif";FontFamily[FontFamily["Monospace"]=2]="Monospace"})(FontFamily=g.FontFamily||(g.FontFamily={}));var SystemLabel=function(_super){__extends(SystemLabel,_super);function SystemLabel(param){var _this=_super.call(this,param)||this;_this.text=param.text;_this.fontSize=param.fontSize;_this.textAlign="textAlign"in param?param.textAlign:g.TextAlign.Left;_this.textBaseline="textBaseline"in param?param.textBaseline:TextBaseline.Alphabetic;_this.maxWidth=param.maxWidth;_this.textColor="textColor"in param?param.textColor:"black";_this.fontFamily="fontFamily"in param?param.fontFamily:FontFamily.SansSerif;_this.strokeWidth="strokeWidth"in param?param.strokeWidth:0;_this.strokeColor="strokeColor"in param?param.strokeColor:"black";_this.strokeOnly="strokeOnly"in param?param.strokeOnly:false;return _this}SystemLabel.prototype.renderSelf=function(renderer,camera){if(this.text){var offsetX;switch(this.textAlign){case g.TextAlign.Right:offsetX=this.width;break;case g.TextAlign.Center:offsetX=this.width/2;break;default:offsetX=0}renderer.drawSystemText(this.text,offsetX,0,this.maxWidth,this.fontSize,this.textAlign,this.textBaseline,this.textColor,this.fontFamily,this.strokeWidth,this.strokeColor,this.strokeOnly)}return true};return SystemLabel}(g.E);g.SystemLabel=SystemLabel})(g||(g={}));var g;(function(g){var TextAlign;(function(TextAlign){TextAlign[TextAlign["Left"]=0]="Left";TextAlign[TextAlign["Center"]=1]="Center";TextAlign[TextAlign["Right"]=2]="Right"})(TextAlign=g.TextAlign||(g.TextAlign={}))})(g||(g={}));var g;(function(g){var TickGenerationMode;(function(TickGenerationMode){TickGenerationMode[TickGenerationMode["ByClock"]=0]="ByClock";TickGenerationMode[TickGenerationMode["Manual"]=1]="Manual"})(TickGenerationMode=g.TickGenerationMode||(g.TickGenerationMode={}))})(g||(g={}));var g;(function(g){var Xorshift=function(){function Xorshift(seed){this.initState(seed)}Xorshift.deserialize=function(ser){var ret=new Xorshift(0);ret._state0U=ser._state0U;ret._state0L=ser._state0L;ret._state1U=ser._state1U;ret._state1L=ser._state1L;return ret};Xorshift.prototype.initState=function(seed){var factor=1812433253;seed=factor*(seed^seed>>30)+1;this._state0U=seed;seed=factor*(seed^seed>>30)+2;this._state0L=seed;seed=factor*(seed^seed>>30)+3;this._state1U=seed;seed=factor*(seed^seed>>30)+4;this._state1L=seed};Xorshift.prototype.randomInt=function(){var s1U=this._state0U;var s1L=this._state0L;var s0U=this._state1U;var s0L=this._state1L;this._state0U=s0U;this._state0L=s0L;var t1U=0;var t1L=0;var t2U=0;var t2L=0;var a1=23;var m1=4294967295<<32-a1;t1U=s1U<<a1|(s1L&m1)>>>32-a1;t1L=s1L<<a1;s1U=s1U^t1U;s1L=s1L^t1L;t1U=s1U^s0U;t1L=s1L^s0L;var a2=17;var m2=4294967295>>>32-a2;t2U=s1U>>>a2;t2L=s1L>>>a2|(s1U&m2)<<32-a2;t1U=t1U^t2U;t1L=t1L^t2L;var a3=26;var m3=4294967295>>>32-a3;t2U=s0U>>>a3;t2L=s0L>>>a3|(s0U&m3)<<32-a3;t1U=t1U^t2U;t1L=t1L^t2L;this._state1U=t1U;this._state1L=t1L;var sumL=(t1L>>>0)+(s0L>>>0);t2U=t1U+s0U+(sumL/2>>>31)>>>0;t2L=sumL>>>0;return[t2U,t2L]};Xorshift.prototype.random=function(){var t2=this.randomInt();return(t2[0]*4294967296+t2[1])/0x10000000000000000};Xorshift.prototype.nextInt=function(min,sup){return Math.floor(min+this.random()*(sup-min))};Xorshift.prototype.serialize=function(){return{_state0U:this._state0U,_state0L:this._state0L,_state1U:this._state1U,_state1L:this._state1L}};return Xorshift}();g.Xorshift=Xorshift})(g||(g={}));var g;(function(g){var XorshiftRandomGenerator=function(_super){__extends(XorshiftRandomGenerator,_super);function XorshiftRandomGenerator(seed,xorshift){var _this=this;if(seed===undefined){throw g.ExceptionFactory.createAssertionError("XorshiftRandomGenerator#constructor: seed is undefined")}else{_this=_super.call(this,seed)||this;if(!!xorshift){_this._xorshift=g.Xorshift.deserialize(xorshift)}else{_this._xorshift=new g.Xorshift(seed)}}return _this}XorshiftRandomGenerator.deserialize=function(ser){return new XorshiftRandomGenerator(ser._seed,ser._xorshift)};XorshiftRandomGenerator.prototype.get=function(min,max){return this._xorshift.nextInt(min,max+1)};XorshiftRandomGenerator.prototype.serialize=function(){return{_seed:this.seed,_xorshift:this._xorshift.serialize()}};return XorshiftRandomGenerator}(g.RandomGenerator);g.XorshiftRandomGenerator=XorshiftRandomGenerator})(g||(g={}));module.exports=g}).call(this)},{}],3:[function(require,module,exports){"use strict"},{}],4:[function(require,module,exports){module.exports=require("./lib/index")},{"./lib/index":26}],5:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.Clock=void 0;var g=require("@akashic/akashic-engine");var Clock=function(){function Clock(param){this.fps=param.fps;this.scaleFactor=param.scaleFactor||1;this.frameTrigger=new g.Trigger;this.rawFrameTrigger=new g.Trigger;this._platform=param.platform;this._maxFramePerOnce=param.maxFramePerOnce;this._deltaTimeBrokenThreshold=param.deltaTimeBrokenThreshold||Clock.DEFAULT_DELTA_TIME_BROKEN_THRESHOLD;if(param.frameHandler){this.frameTrigger.handle(param.frameHandlerOwner,param.frameHandler)}this.running=false;this._totalDeltaTime=0;this._onLooperCall_bound=this._onLooperCall.bind(this);this._looper=this._platform.createLooper(this._onLooperCall_bound);this._waitTime=0;this._waitTimeDoubled=0;this._waitTimeMax=0;this._skipFrameWaitTime=0;this._realMaxFramePerOnce=0}Clock.prototype.start=function(){if(this.running)return;this._totalDeltaTime=0;this._updateWaitTimes(this.fps,this.scaleFactor);this._looper.start();this.running=true};Clock.prototype.stop=function(){if(!this.running)return;this._looper.stop();this.running=false};Clock.prototype.changeScaleFactor=function(scaleFactor){if(this.running){this.stop();this.scaleFactor=scaleFactor;this.start()}else{this.scaleFactor=scaleFactor}};Clock.prototype._onLooperCall=function(deltaTime){if(deltaTime<=0){return this._waitTime-this._totalDeltaTime}if(deltaTime>this._deltaTimeBrokenThreshold){deltaTime=this._waitTime}var totalDeltaTime=this._totalDeltaTime;totalDeltaTime+=deltaTime;if(totalDeltaTime<=this._skipFrameWaitTime){this._totalDeltaTime=totalDeltaTime;return this._waitTime-totalDeltaTime}var frameCount=totalDeltaTime<this._waitTimeDoubled?1:totalDeltaTime>this._waitTimeMax?this._realMaxFramePerOnce:totalDeltaTime/this._waitTime|0;var fc=frameCount;var arg={interrupt:false};while(fc>0&&this.running&&!arg.interrupt){--fc;this.frameTrigger.fire(arg)}totalDeltaTime-=(frameCount-fc)*this._waitTime;this.rawFrameTrigger.fire();this._totalDeltaTime=totalDeltaTime;return this._waitTime-totalDeltaTime};Clock.prototype._updateWaitTimes=function(fps,scaleFactor){var realFps=fps*scaleFactor;this._waitTime=1e3/realFps;this._waitTimeDoubled=Math.max(2e3/realFps|0,1);this._waitTimeMax=Math.max(scaleFactor*(1e3*this._maxFramePerOnce/realFps)|0,1);this._skipFrameWaitTime=this._waitTime*Clock.ANTICIPATE_RATE|0;this._realMaxFramePerOnce=this._maxFramePerOnce*scaleFactor};Clock.ANTICIPATE_RATE=.8;Clock.DEFAULT_DELTA_TIME_BROKEN_THRESHOLD=150;return Clock}();exports.Clock=Clock},{"@akashic/akashic-engine":1}],6:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.EventBuffer=void 0;var pdi=require("@akashic/akashic-pdi");var g=require("@akashic/akashic-engine");var PointEventResolver_1=require("./PointEventResolver");var EventBuffer=function(){function EventBuffer(param){this._amflow=param.amflow;this._isLocalReceiver=true;this._isReceiver=false;this._isSender=false;this._isDiscarder=false;this._defaultEventPriority=0;this._buffer=null;this._joinLeaveBuffer=null;this._localBuffer=null;this._filters=null;this._unfilteredLocalEvents=[];this._unfilteredEvents=[];this._unfilteredJoinLeaves=[];this._pointEventResolver=new PointEventResolver_1.PointEventResolver({game:param.game});this._onEvent_bound=this.onEvent.bind(this)}EventBuffer.isEventLocal=function(pev){switch(pev[0]){case 0:return pev[5];case 1:return pev[3];case 2:return pev[4];case 32:return pev[4];case 33:return pev[7];case 34:return pev[11];case 35:return pev[11];case 64:return pev[5];default:throw g.ExceptionFactory.createAssertionError("EventBuffer.isEventLocal")}};EventBuffer.prototype.setMode=function(param){if(param.isLocalReceiver!=null){this._isLocalReceiver=param.isLocalReceiver}if(param.isReceiver!=null){if(this._isReceiver!==param.isReceiver){this._isReceiver=param.isReceiver;if(param.isReceiver){this._amflow.onEvent(this._onEvent_bound)}else{this._amflow.offEvent(this._onEvent_bound)}}}if(param.isSender!=null){this._isSender=param.isSender}if(param.isDiscarder!=null){this._isDiscarder=param.isDiscarder}if(param.defaultEventPriority!=null){this._defaultEventPriority=param.defaultEventPriority}};EventBuffer.prototype.getMode=function(){return{isLocalReceiver:this._isLocalReceiver,isReceiver:this._isReceiver,isSender:this._isSender,isDiscarder:this._isDiscarder,defaultEventPriority:this._defaultEventPriority}};EventBuffer.prototype.onEvent=function(pev){if(EventBuffer.isEventLocal(pev)){if(this._isLocalReceiver&&!this._isDiscarder)this._unfilteredLocalEvents.push(pev);return}if(this._isReceiver&&!this._isDiscarder){if(pev[0]===0||pev[0]===1){this._unfilteredJoinLeaves.push(pev)}else{this._unfilteredEvents.push(pev)}}if(this._isSender){if(pev[1]==null){pev[1]=this._defaultEventPriority}this._amflow.sendEvent(pev)}};EventBuffer.prototype.onPointEvent=function(e){var pev;switch(e.type){case 0:pev=this._pointEventResolver.pointDown(e);break;case 1:pev=this._pointEventResolver.pointMove(e);break;case 2:pev=this._pointEventResolver.pointUp(e);break}if(!pev)return;this.onEvent(pev)};EventBuffer.prototype.addEventDirect=function(pev){if(EventBuffer.isEventLocal(pev)){if(!this._isLocalReceiver||this._isDiscarder)return;if(this._localBuffer){this._localBuffer.push(pev)}else{this._localBuffer=[pev]}return}if(this._isReceiver&&!this._isDiscarder){if(pev[0]===0||pev[0]===1){if(this._joinLeaveBuffer){this._joinLeaveBuffer.push(pev)}else{this._joinLeaveBuffer=[pev]}}else{if(this._buffer){this._buffer.push(pev)}else{this._buffer=[pev]}}}if(this._isSender){if(pev[1]==null){pev[1]=this._defaultEventPriority}this._amflow.sendEvent(pev)}};EventBuffer.prototype.readEvents=function(){var ret=this._buffer;this._buffer=null;return ret};EventBuffer.prototype.readJoinLeaves=function(){var ret=this._joinLeaveBuffer;this._joinLeaveBuffer=null;return ret};EventBuffer.prototype.readLocalEvents=function(){var ret=this._localBuffer;this._localBuffer=null;return ret};EventBuffer.prototype.addFilter=function(filter,handleEmpty){if(!this._filters)this._filters=[];this._filters.push({func:filter,handleEmpty:!!handleEmpty})};EventBuffer.prototype.removeFilter=function(filter){if(!this._filters)return;if(!filter){this._filters=null;return}for(var i=this._filters.length-1;i>=0;--i){if(this._filters[i].func===filter)this._filters.splice(i,1)}};EventBuffer.prototype.processEvents=function(){var lpevs=this._unfilteredLocalEvents;var pevs=this._unfilteredEvents;var joins=this._unfilteredJoinLeaves;if(!this._filters){if(lpevs.length>0){this._unfilteredLocalEvents=[];this._localBuffer=this._localBuffer?this._localBuffer.concat(lpevs):lpevs}if(pevs.length>0){this._unfilteredEvents=[];this._buffer=this._buffer?this._buffer.concat(pevs):pevs}if(joins.length>0){this._unfilteredJoinLeaves=[];this._joinLeaveBuffer=this._joinLeaveBuffer?this._joinLeaveBuffer.concat(joins):joins}return}if(lpevs.length===0&&pevs.length===0&&joins.length===0){for(var i=0;i<this._filters.length;++i){if(!this._filters[i].handleEmpty)continue;var gpevs=this._filters[i].func([]);if(!gpevs)continue;for(var j=0;j<gpevs.length;++j){var pev=gpevs[j];if(EventBuffer.isEventLocal(pev)){lpevs.push(pev)}else if(pev[0]===0||pev[0]===1){joins.push(pev)}else{pevs.push(pev)}}}}if(lpevs.length>0){this._unfilteredLocalEvents=[];for(var i=0;i<this._filters.length;++i){lpevs=this._filters[i].func(lpevs);if(!lpevs)break}if(lpevs&&lpevs.length>0)this._localBuffer=this._localBuffer?this._localBuffer.concat(lpevs):lpevs}if(pevs.length>0){this._unfilteredEvents=[];for(var i=0;i<this._filters.length;++i){pevs=this._filters[i].func(pevs);if(!pevs)break}if(pevs&&pevs.length>0)this._buffer=this._buffer?this._buffer.concat(pevs):pevs}if(joins.length>0){this._unfilteredJoinLeaves=[];for(var i=0;i<this._filters.length&&joins&&joins.length>0;++i){joins=this._filters[i].func(joins);if(!joins)break}if(joins&&joins.length>0)this._joinLeaveBuffer=this._joinLeaveBuffer?this._joinLeaveBuffer.concat(joins):joins}};return EventBuffer}();exports.EventBuffer=EventBuffer},{"./PointEventResolver":17,"@akashic/akashic-engine":1,"@akashic/akashic-pdi":3}],7:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.EventConverter=void 0;var g=require("@akashic/akashic-engine");var EventConverter=function(){function EventConverter(param){this._game=param.game;this._playerTable={}}EventConverter.prototype.toGameEvent=function(pev){var pointerId;var entityId;var target;var point;var startDelta;var prevDelta;var local;var timestamp;var eventCode=pev[0];var prio=pev[1];var playerId=pev[2];var player=this._playerTable[playerId]||{id:playerId};switch(eventCode){case 0:player={id:playerId,name:pev[3]};this._playerTable[playerId]=player;var store=undefined;if(pev[4]){var keys=[];var values=[];pev[4].map(function(data){keys.push(data.readKey);values.push(data.values)});store=new g.StorageValueStore(keys,values)}return new g.JoinEvent(player,store,prio);case 1:delete this._playerTable[player.id];return new g.LeaveEvent(player,prio);case 2:timestamp=pev[3];return new g.TimestampEvent(timestamp,player,prio);case 32:local=pev[4];return new g.MessageEvent(pev[3],player,local,prio);case 33:local=pev[7];pointerId=pev[3];entityId=pev[6];target=entityId==null?undefined:entityId>=0?this._game.db[entityId]:this._game._localDb[entityId];point={x:pev[4],y:pev[5]};return new g.PointDownEvent(pointerId,target,point,player,local,prio);case 34:local=pev[11];pointerId=pev[3];entityId=pev[10];target=entityId==null?undefined:entityId>=0?this._game.db[entityId]:this._game._localDb[entityId];point={x:pev[4],y:pev[5]};startDelta={x:pev[6],y:pev[7]};prevDelta={x:pev[8],y:pev[9]};return new g.PointMoveEvent(pointerId,target,point,prevDelta,startDelta,player,local,prio);case 35:local=pev[11];pointerId=pev[3];entityId=pev[10];target=entityId==null?undefined:entityId>=0?this._game.db[entityId]:this._game._localDb[entityId];point={x:pev[4],y:pev[5]};startDelta={x:pev[6],y:pev[7]};prevDelta={x:pev[8],y:pev[9]};return new g.PointUpEvent(pointerId,target,point,prevDelta,startDelta,player,local,prio);case 64:local=pev[5];var operationCode=pev[3];var operationData=pev[4];var decodedData=this._game._decodeOperationPluginOperation(operationCode,operationData);return new g.OperationEvent(operationCode,decodedData,player,local,prio);default:throw g.ExceptionFactory.createAssertionError("EventConverter#toGameEvent")}};EventConverter.prototype.toPlaylogEvent=function(e,preservePlayer){var targetId;var playerId;switch(e.type){case g.EventType.Join:case g.EventType.Leave:throw g.ExceptionFactory.createAssertionError("EventConverter#toPlaylogEvent: Invalid type: "+g.EventType[e.type]);case g.EventType.Timestamp:var ts=e;playerId=preservePlayer?ts.player.id:this._game.player.id;return[2,ts.priority,playerId,ts.timestamp];case g.EventType.PointDown:var pointDown=e;targetId=pointDown.target?pointDown.target.id:null;playerId=preservePlayer?pointDown.player.id:this._game.player.id;return[33,pointDown.priority,playerId,pointDown.pointerId,pointDown.point.x,pointDown.point.y,targetId,!!pointDown.local];case g.EventType.PointMove:var pointMove=e;targetId=pointMove.target?pointMove.target.id:null;playerId=preservePlayer?pointMove.player.id:this._game.player.id;return[34,pointMove.priority,playerId,pointMove.pointerId,pointMove.point.x,pointMove.point.y,pointMove.startDelta.x,pointMove.startDelta.y,pointMove.prevDelta.x,pointMove.prevDelta.y,targetId,!!pointMove.local];case g.EventType.PointUp:var pointUp=e;targetId=pointUp.target?pointUp.target.id:null;playerId=preservePlayer?pointUp.player.id:this._game.player.id;return[35,pointUp.priority,playerId,pointUp.pointerId,pointUp.point.x,pointUp.point.y,pointUp.startDelta.x,pointUp.startDelta.y,pointUp.prevDelta.x,pointUp.prevDelta.y,targetId,!!pointUp.local];case g.EventType.Message:var message=e;playerId=preservePlayer?message.player.id:this._game.player.id;return[32,message.priority,playerId,message.data,!!message.local];case g.EventType.Operation:var op=e;playerId=preservePlayer?op.player.id:this._game.player.id;return[64,op.priority,playerId,op.code,op.data,!!op.local];default:throw g.ExceptionFactory.createAssertionError("Unknown type: "+e.type)}};EventConverter.prototype.makePlaylogOperationEvent=function(op){var playerId=this._game.player.id;var priority=op.priority!=null?op.priority:0;return[64,priority,playerId,op._code,op.data,!!op.local]};return EventConverter}();exports.EventConverter=EventConverter},{"@akashic/akashic-engine":1}],8:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true})},{}],9:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var ExecutionMode;(function(ExecutionMode){ExecutionMode[ExecutionMode["Active"]=0]="Active";ExecutionMode[ExecutionMode["Passive"]=1]="Passive"})(ExecutionMode||(ExecutionMode={}));exports.default=ExecutionMode},{}],10:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:true});exports.Game=void 0;var g=require("@akashic/akashic-engine");var Game=function(_super){__extends(Game,_super);function Game(param){var _this=_super.call(this,param.configuration,param.resourceFactory,param.assetBase,param.player.id,param.operationPluginViewInfo)||this;_this.agePassedTrigger=new g.Trigger;_this.skippingChangedTrigger=new g.Trigger;_this.abortTrigger=new g.Trigger;_this.player=param.player;_this.raiseEventTrigger=new g.Trigger;_this.raiseTickTrigger=new g.Trigger;_this.snapshotTrigger=new g.Trigger;_this.isSnapshotSaver=!!param.isSnapshotSaver;_this._getCurrentTimeFunc=null;_this._eventFilterFuncs=null;_this._notifyPassedAgeTable={};_this._gameArgs=param.gameArgs;_this._globalGameArgs=param.globalGameArgs;return _this}Game.prototype.requestNotifyAgePassed=function(age){this._notifyPassedAgeTable[age]=true};Game.prototype.cancelNotifyAgePassed=function(age){delete this._notifyPassedAgeTable[age]};Game.prototype.fireAgePassedIfNeeded=function(){var age=this.age-1;if(this._notifyPassedAgeTable[age]){delete this._notifyPassedAgeTable[age];this.agePassedTrigger.fire(age);return true}return false};Game.prototype.setCurrentTimeFunc=function(fun){this._getCurrentTimeFunc=fun};Game.prototype.setEventFilterFuncs=function(funcs){this._eventFilterFuncs=funcs};Game.prototype.setStorageFunc=function(funcs){this.storage._registerLoad(funcs.storageGetFunc);this.storage._registerWrite(funcs.storagePutFunc);this.storage.requestValuesForJoinPlayer=funcs.requestValuesForJoinFunc};Game.prototype.raiseEvent=function(event){this.raiseEventTrigger.fire(event)};Game.prototype.raiseTick=function(events){if(!this.scene()||this.scene().tickGenerationMode!==g.TickGenerationMode.Manual)throw g.ExceptionFactory.createAssertionError("Game#raiseTick(): tickGenerationMode for the current scene is not Manual.");this.raiseTickTrigger.fire(events)};Game.prototype.addEventFilter=function(filter,handleEmpty){this._eventFilterFuncs.addFilter(filter,handleEmpty)};Game.prototype.removeEventFilter=function(filter){this._eventFilterFuncs.removeFilter(filter)};Game.prototype.shouldSaveSnapshot=function(){return this.isSnapshotSaver};Game.prototype.saveSnapshot=function(gameSnapshot,timestamp){if(timestamp===void 0){timestamp=this._getCurrentTimeFunc()}if(!this.shouldSaveSnapshot())return;this.snapshotTrigger.fire({frame:this.age,timestamp:timestamp,data:{randGenSer:this.random[0].serialize(),gameSnapshot:gameSnapshot}})};Game.prototype._destroy=function(){this.agePassedTrigger.destroy();this.agePassedTrigger=null;this.skippingChangedTrigger.destroy();this.skippingChangedTrigger=null;this.abortTrigger.destroy();this.abortTrigger=null;this.player=null;this.raiseEventTrigger.destroy();this.raiseEventTrigger=null;this.raiseTickTrigger.destroy();this.raiseTickTrigger=null;this.snapshotTrigger.destroy();this.snapshotTrigger=null;this.isSnapshotSaver=false;this._getCurrentTimeFunc=null;this._eventFilterFuncs=null;this._notifyPassedAgeTable=null;this._gameArgs=null;this._globalGameArgs=null;_super.prototype._destroy.call(this)};Game.prototype._restartWithSnapshot=function(snapshot){var data=snapshot.data;this._eventFilterFuncs.removeFilter();if(data.seed!=null){var randGen=new g.XorshiftRandomGenerator(data.seed);this._reset({age:snapshot.frame,randGen:randGen});this._loadAndStart({args:this._gameArgs,globalArgs:this._globalGameArgs})}else{var randGen=new g.XorshiftRandomGenerator(0,data.randGenSer);this._reset({age:snapshot.frame,randGen:randGen});this._loadAndStart({snapshot:data.gameSnapshot})}};Game.prototype._leaveGame=function(){};Game.prototype._abortGame=function(){this.abortTrigger.fire()};return Game}(g.Game);exports.Game=Game},{"@akashic/akashic-engine":1}],11:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.GameDriver=void 0;var es6_promise_1=require("es6-promise");var g=require("@akashic/akashic-engine");var ExecutionMode_1=require("./ExecutionMode");var Game_1=require("./Game");var EventBuffer_1=require("./EventBuffer");var GameLoop_1=require("./GameLoop");var PdiUtil_1=require("./PdiUtil");var GAME_DESTROYED_MESSAGE="GAME_DESTROYED";var GameDriver=function(){function GameDriver(param){this.errorTrigger=new g.Trigger;if(param.errorHandler)this.errorTrigger.handle(param.errorHandlerOwner,param.errorHandler);this.configurationLoadedTrigger=new g.Trigger;this.gameCreatedTrigger=new g.Trigger;this._platform=param.platform;this._loadConfigurationFunc=PdiUtil_1.PdiUtil.makeLoadConfigurationFunc(param.platform);this._player=param.player;this._rendererRequirement=null;this._playId=null;this._game=null;this._gameLoop=null;this._eventBuffer=null;this._openedAmflow=false;this._playToken=null;this._permission=null;this._hidden=false;this._destroyed=false}GameDriver.prototype.initialize=function(param,callback){this.doInitialize(param).then(function(){callback()},callback)};GameDriver.prototype.changeState=function(param,callback){var _this=this;var pausing=this._gameLoop&&this._gameLoop.running;if(pausing)this._gameLoop.stop();this.initialize(param,function(err){if(err){callback(err);return}if(pausing)_this._gameLoop.start();callback()})};GameDriver.prototype.startGame=function(){if(!this._gameLoop){this.errorTrigger.fire(new Error("Not initialized"));return}this._gameLoop.start()};GameDriver.prototype.stopGame=function(){if(this._gameLoop){this._gameLoop.stop()}};GameDriver.prototype.setNextAge=function(age){this._gameLoop.setNextAge(age)};GameDriver.prototype.getPermission=function(){return this._permission};GameDriver.prototype.getDriverConfiguration=function(){return{playId:this._playId,playToken:this._playToken,executionMode:this._gameLoop?this._gameLoop.getExecutionMode():undefined,eventBufferMode:this._eventBuffer?this._eventBuffer.getMode():undefined}};GameDriver.prototype.getLoopConfiguration=function(){return this._gameLoop?this._gameLoop.getLoopConfiguration():null};GameDriver.prototype.getHidden=function(){return this._hidden};GameDriver.prototype.resetPrimarySurface=function(width,height,rendererCandidates){rendererCandidates=rendererCandidates?rendererCandidates:this._rendererRequirement?this._rendererRequirement.rendererCandidates:null;var game=this._game;var pf=this._platform;var primarySurface=pf.getPrimarySurface();game.renderers=game.renderers.filter(function(renderer){return renderer!==primarySurface.renderer()});pf.setRendererRequirement({primarySurfaceWidth:width,primarySurfaceHeight:height,rendererCandidates:rendererCandidates});this._rendererRequirement={primarySurfaceWidth:width,primarySurfaceHeight:height,rendererCandidates:rendererCandidates};game.renderers.push(pf.getPrimarySurface().renderer());game.width=width;game.height=height;game.resized.fire({width:width,height:height});game.modified=true};GameDriver.prototype.doInitialize=function(param){var _this=this;var p=new es6_promise_1.Promise(function(resolve,reject){if(_this._gameLoop&&_this._gameLoop.running){return reject(new Error("Game is running. Must be stopped."))}if(_this._gameLoop&&param.loopConfiguration){_this._gameLoop.setLoopConfiguration(param.loopConfiguration)}if(param.hidden!=null){_this._hidden=param.hidden;if(_this._game){_this._game._setMuted(param.hidden)}}resolve()}).then(function(){_this._assertLive();return _this._doSetDriverConfiguration(param.driverConfiguration)});if(!param.configurationUrl)return p;return p.then(function(){_this._assertLive();return _this._loadConfiguration(param.configurationUrl,param.assetBase,param.configurationBase)}).then(function(conf){_this._assertLive();return _this._createGame(conf,_this._player,param)})};GameDriver.prototype.destroy=function(){var _this=this;return new es6_promise_1.Promise(function(resolve,reject){_this.stopGame();if(_this._game){_this._game._destroy();_this._game=null}_this.errorTrigger.destroy();_this.errorTrigger=null;_this.configurationLoadedTrigger.destroy();_this.configurationLoadedTrigger=null;_this.gameCreatedTrigger.destroy();_this.gameCreatedTrigger=null;if(_this._platform.destroy){_this._platform.destroy()}else{_this._platform.setRendererRequirement(undefined)}_this._platform=null;_this._loadConfigurationFunc=null;_this._player=null;_this._rendererRequirement=null;_this._playId=null;_this._gameLoop=null;_this._eventBuffer=null;_this._openedAmflow=false;_this._playToken=null;_this._permission=null;_this._hidden=false;_this._destroyed=true;resolve()})};GameDriver.prototype._doSetDriverConfiguration=function(dconf){var _this=this;if(dconf==null){return es6_promise_1.Promise.resolve()}if(dconf.playId===undefined)dconf.playId=this._playId;if(dconf.playToken===undefined)dconf.playToken=this._playToken;if(dconf.eventBufferMode===undefined){if(dconf.executionMode===ExecutionMode_1.default.Active){dconf.eventBufferMode={isReceiver:true,isSender:false}}else if(dconf.executionMode===ExecutionMode_1.default.Passive){dconf.eventBufferMode={isReceiver:false,isSender:true}}}var p=es6_promise_1.Promise.resolve();if(this._playId!==dconf.playId){p=p.then(function(){_this._assertLive();return _this._doOpenAmflow(dconf.playId)})}if(this._playToken!==dconf.playToken){p=p.then(function(){_this._assertLive();return _this._doAuthenticate(dconf.playToken)})}return p.then(function(){_this._assertLive();if(dconf.eventBufferMode!=null){if(dconf.eventBufferMode.defaultEventPriority==null){dconf.eventBufferMode.defaultEventPriority=_this._permission.maxEventPriority}if(_this._eventBuffer){_this._eventBuffer.setMode(dconf.eventBufferMode)}}if(dconf.executionMode!=null){if(_this._gameLoop){_this._gameLoop.setExecutionMode(dconf.executionMode)}}})};GameDriver.prototype._doCloseAmflow=function(){var _this=this;return new es6_promise_1.Promise(function(resolve,reject){if(!_this._openedAmflow)return resolve();_this._platform.amflow.close(function(err){_this._openedAmflow=false;var error=_this._getCallbackError(err);if(error){return reject(error)}resolve()})})};GameDriver.prototype._doOpenAmflow=function(playId){var _this=this;if(playId===undefined){return es6_promise_1.Promise.resolve()}var p=this._doCloseAmflow();return p.then(function(){_this._assertLive();return new es6_promise_1.Promise(function(resolve,reject){if(playId===null)return resolve();_this._platform.amflow.open(playId,function(err){var error=_this._getCallbackError(err);if(error){return reject(error)}_this._openedAmflow=true;_this._playId=playId;if(_this._game)_this._updateGamePlayId(_this._game);resolve()})})})};GameDriver.prototype._doAuthenticate=function(playToken){var _this=this;if(playToken==null)return es6_promise_1.Promise.resolve();return new es6_promise_1.Promise(function(resolve,reject){_this._platform.amflow.authenticate(playToken,function(err,permission){var error=_this._getCallbackError(err);if(error){return reject(error)}_this._playToken=playToken;_this._permission=permission;if(_this._game){_this._game.isSnapshotSaver=_this._permission.writeTick}resolve()})})};GameDriver.prototype._loadConfiguration=function(configurationUrl,assetBase,configurationBase){var _this=this;return new es6_promise_1.Promise(function(resolve,reject){_this._loadConfigurationFunc(configurationUrl,assetBase,configurationBase,function(err,conf){var error=_this._getCallbackError(err);if(error){return reject(error)}_this.configurationLoadedTrigger.fire(conf);resolve(conf)})})};GameDriver.prototype._putZerothStartPoint=function(data){var _this=this;return new es6_promise_1.Promise(function(resolve,reject){var zerothStartPoint={frame:0,timestamp:0,data:data};_this._platform.amflow.putStartPoint(zerothStartPoint,function(err){var error=_this._getCallbackError(err);if(error){return reject(error)}resolve()})})};GameDriver.prototype._getZerothStartPointData=function(){var _this=this;return new es6_promise_1.Promise(function(resolve,reject){_this._platform.amflow.getStartPoint({frame:0},function(err,startPoint){var error=_this._getCallbackError(err);if(error){return reject(error)}var data=startPoint.data;if(typeof data.seed!=="number")return reject(new Error("GameDriver#_getRandomSeed: No seed found."));resolve(data)})})};GameDriver.prototype._createGame=function(conf,player,param){var _this=this;var putSeed=param.driverConfiguration.executionMode===ExecutionMode_1.default.Active&&this._permission.writeTick;var p;if(putSeed){p=this._putZerothStartPoint({seed:Date.now(),globalArgs:param.globalGameArgs,fps:conf.fps,startedAt:Date.now()})}else{p=es6_promise_1.Promise.resolve()}p=p.then(function(){_this._assertLive();return _this._getZerothStartPointData()});return p.then(function(zerothData){_this._assertLive();var pf=_this._platform;var driverConf=param.driverConfiguration||{eventBufferMode:{isReceiver:true,isSender:false},executionMode:ExecutionMode_1.default.Active};var seed=zerothData.seed;var args=param.gameArgs;var globalArgs=zerothData.globalArgs;var startedAt=zerothData.startedAt;var rendererRequirement={primarySurfaceWidth:conf.width,primarySurfaceHeight:conf.height,rendererCandidates:conf.renderers};pf.setRendererRequirement(rendererRequirement);var game=new Game_1.Game({configuration:conf,player:player,resourceFactory:pf.getResourceFactory(),assetBase:param.assetBase,isSnapshotSaver:_this._permission.writeTick,operationPluginViewInfo:pf.getOperationPluginViewInfo?pf.getOperationPluginViewInfo():null,gameArgs:args,globalGameArgs:globalArgs});var eventBuffer=new EventBuffer_1.EventBuffer({game:game,amflow:pf.amflow});eventBuffer.setMode(driverConf.eventBufferMode);pf.setPlatformEventHandler(eventBuffer);game.setEventFilterFuncs({addFilter:eventBuffer.addFilter.bind(eventBuffer),removeFilter:eventBuffer.removeFilter.bind(eventBuffer)});game.renderers.push(pf.getPrimarySurface().renderer());var gameLoop=new GameLoop_1.GameLoop({game:game,amflow:pf.amflow,platform:pf,executionMode:driverConf.executionMode,eventBuffer:eventBuffer,configuration:param.loopConfiguration,startedAt:startedAt,profiler:param.profiler});game.setCurrentTimeFunc(gameLoop.getCurrentTime.bind(gameLoop));game._reset({age:0,randGen:new g.XorshiftRandomGenerator(seed)});_this._updateGamePlayId(game);if(_this._hidden)game._setMuted(true);game.snapshotTrigger.handle(function(startPoint){_this._platform.amflow.putStartPoint(startPoint,function(err){var error=_this._getCallbackError(err);if(error){_this.errorTrigger.fire(error)}})});_this._game=game;_this._eventBuffer=eventBuffer;_this._gameLoop=gameLoop;_this._rendererRequirement=rendererRequirement;_this.gameCreatedTrigger.fire(game);_this._game._loadAndStart({args:param.gameArgs||undefined})})};GameDriver.prototype._updateGamePlayId=function(game){var _this=this;game.playId=this._playId;game.external.send=function(data){_this._platform.sendToExternal(_this._playId,data)}};GameDriver.prototype._assertLive=function(){if(this._destroyed){throw new Error(GAME_DESTROYED_MESSAGE)}};GameDriver.prototype._getCallbackError=function(err){if(err){return err}else if(this._destroyed){return new Error(GAME_DESTROYED_MESSAGE)}return null};return GameDriver}();exports.GameDriver=GameDriver},{"./EventBuffer":6,"./ExecutionMode":9,"./Game":10,"./GameLoop":12,"./PdiUtil":16,"@akashic/akashic-engine":1,"es6-promise":63}],12:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.GameLoop=void 0;var g=require("@akashic/akashic-engine");var LoopMode_1=require("./LoopMode");var LoopRenderMode_1=require("./LoopRenderMode");var ExecutionMode_1=require("./ExecutionMode");var Clock_1=require("./Clock");var ProfilerClock_1=require("./ProfilerClock");var EventConverter_1=require("./EventConverter");var TickController_1=require("./TickController");var GameLoop=function(){function GameLoop(param){this.errorTrigger=new g.Trigger;this.running=false;this._currentTime=0;this._frameTime=1e3/param.game.fps;if(param.errorHandler){this.errorTrigger.handle(param.errorHandlerOwner,param.errorHandler)}var conf=param.configuration;this._startedAt=param.startedAt;this._targetTimeFunc=conf.targetTimeFunc||null;this._targetTimeOffset=conf.targetTimeOffset||null;this._originDate=conf.originDate||null;this._realTargetTimeOffset=this._originDate!=null?this._originDate-this._startedAt:this._targetTimeOffset||0;this._delayIgnoreThreshold=conf.delayIgnoreThreshold||GameLoop.DEFAULT_DELAY_IGNORE_THRESHOLD;this._skipTicksAtOnce=conf.skipTicksAtOnce||GameLoop.DEFAULT_SKIP_TICKS_AT_ONCE;this._skipThreshold=conf.skipThreshold||GameLoop.DEFAULT_SKIP_THRESHOLD;this._jumpTryThreshold=conf.jumpTryThreshold||GameLoop.DEFAULT_JUMP_TRY_THRESHOLD;this._jumpIgnoreThreshold=conf.jumpIgnoreThreshold||GameLoop.DEFAULT_JUMP_IGNORE_THRESHOLD;this._pollingTickThreshold=conf._pollingTickThreshold||GameLoop.DEFAULT_POLLING_TICK_THRESHOLD;this._playbackRate=conf.playbackRate||1;var loopRenderMode=conf.loopRenderMode!=null?conf.loopRenderMode:LoopRenderMode_1.default.AfterRawFrame;this._loopRenderMode=null;this._loopMode=conf.loopMode;this._amflow=param.amflow;this._game=param.game;this._eventBuffer=param.eventBuffer;this._executionMode=param.executionMode;this._sceneTickMode=null;this._sceneLocalMode=null;this._targetAge=conf.targetAge!=null?conf.targetAge:null;this._waitingStartPoint=false;this._lastRequestedStartPointAge=-1;this._lastRequestedStartPointTime=-1;this._waitingNextTick=false;this._skipping=false;this._lastPollingTickTime=0;if(!param.profiler){this._clock=new Clock_1.Clock({fps:param.game.fps,scaleFactor:this._playbackRate,platform:param.platform,maxFramePerOnce:5})}else{this._clock=new ProfilerClock_1.ProfilerClock({fps:param.game.fps,scaleFactor:this._playbackRate,platform:param.platform,maxFramePerOnce:5,profiler:param.profiler})}this._tickController=new TickController_1.TickController({amflow:param.amflow,clock:this._clock,game:param.game,eventBuffer:param.eventBuffer,executionMode:param.executionMode,errorHandler:this.errorTrigger.fire,errorHandlerOwner:this.errorTrigger});this._eventConverter=new EventConverter_1.EventConverter({game:param.game});this._tickBuffer=this._tickController.getBuffer();this._onGotStartPoint_bound=this._onGotStartPoint.bind(this);this._setLoopRenderMode(loopRenderMode);this._game.setStorageFunc(this._tickController.storageFunc());this._game.raiseEventTrigger.handle(this,this._onGameRaiseEvent);this._game.raiseTickTrigger.handle(this,this._onGameRaiseTick);this._game._started.handle(this,this._onGameStarted);this._game._operationPluginOperated.handle(this,this._onGameOperationPluginOperated);this._tickBuffer.gotNextTickTrigger.handle(this,this._onGotNextFrameTick);this._tickBuffer.start();this._updateGamePlaybackRate();this._handleSceneChange()}GameLoop.prototype.start=function(){this.running=true;this._clock.start()};GameLoop.prototype.stop=function(){this._clock.stop();this.running=false};GameLoop.prototype.setNextAge=function(age){this._tickController.setNextAge(age)};GameLoop.prototype.getExecutionMode=function(){return this._executionMode};GameLoop.prototype.setExecutionMode=function(execMode){this._executionMode=execMode;this._tickController.setExecutionMode(execMode)};GameLoop.prototype.getLoopConfiguration=function(){return{loopMode:this._loopMode,delayIgnoreThreshold:this._delayIgnoreThreshold,skipTicksAtOnce:this._skipTicksAtOnce,skipThreshold:this._skipThreshold,jumpTryThreshold:this._jumpTryThreshold,jumpIgnoreThreshold:this._jumpIgnoreThreshold,playbackRate:this._playbackRate,loopRenderMode:this._loopRenderMode,targetTimeFunc:this._targetTimeFunc,targetTimeOffset:this._targetTimeOffset,originDate:this._originDate,targetAge:this._targetAge}};GameLoop.prototype.setLoopConfiguration=function(conf){if(conf.loopMode!=null)this._loopMode=conf.loopMode;if(conf.delayIgnoreThreshold!=null)this._delayIgnoreThreshold=conf.delayIgnoreThreshold;if(conf.skipTicksAtOnce!=null)this._skipTicksAtOnce=conf.skipTicksAtOnce;if(conf.skipThreshold!=null)this._skipThreshold=conf.skipThreshold;if(conf.jumpTryThreshold!=null)this._jumpTryThreshold=conf.jumpTryThreshold;if(conf.jumpIgnoreThreshold!=null)this._jumpIgnoreThreshold=conf.jumpIgnoreThreshold;if(conf.playbackRate!=null){this._playbackRate=conf.playbackRate;this._clock.changeScaleFactor(this._playbackRate);this._updateGamePlaybackRate()}if(conf.loopRenderMode!=null)this._setLoopRenderMode(conf.loopRenderMode);if(conf.targetTimeFunc!=null){this._targetTimeFunc=conf.targetTimeFunc}if(conf.targetTimeOffset!=null)this._targetTimeOffset=conf.targetTimeOffset;if(conf.originDate!=null)this._originDate=conf.originDate;this._realTargetTimeOffset=this._originDate!=null?this._originDate-this._startedAt:this._targetTimeOffset||0;if(conf.targetAge!=null){if(this._targetAge!==conf.targetAge){this._waitingNextTick=false}this._targetAge=conf.targetAge}};GameLoop.prototype.addTickList=function(tickList){this._tickBuffer.addTickList(tickList)};GameLoop.prototype.getCurrentTime=function(){return this._currentTime};GameLoop.prototype._startSkipping=function(){this._skipping=true;this._updateGamePlaybackRate();this._game.skippingChangedTrigger.fire(true)};GameLoop.prototype._stopSkipping=function(){this._skipping=false;this._updateGamePlaybackRate();this._game.skippingChangedTrigger.fire(false)};GameLoop.prototype._updateGamePlaybackRate=function(){var realPlaybackRate=this._skipping?this._playbackRate*this._skipTicksAtOnce:this._playbackRate;this._game._setAudioPlaybackRate(realPlaybackRate)};GameLoop.prototype._handleSceneChange=function(){var scene=this._game.scene();var localMode=scene?scene.local:g.LocalTickMode.FullLocal;var tickMode=scene?scene.tickGenerationMode:g.TickGenerationMode.ByClock;if(this._sceneLocalMode!==localMode||this._sceneTickMode!==tickMode){this._sceneLocalMode=localMode;this._sceneTickMode=tickMode;this._clock.frameTrigger.remove(this,this._onFrame);this._clock.frameTrigger.remove(this,this._onLocalFrame);switch(localMode){case g.LocalTickMode.FullLocal:this._tickController.stopTick();this._clock.frameTrigger.handle(this,this._onLocalFrame);break;case g.LocalTickMode.NonLocal:case g.LocalTickMode.InterpolateLocal:if(tickMode===g.TickGenerationMode.ByClock){this._tickController.startTick()}else{this._tickController.startTickOnce()}this._clock.frameTrigger.handle(this,this._onFrame);break;default:this.errorTrigger.fire(new Error("Unknown LocalTickMode: "+localMode));return}}};GameLoop.prototype._onLocalFrame=function(){this._doLocalTick()};GameLoop.prototype._doLocalTick=function(){var game=this._game;var pevs=this._eventBuffer.readLocalEvents();this._currentTime+=this._frameTime;if(pevs){for(var i=0,len=pevs.length;i<len;++i)game.events.push(this._eventConverter.toGameEvent(pevs[i]))}var sceneChanged=game.tick(false);if(sceneChanged)this._handleSceneChange()};GameLoop.prototype._onFrame=function(frameArg){if(this._loopMode!==LoopMode_1.default.Replay||!this._targetTimeFunc){this._onFrameNormal(frameArg)}else{this._onFrameForTimedReplay(frameArg)}};GameLoop.prototype._onFrameForTimedReplay=function(frameArg){var sceneChanged=false;var game=this._game;var targetTime=this._targetTimeFunc()+this._realTargetTimeOffset;var timeGap=targetTime-this._currentTime;var frameGap=timeGap/this._frameTime;if((frameGap>this._jumpTryThreshold||frameGap<0)&&!this._waitingStartPoint&&this._lastRequestedStartPointTime<this._currentTime){this._waitingStartPoint=true;this._lastRequestedStartPointTime=targetTime;this._amflow.getStartPoint({timestamp:targetTime},this._onGotStartPoint_bound)}if(this._skipping){if(frameGap<=1)this._stopSkipping()}else{if(frameGap>this._skipThreshold)this._startSkipping()}if(frameGap<=0){return}for(var i=0;i<this._skipTicksAtOnce;++i){if(!this._tickBuffer.hasNextTick()){if(!this._waitingNextTick){this._tickBuffer.requestTicks();this._startWaitingNextTick()}break}var nextFrameTime=this._currentTime+this._frameTime;var nextTickTime=this._tickBuffer.readNextTickTime();if(nextTickTime==null)nextTickTime=nextFrameTime;if(targetTime<nextFrameTime){if(nextTickTime<=targetTime){nextFrameTime=targetTime}else{break}}else{if(nextFrameTime<nextTickTime){if(this._sceneLocalMode===g.LocalTickMode.InterpolateLocal){this._doLocalTick()}continue}}this._currentTime=nextFrameTime;var tick=this._tickBuffer.consume();var consumedAge=-1;var plEvents=this._eventBuffer.readLocalEvents();if(plEvents){for(var j=0,len=plEvents.length;j<len;++j){game.events.push(this._eventConverter.toGameEvent(plEvents[j]))}}if(typeof tick==="number"){consumedAge=tick;sceneChanged=game.tick(true)}else{consumedAge=tick[0];var pevs=tick[1];if(pevs){for(var j=0,len=pevs.length;j<len;++j){game.events.push(this._eventConverter.toGameEvent(pevs[j]))}}sceneChanged=game.tick(true)}if(game._notifyPassedAgeTable[consumedAge]){if(game.fireAgePassedIfNeeded()){frameArg.interrupt=true;break}}if(sceneChanged){this._handleSceneChange();break}}};GameLoop.prototype._onFrameNormal=function(frameArg){var sceneChanged=false;var game=this._game;if(this._waitingNextTick){if(this._sceneLocalMode===g.LocalTickMode.InterpolateLocal)this._doLocalTick();return}var targetAge;var ageGap;if(this._loopMode===LoopMode_1.default.Realtime){targetAge=this._tickBuffer.knownLatestAge+1;ageGap=targetAge-this._tickBuffer.currentAge}else{if(this._targetAge===null){targetAge=null;ageGap=1}else if(this._targetAge===this._tickBuffer.currentAge){targetAge=this._targetAge=null;ageGap=1}else{targetAge=this._targetAge;ageGap=targetAge-this._tickBuffer.currentAge}}if((ageGap>this._jumpTryThreshold||ageGap<0)&&!this._waitingStartPoint&&this._lastRequestedStartPointAge<this._tickBuffer.currentAge){this._waitingStartPoint=true;this._lastRequestedStartPointAge=targetAge;this._amflow.getStartPoint({frame:targetAge},this._onGotStartPoint_bound)}if(this._skipping){var skipStopGap=this._loopMode===LoopMode_1.default.Realtime?0:1;if(ageGap<=skipStopGap)this._stopSkipping()}else{if(ageGap>this._skipThreshold)this._startSkipping()}if(ageGap<=0){if(ageGap===0){if(this._tickBuffer.currentAge===0){this._tickBuffer.requestTicks()}this._startWaitingNextTick()}if(this._sceneLocalMode===g.LocalTickMode.InterpolateLocal){this._doLocalTick()}return}var loopCount=!this._skipping&&ageGap<=this._delayIgnoreThreshold?1:Math.min(ageGap,this._skipTicksAtOnce);for(var i=0;i<loopCount;++i){var nextFrameTime=this._currentTime+this._frameTime;var nextTickTime=this._tickBuffer.readNextTickTime();if(nextTickTime!=null&&nextFrameTime<nextTickTime){if(this._loopMode===LoopMode_1.default.Realtime){nextFrameTime=Math.ceil(nextTickTime/this._frameTime)*this._frameTime}else{if(this._sceneLocalMode===g.LocalTickMode.InterpolateLocal){this._doLocalTick();continue}break}}this._currentTime=nextFrameTime;var tick=this._tickBuffer.consume();var consumedAge=-1;if(tick!=null){var plEvents=this._eventBuffer.readLocalEvents();if(plEvents){for(var k=0,len=plEvents.length;k<len;++k){game.events.push(this._eventConverter.toGameEvent(plEvents[k]))}}if(typeof tick==="number"){consumedAge=tick;sceneChanged=game.tick(true)}else{consumedAge=tick[0];var pevs=tick[1];if(pevs){for(var j=0,len=pevs.length;j<len;++j){game.events.push(this._eventConverter.toGameEvent(pevs[j]))}}sceneChanged=game.tick(true)}}else{this._tickBuffer.requestTicks();this._startWaitingNextTick();break}if(game._notifyPassedAgeTable[consumedAge]){if(game.fireAgePassedIfNeeded()){frameArg.interrupt=true;break}}if(sceneChanged){this._handleSceneChange();break}}};GameLoop.prototype._onGotNextFrameTick=function(){if(!this._waitingNextTick)return;if(this._loopMode===LoopMode_1.default.FrameByFrame){return}this._stopWaitingNextTick()};GameLoop.prototype._onGotStartPoint=function(err,startPoint){this._waitingStartPoint=false;if(err){this.errorTrigger.fire(err);return}if(!this._targetTimeFunc||this._loopMode===LoopMode_1.default.Realtime){var targetAge=this._loopMode===LoopMode_1.default.Realtime?this._tickBuffer.knownLatestAge+1:this._targetAge;if(targetAge===null||targetAge<startPoint.frame){return}var currentAge=this._tickBuffer.currentAge;if(currentAge<=targetAge&&startPoint.frame<currentAge+this._jumpIgnoreThreshold){return}}else{var targetTime=this._targetTimeFunc()+this._realTargetTimeOffset;if(targetTime<startPoint.timestamp){return}var currentTime=this._currentTime;if(currentTime<=targetTime&&startPoint.timestamp<currentTime+this._jumpIgnoreThreshold*this._frameTime){return}}this._clock.frameTrigger.remove(this._eventBuffer,this._eventBuffer.processEvents);this._tickBuffer.setCurrentAge(startPoint.frame);this._currentTime=startPoint.timestamp||startPoint.data.timestamp||0;this._waitingNextTick=false;this._lastRequestedStartPointAge=-1;this._lastRequestedStartPointTime=-1;this._game._restartWithSnapshot(startPoint);this._handleSceneChange()};GameLoop.prototype._onGameStarted=function(){this._clock.frameTrigger.handleInsert(0,this._eventBuffer,this._eventBuffer.processEvents)};GameLoop.prototype._setLoopRenderMode=function(mode){if(mode===this._loopRenderMode)return;this._loopRenderMode=mode;switch(mode){case LoopRenderMode_1.default.AfterRawFrame:this._clock.rawFrameTrigger.handle(this,this._renderOnRawFrame);break;case LoopRenderMode_1.default.None:this._clock.rawFrameTrigger.remove(this,this._renderOnRawFrame);break;default:this.errorTrigger.fire(new Error("GameLoop#_setLoopRenderMode: unknown mode: "+mode));break}};GameLoop.prototype._renderOnRawFrame=function(){var game=this._game;if(game.modified&&game.scenes.length>0){game.render()}};GameLoop.prototype._onGameRaiseEvent=function(e){var pev=this._eventConverter.toPlaylogEvent(e);this._eventBuffer.onEvent(pev)};GameLoop.prototype._onGameRaiseTick=function(es){if(this._executionMode!==ExecutionMode_1.default.Active)return;if(es){for(var i=0;i<es.length;++i)this._eventBuffer.addEventDirect(this._eventConverter.toPlaylogEvent(es[i]))}this._tickController.forceGenerateTick()};GameLoop.prototype._onGameOperationPluginOperated=function(op){var pev=this._eventConverter.makePlaylogOperationEvent(op);this._eventBuffer.onEvent(pev)};GameLoop.prototype._onPollingTick=function(){var time=+new Date;if(time-this._lastPollingTickTime>this._pollingTickThreshold){this._lastPollingTickTime=time;this._tickBuffer.requestTicks()}};GameLoop.prototype._startWaitingNextTick=function(){this._waitingNextTick=true;this._clock.rawFrameTrigger.handle(this,this._onPollingTick);this._lastPollingTickTime=+new Date};GameLoop.prototype._stopWaitingNextTick=function(){this._waitingNextTick=false;this._clock.rawFrameTrigger.remove(this,this._onPollingTick)};GameLoop.DEFAULT_DELAY_IGNORE_THRESHOLD=6;GameLoop.DEFAULT_SKIP_TICKS_AT_ONCE=100;GameLoop.DEFAULT_SKIP_THRESHOLD=3e4;GameLoop.DEFAULT_JUMP_TRY_THRESHOLD=9e4;GameLoop.DEFAULT_JUMP_IGNORE_THRESHOLD=15e3;GameLoop.DEFAULT_POLLING_TICK_THRESHOLD=1e4;GameLoop.DEFAULT_DELAY_IGNORE_THERSHOLD=GameLoop.DEFAULT_DELAY_IGNORE_THRESHOLD;return GameLoop}();exports.GameLoop=GameLoop},{"./Clock":5,"./EventConverter":7,"./ExecutionMode":9,"./LoopMode":14,"./LoopRenderMode":15,"./ProfilerClock":18,"./TickController":21,"@akashic/akashic-engine":1}],13:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.JoinResolver=exports.JoinLeaveRequest=void 0;var g=require("@akashic/akashic-engine");var JoinLeaveRequest=function(){function JoinLeaveRequest(pev,joinResolver,amflow,keys){this.joinResolver=joinResolver;this.pev=pev;if(pev[0]===0&&keys){this.resolved=false;amflow.getStorageData(keys,this._onGotStorageData.bind(this))}else{this.resolved=true}}JoinLeaveRequest.prototype._onGotStorageData=function(err,sds){this.resolved=true;if(err){this.joinResolver.errorTrigger.fire(err);return}this.pev[4]=sds};return JoinLeaveRequest}();exports.JoinLeaveRequest=JoinLeaveRequest;var JoinResolver=function(){function JoinResolver(param){this.errorTrigger=new g.Trigger;if(param.errorHandler)this.errorTrigger.handle(param.errorHandlerOwner,param.errorHandler);this._amflow=param.amflow;this._keysForJoin=null;this._requested=[]}JoinResolver.prototype.request=function(pev){this._requested.push(new JoinLeaveRequest(pev,this,this._amflow,this._keysForJoin))};JoinResolver.prototype.readResolved=function(){var len=this._requested.length;if(len===0||!this._requested[0].resolved)return null;var ret=[];for(var i=0;i<len;++i){var req=this._requested[i];if(!req.resolved)break;ret.push(req.pev)}this._requested.splice(0,i);return ret};JoinResolver.prototype.setRequestValuesForJoin=function(keys){this._keysForJoin=keys};return JoinResolver}();exports.JoinResolver=JoinResolver},{"@akashic/akashic-engine":1}],14:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var LoopMode;(function(LoopMode){LoopMode[LoopMode["Realtime"]=0]="Realtime";LoopMode[LoopMode["Replay"]=1]="Replay";LoopMode[LoopMode["FrameByFrame"]=2]="FrameByFrame"})(LoopMode||(LoopMode={}));exports.default=LoopMode},{}],15:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var LoopRenderMode;(function(LoopRenderMode){LoopRenderMode[LoopRenderMode["AfterRawFrame"]=0]="AfterRawFrame";LoopRenderMode[LoopRenderMode["None"]=1]="None"})(LoopRenderMode||(LoopRenderMode={}));exports.default=LoopRenderMode},{}],16:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.PdiUtil=void 0;var es6_promise_1=require("es6-promise");var g=require("@akashic/akashic-engine");var PdiUtil;(function(PdiUtil){function makeLoadConfigurationFunc(pf){function loadResolvedConfiguration(url,assetBase,configurationBase,callback){pf.loadGameConfiguration(url,function(err,conf){if(err){callback(err,null);return}try{conf=PdiUtil._resolveConfigurationBasePath(conf,assetBase!=null?assetBase:g.PathUtil.resolveDirname(url))}catch(e){callback(e,null);return}if(!conf.definitions){callback(null,conf);return}var defs=conf.definitions.map(function(def){if(typeof def==="string"){var resolvedUrl=configurationBase!=null?g.PathUtil.resolvePath(configurationBase,def):def;return promisifiedLoad(resolvedUrl,undefined,configurationBase)}else{var resolvedUrl=configurationBase!=null?g.PathUtil.resolvePath(configurationBase,def.url):def.url;return promisifiedLoad(resolvedUrl,def.basePath,configurationBase)}});es6_promise_1.Promise.all(defs).then(function(confs){return callback(null,confs.reduce(PdiUtil._mergeGameConfiguration))}).catch(function(e){return callback(e,null)})})}function promisifiedLoad(url,assetBase,configurationBase){return new es6_promise_1.Promise(function(resolve,reject){loadResolvedConfiguration(url,assetBase,configurationBase,function(err,conf){err?reject(err):resolve(conf)})})}return loadResolvedConfiguration}PdiUtil.makeLoadConfigurationFunc=makeLoadConfigurationFunc;function _resolveConfigurationBasePath(configuration,assetBase){function resolvePath(base,path){var ret=g.PathUtil.resolvePath(base,path);if(ret.indexOf(base)!==0)throw g.ExceptionFactory.createAssertionError("PdiUtil._resolveConfigurationBasePath: invalid path: "+path);return ret}var assets=configuration.assets;if(assets instanceof Object){for(var p in assets){if(!assets.hasOwnProperty(p))continue;if("path"in assets[p]){assets[p].virtualPath=assets[p].virtualPath||assets[p].path;assets[p].path=resolvePath(assetBase,assets[p].path)}}}if(configuration.globalScripts){configuration.globalScripts.forEach(function(path){if(assets.hasOwnProperty(path))throw g.ExceptionFactory.createAssertionError("PdiUtil._resolveConfigurationBasePath: asset ID already exists: "+path);assets[path]={type:/\.json$/i.test(path)?"text":"script",virtualPath:path,path:resolvePath(assetBase,path),global:true}});delete configuration.globalScripts}return configuration}PdiUtil._resolveConfigurationBasePath=_resolveConfigurationBasePath;function _mergeObject(target,source){var ks=Object.keys(source);for(var i=0,len=ks.length;i<len;++i){var k=ks[i];var sourceVal=source[k];var sourceValType=typeof sourceVal;var targetValType=typeof target[k];if(sourceValType!==targetValType){target[k]=sourceVal;continue}switch(typeof sourceVal){case"string":case"number":case"boolean":target[k]=sourceVal;break;case"object":if(sourceVal==null){target[k]=sourceVal}else if(Array.isArray(sourceVal)){target[k]=target[k].concat(sourceVal)}else{PdiUtil._mergeObject(target[k],sourceVal)}break;default:throw new Error("PdiUtil._mergeObject(): unknown type")}}return target}PdiUtil._mergeObject=_mergeObject;function _mergeGameConfiguration(target,source){return PdiUtil._mergeObject(target,source)}PdiUtil._mergeGameConfiguration=_mergeGameConfiguration})(PdiUtil=exports.PdiUtil||(exports.PdiUtil={}))},{"@akashic/akashic-engine":1,"es6-promise":63}],17:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.PointEventResolver=void 0;var PointEventResolver=function(){function PointEventResolver(param){this._game=param.game;this._pointEventMap={}}PointEventResolver.prototype.pointDown=function(e){var player=this._game.player;var source=this._game.findPointSource(e.offset);var point=source.point?source.point:e.offset;var targetId=source.target?source.target.id:null;this._pointEventMap[e.identifier]={targetId:targetId,local:source.local,point:point,start:{x:e.offset.x,y:e.offset.y},prev:{x:e.offset.x,y:e.offset.y}};var ret=[33,2,player.id,e.identifier,point.x,point.y,targetId];if(source.local)ret.push(source.local);return ret};PointEventResolver.prototype.pointMove=function(e){var player=this._game.player;var holder=this._pointEventMap[e.identifier];if(!holder)return null;var prev={x:0,y:0};var start={x:0,y:0};this._pointMoveAndUp(holder,e.offset,prev,start);var ret=[34,2,player.id,e.identifier,holder.point.x,holder.point.y,start.x,start.y,prev.x,prev.y,holder.targetId];if(holder.local)ret.push(holder.local);return ret};PointEventResolver.prototype.pointUp=function(e){var player=this._game.player;var holder=this._pointEventMap[e.identifier];if(!holder)return null;var prev={x:0,y:0};var start={x:0,y:0};this._pointMoveAndUp(holder,e.offset,prev,start);delete this._pointEventMap[e.identifier];var ret=[35,2,player.id,e.identifier,holder.point.x,holder.point.y,start.x,start.y,prev.x,prev.y,holder.targetId];if(holder.local)ret.push(holder.local);return ret};PointEventResolver.prototype._pointMoveAndUp=function(holder,offset,prevDelta,startDelta){startDelta.x=offset.x-holder.start.x;startDelta.y=offset.y-holder.start.y;prevDelta.x=offset.x-holder.prev.x;prevDelta.y=offset.y-holder.prev.y;holder.prev.x=offset.x;holder.prev.y=offset.y};return PointEventResolver}();exports.PointEventResolver=PointEventResolver},{}],18:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:true});exports.ProfilerClock=void 0;var Clock_1=require("./Clock");var ProfilerClock=function(_super){__extends(ProfilerClock,_super);function ProfilerClock(param){var _this=_super.call(this,param)||this;_this._profiler=param.profiler;return _this}ProfilerClock.prototype._onLooperCall=function(deltaTime){if(deltaTime<=0){return this._waitTime-this._totalDeltaTime}if(deltaTime>this._deltaTimeBrokenThreshold){deltaTime=this._waitTime}var totalDeltaTime=this._totalDeltaTime;totalDeltaTime+=deltaTime;if(totalDeltaTime<=this._skipFrameWaitTime){this._totalDeltaTime=totalDeltaTime;return this._waitTime-totalDeltaTime}this._profiler.timeEnd(1);this._profiler.time(1);var frameCount=totalDeltaTime<this._waitTimeDoubled?1:totalDeltaTime>this._waitTimeMax?this._realMaxFramePerOnce:totalDeltaTime/this._waitTime|0;var fc=frameCount;var arg={interrupt:false};this._profiler.setValue(0,fc-1);while(fc>0&&this.running&&!arg.interrupt){--fc;this._profiler.time(2);this.frameTrigger.fire(arg);this._profiler.timeEnd(2)}totalDeltaTime-=(frameCount-fc)*this._waitTime;this._profiler.time(3);this.rawFrameTrigger.fire();this._profiler.timeEnd(3);this._totalDeltaTime=totalDeltaTime;this._profiler.flush();return this._waitTime-totalDeltaTime};return ProfilerClock}(Clock_1.Clock);exports.ProfilerClock=ProfilerClock},{"./Clock":5}],19:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.StorageResolver=void 0;var g=require("@akashic/akashic-engine");var ExecutionMode_1=require("./ExecutionMode");var StorageResolver=function(){function StorageResolver(param){this.errorTrigger=new g.Trigger;if(param.errorHandler)this.errorTrigger.handle(param.errorHandlerOwner,param.errorHandler);this.getStorageFunc=this._getStorage.bind(this);this.putStorageFunc=this._putStorage.bind(this);this.requestValuesForJoinFunc=this._requestValuesForJoin.bind(this);this._game=param.game;this._amflow=param.amflow;this._tickGenerator=param.tickGenerator;this._tickBuffer=param.tickBuffer;this._executionMode=null;this.setExecutionMode(param.executionMode);this._unresolvedLoaders={};this._unresolvedStorages={};this._onStoragePut_bound=this._onStoragePut.bind(this)}StorageResolver.prototype.setExecutionMode=function(executionMode){if(this._executionMode===executionMode)return;this._executionMode=executionMode;var tickBuf=this._tickBuffer;var tickGen=this._tickGenerator;if(executionMode===ExecutionMode_1.default.Active){tickBuf.gotStorageTrigger.remove(this,this._onGotStorageOnTick);tickGen.gotStorageTrigger.handle(this,this._onGotStorageOnTick)}else{tickGen.gotStorageTrigger.remove(this,this._onGotStorageOnTick);tickBuf.gotStorageTrigger.handle(this,this._onGotStorageOnTick)}};StorageResolver.prototype._onGotStorageOnTick=function(storageOnTick){var resolvingAge=storageOnTick.age;var storageData=storageOnTick.storageData;var loader=this._unresolvedLoaders[resolvingAge];if(!loader){this._unresolvedStorages[resolvingAge]=storageData;return}delete this._unresolvedLoaders[resolvingAge];var serialization=resolvingAge;var values=storageData.map(function(d){return d.values});loader._onLoaded(values,serialization)};StorageResolver.prototype._getStorage=function(keys,loader,ser){var resolvingAge;if(ser!=null){resolvingAge=ser;this._tickBuffer.requestTicks(resolvingAge,1)}else{if(this._executionMode===ExecutionMode_1.default.Active){resolvingAge=this._tickGenerator.requestStorageTick(keys)}else{resolvingAge=this._game.age;this._tickBuffer.requestTicks(resolvingAge,1)}}var sd=this._unresolvedStorages[resolvingAge];if(!sd){this._unresolvedLoaders[resolvingAge]=loader;return}delete this._unresolvedStorages[resolvingAge];var serialization=resolvingAge;var values=sd.map(function(d){return d.values});loader._onLoaded(values,serialization)};StorageResolver.prototype._putStorage=function(key,value,option){if(this._executionMode===ExecutionMode_1.default.Active){this._amflow.putStorageData(key,value,option,this._onStoragePut_bound)}};StorageResolver.prototype._requestValuesForJoin=function(keys){this._tickGenerator.setRequestValuesForJoin(keys)};StorageResolver.prototype._onStoragePut=function(err){if(err)this.errorTrigger.fire(err)};return StorageResolver}();exports.StorageResolver=StorageResolver},{"./ExecutionMode":9,"@akashic/akashic-engine":1}],20:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.TickBuffer=void 0;var g=require("@akashic/akashic-engine");var ExecutionMode_1=require("./ExecutionMode");var TickBuffer=function(){function TickBuffer(param){this.currentAge=0;this.knownLatestAge=-1;this.gotNextTickTrigger=new g.Trigger;this.gotStorageTrigger=new g.Trigger;this._amflow=param.amflow;this._prefetchThreshold=param.prefetchThreshold||TickBuffer.DEFAULT_PREFETCH_THRESHOLD;this._sizeRequestOnce=param.sizeRequestOnce||TickBuffer.DEFAULT_SIZE_REQUEST_ONCE;this._executionMode=param.executionMode;this._receiving=false;this._tickRanges=[];this._nearestAbsentAge=this.currentAge;this._nextTickTimeCache=null;this._addTick_bound=this.addTick.bind(this);this._onTicks_bound=this._onTicks.bind(this)}TickBuffer.prototype.start=function(){this._receiving=true;this._updateAmflowReceiveState()};TickBuffer.prototype.stop=function(){this._receiving=false;this._updateAmflowReceiveState()};TickBuffer.prototype.setExecutionMode=function(execMode){if(this._executionMode===execMode)return;this._dropUntil(this.knownLatestAge+1);this._nextTickTimeCache=null;this._nearestAbsentAge=this.currentAge;this._executionMode=execMode;this._updateAmflowReceiveState()};TickBuffer.prototype.setCurrentAge=function(age){this._dropUntil(age);this._nextTickTimeCache=null;this.currentAge=age;this._nearestAbsentAge=this._findNearestAbscentAge(age)};TickBuffer.prototype.hasNextTick=function(){return this.currentAge!==this._nearestAbsentAge};TickBuffer.prototype.consume=function(){if(this.currentAge===this._nearestAbsentAge)return null;var age=this.currentAge;var range=this._tickRanges[0];if(age===range.start){this._nextTickTimeCache=null;++this.currentAge;++range.start;if(age+this._prefetchThreshold===this._nearestAbsentAge){this.requestTicks(this._nearestAbsentAge,this._sizeRequestOnce)}if(range.start===range.end)this._tickRanges.shift();return range.ticks.length>0&&range.ticks[0][0]===age?range.ticks.shift():age}this._dropUntil(this.currentAge);return this.consume()};TickBuffer.prototype.readNextTickTime=function(){if(this._nextTickTimeCache!=null)return this._nextTickTimeCache;if(this.currentAge===this._nearestAbsentAge)return null;var age=this.currentAge;var range=this._tickRanges[0];if(age===range.start){if(range.ticks.length===0)return null;var tick=range.ticks[0];if(tick[0]!==age)return null;var pevs=tick[1];if(!pevs)return null;for(var i=0;i<pevs.length;++i){if(pevs[i][0]===2){this._nextTickTimeCache=pevs[i][3];return this._nextTickTimeCache}}return null}this._dropUntil(this.currentAge);return this.readNextTickTime()};TickBuffer.prototype.requestTicks=function(from,len){if(from===void 0){from=this.currentAge}if(len===void 0){len=this._sizeRequestOnce}if(this._executionMode!==ExecutionMode_1.default.Passive)return;this._amflow.getTickList(from,from+len,this._onTicks_bound)};TickBuffer.prototype.addTick=function(tick){var age=tick[0];var gotNext=this.currentAge===age&&this._nearestAbsentAge===age;if(this.knownLatestAge<age){this.knownLatestAge=age}if(tick[2]){this.gotStorageTrigger.fire({age:tick[0],storageData:tick[2]})}var i=this._tickRanges.length-1;for(;i>=0;--i){var range=this._tickRanges[i];if(age>=range.start)break}var nextRange=this._tickRanges[i+1];if(i<0){this._tickRanges.unshift(this._createTickRangeFromTick(tick))}else{var range=this._tickRanges[i];if(age===range.end){++range.end;if(tick[1]){range.ticks.push(tick)}}else if(age>range.end){this._tickRanges.splice(i+1,0,this._createTickRangeFromTick(tick))}else{}}if(this._nearestAbsentAge===age){++this._nearestAbsentAge;if(nextRange&&this._nearestAbsentAge===nextRange.start){this._nearestAbsentAge=this._findNearestAbscentAge(this._nearestAbsentAge)}}if(gotNext)this.gotNextTickTrigger.fire()};TickBuffer.prototype.addTickList=function(tickList){var start=tickList[0];var end=tickList[1]+1;var ticks=tickList[2];var origStart=start;var origEnd=end;if(this.knownLatestAge<end-1){this.knownLatestAge=end-1}var i=0;var len=this._tickRanges.length;for(i=0;i<len;++i){var range=this._tickRanges[i];if(start<range.start)break}var insertPoint=i;if(i>0){--i;var leftEndAge=this._tickRanges[i].end;if(start<leftEndAge)start=leftEndAge}for(;i<len;++i){var range=this._tickRanges[i];if(end<=range.end)break}if(i<len){var rightStartAge=this._tickRanges[i].start;if(end>rightStartAge)end=rightStartAge}if(start>=end){return{start:start,end:start,ticks:[]}}if(!ticks)ticks=[];if(origStart!==start||origEnd!==end){ticks=ticks.filter(function(tick){var age=tick[0];return start<=age&&age<end})}for(var j=0;j<ticks.length;++j){var tick=ticks[j];if(tick[2])this.gotStorageTrigger.fire({age:tick[0],storageData:tick[2]})}var tickRange={start:start,end:end,ticks:ticks};var delLen=Math.max(0,i-insertPoint);this._tickRanges.splice(insertPoint,delLen,tickRange);if(start<=this._nearestAbsentAge&&this._nearestAbsentAge<end){this._nearestAbsentAge=this._findNearestAbscentAge(this._nearestAbsentAge)}return tickRange};TickBuffer.prototype._updateAmflowReceiveState=function(){if(this._receiving&&this._executionMode===ExecutionMode_1.default.Passive){this._amflow.onTick(this._addTick_bound)}else{this._amflow.offTick(this._addTick_bound)}};TickBuffer.prototype._onTicks=function(err,ticks){if(err)throw new Error;if(!ticks)return;var mayGotNext=this.currentAge===this._nearestAbsentAge;var inserted=this.addTickList(ticks);if(mayGotNext&&(inserted.start<=this.currentAge&&this.currentAge<inserted.end)){this.gotNextTickTrigger.fire()}};TickBuffer.prototype._findNearestAbscentAge=function(age){var i=0,len=this._tickRanges.length;for(;i<len;++i){if(age<=this._tickRanges[i].end)break}for(;i<len;++i){var range=this._tickRanges[i];if(age<range.start)break;age=range.end}return age};TickBuffer.prototype._dropUntil=function(age){var i;for(i=0;i<this._tickRanges.length;++i){if(age<this._tickRanges[i].end)break}this._tickRanges=this._tickRanges.slice(i);if(this._tickRanges.length===0)return;var range=this._tickRanges[0];if(age<range.start)return;range.start=age;for(i=0;i<range.ticks.length;++i){if(age<=range.ticks[i][0])break}range.ticks=range.ticks.slice(i)};TickBuffer.prototype._createTickRangeFromTick=function(tick){var age=tick[0];var range={start:age,end:age+1,ticks:[]};if(tick[1]){range.ticks.push(tick)}return range};TickBuffer.DEFAULT_PREFETCH_THRESHOLD=30*60;TickBuffer.DEFAULT_SIZE_REQUEST_ONCE=30*60*5;return TickBuffer}();exports.TickBuffer=TickBuffer},{"./ExecutionMode":9,"@akashic/akashic-engine":1}],21:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.TickController=void 0;var g=require("@akashic/akashic-engine");var ExecutionMode_1=require("./ExecutionMode");var TickBuffer_1=require("./TickBuffer");var TickGenerator_1=require("./TickGenerator");var sr=require("./StorageResolver");var TickController=function(){function TickController(param){this.errorTrigger=new g.Trigger;if(param.errorHandler)this.errorTrigger.handle(param.errorHandlerOwner,param.errorHandler);this._amflow=param.amflow;this._clock=param.clock;this._started=false;this._executionMode=param.executionMode;this._generator=new TickGenerator_1.TickGenerator({amflow:param.amflow,eventBuffer:param.eventBuffer,errorHandler:this.errorTrigger.fire,errorHandlerOwner:this.errorTrigger});this._buffer=new TickBuffer_1.TickBuffer({amflow:param.amflow,executionMode:param.executionMode});this._storageResolver=new sr.StorageResolver({game:param.game,amflow:param.amflow,tickGenerator:this._generator,tickBuffer:this._buffer,executionMode:param.executionMode,errorHandler:this.errorTrigger.fire,errorHandlerOwner:this.errorTrigger});this._generator.tickTrigger.handle(this,this._onTickGenerated);this._clock.frameTrigger.handle(this._generator,this._generator.next)}TickController.prototype.startTick=function(){this._started=true;this._updateGeneratorState()};TickController.prototype.stopTick=function(){this._started=false;this._updateGeneratorState()};TickController.prototype.startTickOnce=function(){this._started=true;this._generator.tickTrigger.handle(this,this._stopTriggerOnTick);this._updateGeneratorState()};TickController.prototype.setNextAge=function(age){this._generator.setNextAge(age)};TickController.prototype.forceGenerateTick=function(){this._generator.forceNext()};TickController.prototype.getBuffer=function(){return this._buffer};TickController.prototype.storageFunc=function(){return{storageGetFunc:this._storageResolver.getStorageFunc,storagePutFunc:this._storageResolver.putStorageFunc,requestValuesForJoinFunc:this._storageResolver.requestValuesForJoinFunc}};TickController.prototype.setExecutionMode=function(execMode){if(this._executionMode===execMode)return;this._executionMode=execMode;this._updateGeneratorState();this._buffer.setExecutionMode(execMode);this._storageResolver.setExecutionMode(execMode)};TickController.prototype._stopTriggerOnTick=function(){this.stopTick();return true};TickController.prototype._updateGeneratorState=function(){var toGenerate=this._started&&this._executionMode===ExecutionMode_1.default.Active;this._generator.startStopGenerate(toGenerate)};TickController.prototype._onTickGenerated=function(tick){this._amflow.sendTick(tick);this._buffer.addTick(tick)};return TickController}();exports.TickController=TickController},{"./ExecutionMode":9,"./StorageResolver":19,"./TickBuffer":20,"./TickGenerator":22,"@akashic/akashic-engine":1}],22:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.TickGenerator=void 0;var g=require("@akashic/akashic-engine");var JoinResolver_1=require("./JoinResolver");var TickGenerator=function(){function TickGenerator(param){this.tickTrigger=new g.Trigger;this.gotStorageTrigger=new g.Trigger;this.errorTrigger=new g.Trigger;if(param.errorHandler)this.errorTrigger.handle(param.errorHandlerOwner,param.errorHandler);this._amflow=param.amflow;this._eventBuffer=param.eventBuffer;this._joinResolver=new JoinResolver_1.JoinResolver({amflow:param.amflow,errorHandler:this.errorTrigger.fire,errorHandlerOwner:this.errorTrigger});this._nextAge=0;this._storageDataForNext=null;this._generatingTick=false;this._waitingStorage=false;this._onGotStorageData_bound=this._onGotStorageData.bind(this)}TickGenerator.prototype.next=function(){if(!this._generatingTick||this._waitingStorage)return;var joinLeaves=this._eventBuffer.readJoinLeaves();if(joinLeaves){for(var i=0;i<joinLeaves.length;++i)this._joinResolver.request(joinLeaves[i])}var evs=this._eventBuffer.readEvents();var resolvedJoinLeaves=this._joinResolver.readResolved();if(resolvedJoinLeaves){if(evs){evs.push.apply(evs,resolvedJoinLeaves)}else{evs=resolvedJoinLeaves}}var sds=this._storageDataForNext;this._storageDataForNext=null;this.tickTrigger.fire([this._nextAge++,evs,sds])};TickGenerator.prototype.forceNext=function(){if(this._waitingStorage){this.errorTrigger.fire(new Error("TickGenerator#forceNext(): cannot generate tick while waiting storage."));return}var origValue=this._generatingTick;this._generatingTick=true;this.next();this._generatingTick=origValue};TickGenerator.prototype.startStopGenerate=function(toGenerate){this._generatingTick=toGenerate};TickGenerator.prototype.startTick=function(){this._generatingTick=true};TickGenerator.prototype.stopTick=function(){this._generatingTick=false};TickGenerator.prototype.setNextAge=function(age){if(this._waitingStorage){this.errorTrigger.fire(new Error("TickGenerator#setNextAge(): cannot change the next age while waiting storage."));return}this._nextAge=age};TickGenerator.prototype.requestStorageTick=function(keys){if(this._waitingStorage){var err=g.ExceptionFactory.createAssertionError("TickGenerator#requestStorageTick(): Unsupported: multiple storage request");this.errorTrigger.fire(err);return-1}this._waitingStorage=true;this._amflow.getStorageData(keys,this._onGotStorageData_bound);return this._nextAge};TickGenerator.prototype.setRequestValuesForJoin=function(keys){this._joinResolver.setRequestValuesForJoin(keys)};TickGenerator.prototype._onGotStorageData=function(err,sds){this._waitingStorage=false;if(err){this.errorTrigger.fire(err);return}this._storageDataForNext=sds;this.gotStorageTrigger.fire({age:this._nextAge,storageData:sds})};return TickGenerator}();exports.TickGenerator=TickGenerator},{"./JoinResolver":13,"@akashic/akashic-engine":1}],23:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports._cloneDeep=exports.MemoryAmflowClient=void 0;var MemoryAmflowClient=function(){function MemoryAmflowClient(param){this._playId=param.playId;this._putStorageDataSyncFunc=param.putStorageDataSyncFunc||function(){throw new Error("Implementation not given")};this._getStorageDataSyncFunc=param.getStorageDataSyncFunc||function(){throw new Error("Implementation not given")};this._tickHandlers=[];this._eventHandlers=[];this._events=[];this._tickList=null;if(param.startPoints){this._tickList=param.tickList;this._startPoints=param.startPoints}else{this._startPoints=[]}}MemoryAmflowClient.prototype.dump=function(){return{tickList:this._tickList,startPoints:this._startPoints}};MemoryAmflowClient.prototype.open=function(playId,callback){var _this=this;setTimeout(function(){if(playId!==_this._playId)return void callback(new Error("MemoryAmflowClient#open: unknown playId"));callback(null)},0)};MemoryAmflowClient.prototype.close=function(callback){setTimeout(function(){callback(null)},0)};MemoryAmflowClient.prototype.authenticate=function(token,callback){setTimeout(function(){switch(token){case MemoryAmflowClient.TOKEN_ACTIVE:callback(null,{writeTick:true,readTick:true,subscribeTick:false,sendEvent:false,subscribeEvent:true,maxEventPriority:2});break;case MemoryAmflowClient.TOKEN_PASSIVE:callback(null,{writeTick:false,readTick:true,subscribeTick:true,sendEvent:true,subscribeEvent:false,maxEventPriority:2});break;default:callback(null,{writeTick:true,readTick:true,subscribeTick:true,sendEvent:true,subscribeEvent:true,maxEventPriority:2});break}},0)};MemoryAmflowClient.prototype.sendTick=function(tick){tick=_cloneDeep(tick);if(!this._tickList){this._tickList=[tick[0],tick[0],[]]}else{if(this._tickList[0]<=tick[0]&&tick[0]<=this._tickList[1])throw new Error("illegal age tick");this._tickList[1]=tick[0]}if(!!tick[1]||!!tick[2]){this._tickList[2].push(tick)}this._tickHandlers.forEach(function(h){return h(tick)})};MemoryAmflowClient.prototype.onTick=function(handler){this._tickHandlers.push(handler)};MemoryAmflowClient.prototype.offTick=function(handler){this._tickHandlers=this._tickHandlers.filter(function(h){return h!==handler})};MemoryAmflowClient.prototype.sendEvent=function(pev){pev=_cloneDeep(pev);if(this._eventHandlers.length===0){this._events.push(pev);return}this._eventHandlers.forEach(function(h){return h(pev)})};MemoryAmflowClient.prototype.onEvent=function(handler){var _this=this;this._eventHandlers.push(handler);if(this._events.length>0){this._events.forEach(function(pev){_this._eventHandlers.forEach(function(h){return h(pev)})});this._events=[]}};MemoryAmflowClient.prototype.offEvent=function(handler){this._eventHandlers=this._eventHandlers.filter(function(h){return h!==handler})};MemoryAmflowClient.prototype.getTickList=function(optsOrBegin,endOrCallback,callback){if(!this._tickList)return void setTimeout(function(){return callback(null,null)},0);if(typeof optsOrBegin!=="number"||typeof endOrCallback!=="number"||typeof callback!=="function"){if(typeof endOrCallback==="function"){endOrCallback(new Error("not implemented"));return}throw new Error("not implemented")}var from=Math.max(optsOrBegin,this._tickList[0]);var to=Math.min(endOrCallback,this._tickList[1]);var ticks=this._tickList[2].filter(function(tick){var age=tick[0];return from<=age&&age<=to});var tickList=[from,to,ticks];setTimeout(function(){return callback(null,tickList)},0)};MemoryAmflowClient.prototype.putStartPoint=function(startPoint,callback){var _this=this;setTimeout(function(){_this._startPoints.push(startPoint);callback(null)},0)};MemoryAmflowClient.prototype.getStartPoint=function(opts,callback){var _this=this;setTimeout(function(){if(!_this._startPoints||_this._startPoints.length===0)return void callback(new Error("no startpoint"));var index=0;if(opts.frame!=null){var nearestFrame=_this._startPoints[0].frame;for(var i=1;i<_this._startPoints.length;++i){var frame=_this._startPoints[i].frame;if(frame<=opts.frame&&nearestFrame<frame){nearestFrame=frame;index=i}}}else{var nearestTimestamp=_this._startPoints[0].timestamp;for(var i=1;i<_this._startPoints.length;++i){var timestamp=_this._startPoints[i].timestamp;if(timestamp<=opts.timestamp&&nearestTimestamp<timestamp){nearestTimestamp=timestamp;index=i}}}callback(null,_this._startPoints[index])},0)};MemoryAmflowClient.prototype.putStorageData=function(key,value,options,callback){var _this=this;setTimeout(function(){try{_this._putStorageDataSyncFunc(key,value,options);callback(null)}catch(e){callback(e)}},0)};MemoryAmflowClient.prototype.getStorageData=function(keys,callback){var _this=this;setTimeout(function(){try{var data=_this._getStorageDataSyncFunc(keys);callback(null,data)}catch(e){callback(e)}},0)};MemoryAmflowClient.prototype.dropAfter=function(age){if(!this._tickList)return;var from=this._tickList[0];var to=this._tickList[1];if(age<=from){this._tickList=null;this._startPoints=[]}else if(age<=to){this._tickList[1]=age-1;this._tickList[2]=this._tickList[2].filter(function(tick){var ta=tick[0];return from<=ta&&ta<=age-1});this._startPoints=this._startPoints.filter(function(sp){return sp.frame<age})}};MemoryAmflowClient.TOKEN_ACTIVE="mamfc-token:active";MemoryAmflowClient.TOKEN_PASSIVE="mamfc-token:passive";return MemoryAmflowClient}();exports.MemoryAmflowClient=MemoryAmflowClient;function _cloneDeep(v){if(v&&typeof v==="object"){if(Array.isArray(v)){return v.map(_cloneDeep)}else{return Object.keys(v).reduce(function(acc,k){return acc[k]=_cloneDeep(v[k]),acc},{})}}return v}exports._cloneDeep=_cloneDeep},{}],24:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.ReplayAmflowProxy=void 0;var ReplayAmflowProxy=function(){function ReplayAmflowProxy(param){this._amflow=param.amflow;this._tickList=param.tickList;this._startPoints=param.startPoints}ReplayAmflowProxy.prototype.dropAfter=function(age){if(!this._tickList)return;var givenFrom=this._tickList[0];var givenTo=this._tickList[1];var givenTicksWithEvents=this._tickList[2];if(age<=givenFrom){this._tickList=null;this._startPoints=[]}else if(age<=givenTo){this._tickList[1]=age-1;this._tickList[2]=this._sliceTicks(givenTicksWithEvents,givenTo,age-1);this._startPoints=this._startPoints.filter(function(sp){return sp.frame<age})}};ReplayAmflowProxy.prototype.open=function(playId,callback){this._amflow.open(playId,callback)};ReplayAmflowProxy.prototype.close=function(callback){this._amflow.close(callback)};ReplayAmflowProxy.prototype.authenticate=function(token,callback){this._amflow.authenticate(token,callback)};ReplayAmflowProxy.prototype.sendTick=function(tick){this._amflow.sendTick(tick)};ReplayAmflowProxy.prototype.onTick=function(handler){this._amflow.onTick(handler)};ReplayAmflowProxy.prototype.offTick=function(handler){this._amflow.offTick(handler)};ReplayAmflowProxy.prototype.sendEvent=function(event){this._amflow.sendEvent(event)};ReplayAmflowProxy.prototype.onEvent=function(handler){this._amflow.onEvent(handler)};ReplayAmflowProxy.prototype.offEvent=function(handler){this._amflow.offEvent(handler)};ReplayAmflowProxy.prototype.getTickList=function(optsOrBegin,endOrCallback,callback){var _this=this;if(typeof optsOrBegin!=="number"||typeof endOrCallback!=="number"||typeof callback!=="function"){if(typeof endOrCallback==="function"){endOrCallback(new Error("not implemented"));return}throw new Error("not implemented")}var from=optsOrBegin;var to=endOrCallback;var givenFrom=this._tickList[0];var givenTo=this._tickList[1];var givenTicksWithEvents=this._tickList[2];var fromInGiven=givenFrom<=from&&from<=givenTo;var toInGiven=givenFrom<=to&&to<=givenTo;if(fromInGiven&&toInGiven){setTimeout(function(){callback(null,[from,to,_this._sliceTicks(givenTicksWithEvents,from,to)])},0)}else{this._amflow.getTickList(from,to,function(err,tickList){if(err)return void callback(err);if(!tickList){if(!fromInGiven&&!toInGiven){if(to<givenFrom||givenTo<from){callback(null,tickList)}else{callback(null,[givenFrom,givenTo,_this._sliceTicks(givenTicksWithEvents,from,to)])}}else if(fromInGiven){callback(null,[from,givenTo,_this._sliceTicks(givenTicksWithEvents,from,to)])}else{callback(null,[givenFrom,to,_this._sliceTicks(givenTicksWithEvents,from,to)])}}else{if(!fromInGiven&&!toInGiven){if(to<givenFrom||givenTo<from){callback(null,tickList)}else{var ticksWithEvents=tickList[2];if(ticksWithEvents){var beforeGiven=_this._sliceTicks(ticksWithEvents,from,givenFrom-1);var afterGiven=_this._sliceTicks(ticksWithEvents,givenTo+1,to);ticksWithEvents=beforeGiven.concat(givenTicksWithEvents,afterGiven)}else{ticksWithEvents=givenTicksWithEvents}callback(null,[from,to,ticksWithEvents])}}else if(fromInGiven){var ticksWithEvents=_this._sliceTicks(givenTicksWithEvents,from,to).concat(tickList[2]||[]);callback(null,[from,tickList[1],ticksWithEvents])}else{var ticksWithEvents=(tickList[2]||[]).concat(_this._sliceTicks(givenTicksWithEvents,from,to));callback(null,[tickList[0],to,ticksWithEvents])}}})}};ReplayAmflowProxy.prototype.putStartPoint=function(startPoint,callback){this._amflow.putStartPoint(startPoint,callback)};ReplayAmflowProxy.prototype.getStartPoint=function(opts,callback){var _this=this;var index=0;if(this._startPoints.length>0){if(opts.frame!=null){var nearestFrame=this._startPoints[0].frame;for(var i=1;i<this._startPoints.length;++i){var frame=this._startPoints[i].frame;if(frame<=opts.frame&&nearestFrame<frame){nearestFrame=frame;index=i}}}else{var nearestTimestamp=this._startPoints[0].timestamp;for(var i=1;i<this._startPoints.length;++i){var timestamp=this._startPoints[i].timestamp;if(timestamp<=opts.timestamp&&nearestTimestamp<timestamp){nearestTimestamp=timestamp;index=i}}}}var givenTo=this._tickList?this._tickList[1]:-1;if(opts.frame>givenTo){this._amflow.getStartPoint(opts,function(err,startPoint){if(err){callback(err);return}if(givenTo<startPoint.frame){callback(null,startPoint)}else{callback(null,_this._startPoints[index])}})}else{setTimeout(function(){callback(null,_this._startPoints[index])},0)}};ReplayAmflowProxy.prototype.putStorageData=function(key,value,options,callback){this._amflow.putStorageData(key,value,options,callback)};ReplayAmflowProxy.prototype.getStorageData=function(keys,callback){this._amflow.getStorageData(keys,callback)};ReplayAmflowProxy.prototype._sliceTicks=function(ticks,from,to){return ticks.filter(function(t){var age=t[0];return from<=age&&age<=to})};return ReplayAmflowProxy}();exports.ReplayAmflowProxy=ReplayAmflowProxy},{}],25:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.SimpleProfiler=void 0;var g=require("@akashic/akashic-engine");var SimpleProfiler=function(){function SimpleProfiler(param){this._interval=param.interval!=null?param.interval:SimpleProfiler.DEFAULT_INTERVAL;if(param.limit!=null){this._limit=param.limit>=SimpleProfiler.DEFAULT_LIMIT?param.limit:SimpleProfiler.DEFAULT_LIMIT}else{this._limit=SimpleProfiler.DEFAULT_LIMIT}this._calculateProfilerValueTrigger=new g.Trigger;if(param.getValueHandler){this._calculateProfilerValueTrigger.handle(param.getValueHandlerOwner,param.getValueHandler)}this._reset()}SimpleProfiler.prototype.time=function(type){this._beforeTimes[type]=this._getCurrentTime()};SimpleProfiler.prototype.timeEnd=function(type){var now=this._getCurrentTime();var value=this._beforeTimes[type]!=null?now-this._beforeTimes[type]:0;this._values[type].push({time:now,value:value})};SimpleProfiler.prototype.flush=function(){var now=this._getCurrentTime();if(this._beforeFlushTime===0)this._beforeFlushTime=now;if(this._beforeFlushTime+this._interval<now){this._calculateProfilerValueTrigger.fire(this.getProfilerValue(this._interval));this._beforeFlushTime=now}if(this._values[1].length>this._limit){for(var i in this._values){if(this._values.hasOwnProperty(i))this._values[i]=this._values[i].slice(-SimpleProfiler.BACKUP_MARGIN)}}};SimpleProfiler.prototype.setValue=function(type,value){this._values[type].push({time:this._getCurrentTime(),value:value})};SimpleProfiler.prototype.getProfilerValue=function(time){var rawFrameInterval=this._calculateProfilerValue(1,time);return{skippedFrameCount:this._calculateProfilerValue(0,time),rawFrameInterval:rawFrameInterval,framePerSecond:{ave:1e3/rawFrameInterval.ave,max:1e3/rawFrameInterval.min,min:1e3/rawFrameInterval.max},frameTime:this._calculateProfilerValue(2,time),renderingTime:this._calculateProfilerValue(3,time)}};SimpleProfiler.prototype._reset=function(){this._startTime=this._getCurrentTime();this._beforeFlushTime=0;this._beforeTimes=[];this._beforeTimes[1]=0;this._beforeTimes[2]=0;this._beforeTimes[3]=0;this._beforeTimes[0]=0;this._values=[];this._values[1]=[];this._values[2]=[];this._values[3]=[];this._values[0]=[]};SimpleProfiler.prototype._calculateProfilerValue=function(type,time){var limit=this._getCurrentTime()-time;var sum=0;var num=0;var max=0;var min=Number.MAX_VALUE;for(var i=this._values[type].length-1;i>=0;--i){if(0<num&&this._values[type][i].time<limit)break;var value=this._values[type][i].value;if(max<value)max=value;if(value<min)min=value;sum+=value;++num}return{ave:sum/num,max:max,min:min}};SimpleProfiler.prototype._getCurrentTime=function(){return+new Date};SimpleProfiler.DEFAULT_INTERVAL=1e3;SimpleProfiler.DEFAULT_LIMIT=1e3;SimpleProfiler.BACKUP_MARGIN=100;return SimpleProfiler}();exports.SimpleProfiler=SimpleProfiler},{"@akashic/akashic-engine":1}],26:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.SimpleProfiler=exports.MemoryAmflowClient=exports.ReplayAmflowProxy=exports.Game=exports.GameDriver=exports.ExecutionMode=exports.LoopRenderMode=exports.LoopMode=exports.EventIndex=void 0;var EventIndex=require("./EventIndex");exports.EventIndex=EventIndex;var LoopMode_1=require("./LoopMode");exports.LoopMode=LoopMode_1.default;var LoopRenderMode_1=require("./LoopRenderMode");exports.LoopRenderMode=LoopRenderMode_1.default;var ExecutionMode_1=require("./ExecutionMode");exports.ExecutionMode=ExecutionMode_1.default;var GameDriver_1=require("./GameDriver");Object.defineProperty(exports,"GameDriver",{enumerable:true,get:function(){return GameDriver_1.GameDriver}});var Game_1=require("./Game");Object.defineProperty(exports,"Game",{enumerable:true,get:function(){return Game_1.Game}});var ReplayAmflowProxy_1=require("./auxiliary/ReplayAmflowProxy");Object.defineProperty(exports,"ReplayAmflowProxy",{enumerable:true,get:function(){return ReplayAmflowProxy_1.ReplayAmflowProxy}});var MemoryAmflowClient_1=require("./auxiliary/MemoryAmflowClient");Object.defineProperty(exports,"MemoryAmflowClient",{enumerable:true,get:function(){return MemoryAmflowClient_1.MemoryAmflowClient}});var SimpleProfiler_1=require("./auxiliary/SimpleProfiler");Object.defineProperty(exports,"SimpleProfiler",{enumerable:true,get:function(){return SimpleProfiler_1.SimpleProfiler}})},{"./EventIndex":8,"./ExecutionMode":9,"./Game":10,"./GameDriver":11,"./LoopMode":14,"./LoopRenderMode":15,"./auxiliary/MemoryAmflowClient":23,"./auxiliary/ReplayAmflowProxy":24,"./auxiliary/SimpleProfiler":25}],27:[function(require,module,exports){arguments[4][4][0].apply(exports,arguments)},{"./lib/index":47,dup:4}],28:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.AudioManager=void 0;var AudioManager=function(){function AudioManager(){this.audioAssets=[];this._masterVolume=1}AudioManager.prototype.registerAudioAsset=function(asset){if(this.audioAssets.indexOf(asset)===-1)this.audioAssets.push(asset)};AudioManager.prototype.removeAudioAsset=function(asset){var index=this.audioAssets.indexOf(asset);if(index===-1)this.audioAssets.splice(index,1)};AudioManager.prototype.setMasterVolume=function(volume){this._masterVolume=volume;for(var i=0;i<this.audioAssets.length;i++){if(this.audioAssets[i]._lastPlayedPlayer){this.audioAssets[i]._lastPlayedPlayer.notifyMasterVolumeChanged()}}};AudioManager.prototype.getMasterVolume=function(){return this._masterVolume};return AudioManager}();exports.AudioManager=AudioManager},{}],29:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.ContainerController=void 0;var g=require("@akashic/akashic-engine");var RenderingHelper_1=require("./canvas/RenderingHelper");var InputHandlerLayer_1=require("./InputHandlerLayer");var ContainerController=function(){function ContainerController(){this.container=null;this.surface=null;this.inputHandlerLayer=null;this.rootView=null;this.useResizeForScaling=false;this.pointEventTrigger=new g.Trigger;this._rendererReq=null;this._disablePreventDefault=false}ContainerController.prototype.initialize=function(param){this._rendererReq=param.rendererRequirement;this._disablePreventDefault=!!param.disablePreventDefault;this._loadView()};ContainerController.prototype.setRootView=function(rootView){if(rootView===this.rootView){return}if(this.rootView){this.unloadView();this._loadView()}this.rootView=rootView;this._appendToRootView(rootView)};ContainerController.prototype.resetView=function(rendererReq){this.unloadView();this._rendererReq=rendererReq;this._loadView();this._appendToRootView(this.rootView)};ContainerController.prototype.getRenderer=function(){if(!this.surface){throw new Error("this container has no surface")}return this.surface.renderer()};ContainerController.prototype.changeScale=function(xScale,yScale){if(this.useResizeForScaling){this.surface.changePhysicalScale(xScale,yScale)}else{this.surface.changeVisualScale(xScale,yScale)}this.inputHandlerLayer._inputHandler.setScale(xScale,yScale)};ContainerController.prototype.unloadView=function(){this.inputHandlerLayer.disablePointerEvent();if(this.rootView){while(this.rootView.firstChild){this.rootView.removeChild(this.rootView.firstChild)}}};ContainerController.prototype._loadView=function(){var _a=this._rendererReq,width=_a.primarySurfaceWidth,height=_a.primarySurfaceHeight,rc=_a.rendererCandidates;var disablePreventDefault=this._disablePreventDefault;this.container=document.createDocumentFragment();if(!this.inputHandlerLayer){this.inputHandlerLayer=new InputHandlerLayer_1.InputHandlerLayer({width:width,height:height,disablePreventDefault:disablePreventDefault})}else{this.inputHandlerLayer.setViewSize({width:width,height:height});this.inputHandlerLayer.pointEventTrigger._reset();this.inputHandlerLayer.view.removeChild(this.surface.canvas);this.surface.destroy()}this.surface=RenderingHelper_1.RenderingHelper.createPrimarySurface(width,height,rc);this.inputHandlerLayer.view.appendChild(this.surface.getHTMLElement());this.container.appendChild(this.inputHandlerLayer.view)};ContainerController.prototype._appendToRootView=function(rootView){rootView.appendChild(this.container);this.inputHandlerLayer.enablePointerEvent();this.inputHandlerLayer.pointEventTrigger.handle(this.pointEventTrigger,this.pointEventTrigger.fire)};return ContainerController}();exports.ContainerController=ContainerController},{"./InputHandlerLayer":30,"./canvas/RenderingHelper":42,"@akashic/akashic-engine":1}],30:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.InputHandlerLayer=void 0;var g=require("@akashic/akashic-engine");var TouchHandler_1=require("./handler/TouchHandler");var InputHandlerLayer=function(){function InputHandlerLayer(param){this.view=this._createInputView(param.width,param.height);this._inputHandler=undefined;this.pointEventTrigger=new g.Trigger;this._disablePreventDefault=!!param.disablePreventDefault}InputHandlerLayer.prototype.enablePointerEvent=function(){var _this=this;this._inputHandler=new TouchHandler_1.TouchHandler(this.view,this._disablePreventDefault);this._inputHandler.pointTrigger.handle(function(e){_this.pointEventTrigger.fire(e)});this._inputHandler.start()};InputHandlerLayer.prototype.disablePointerEvent=function(){if(this._inputHandler)this._inputHandler.stop()};InputHandlerLayer.prototype.setOffset=function(offset){var inputViewStyle="position:relative; left:"+offset.x+"px; top:"+offset.y+"px";this._inputHandler.inputView.setAttribute("style",inputViewStyle)};InputHandlerLayer.prototype.setViewSize=function(size){var view=this.view;view.style.width=size.width+"px";view.style.height=size.height+"px"};InputHandlerLayer.prototype._createInputView=function(width,height){var view=document.createElement("div");view.setAttribute("tabindex","1");view.className="input-handler";view.setAttribute("style","display:inline-block; outline:none;");view.style.width=width+"px";view.style.height=height+"px";return view};return InputHandlerLayer}();exports.InputHandlerLayer=InputHandlerLayer},{"./handler/TouchHandler":46,"@akashic/akashic-engine":1}],31:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.Platform=void 0;var RafLooper_1=require("./RafLooper");var ResourceFactory_1=require("./ResourceFactory");var ContainerController_1=require("./ContainerController");var AudioPluginManager_1=require("./plugin/AudioPluginManager");var AudioManager_1=require("./AudioManager");var AudioPluginRegistry_1=require("./plugin/AudioPluginRegistry");var XHRTextAsset_1=require("./asset/XHRTextAsset");var Platform=function(){function Platform(param){this.containerView=param.containerView;this.containerController=new ContainerController_1.ContainerController;this.audioPluginManager=new AudioPluginManager_1.AudioPluginManager;if(param.audioPlugins){this.audioPluginManager.tryInstallPlugin(param.audioPlugins)}this.audioPluginManager.tryInstallPlugin(AudioPluginRegistry_1.AudioPluginRegistry.getRegisteredAudioPlugins());this._audioManager=new AudioManager_1.AudioManager;this.amflow=param.amflow;this._platformEventHandler=null;this._resourceFactory=param.resourceFactory||new ResourceFactory_1.ResourceFactory({audioPluginManager:this.audioPluginManager,platform:this,audioManager:this._audioManager});this._rendererReq=null;this._disablePreventDefault=!!param.disablePreventDefault}Platform.prototype.setPlatformEventHandler=function(handler){if(this.containerController){this.containerController.pointEventTrigger.removeAll(this._platformEventHandler);this.containerController.pointEventTrigger.handle(handler,handler.onPointEvent)}this._platformEventHandler=handler};Platform.prototype.loadGameConfiguration=function(url,callback){var a=new XHRTextAsset_1.XHRTextAsset("(game.json)",url);a._load({_onAssetLoad:function(asset){callback(null,JSON.parse(a.data))},_onAssetError:function(asset,error){callback(error,null)}})};Platform.prototype.getResourceFactory=function(){return this._resourceFactory};Platform.prototype.setRendererRequirement=function(requirement){if(!requirement){if(this.containerController)this.containerController.unloadView();return}this._rendererReq=requirement;this._resourceFactory._rendererCandidates=this._rendererReq.rendererCandidates;if(this.containerController&&!this.containerController.inputHandlerLayer){this.containerController.initialize({rendererRequirement:requirement,disablePreventDefault:this._disablePreventDefault});this.containerController.setRootView(this.containerView);if(this._platformEventHandler){this.containerController.pointEventTrigger.handle(this._platformEventHandler,this._platformEventHandler.onPointEvent)}}else{var surface=this.getPrimarySurface();if(surface&&!surface.destroyed())surface.destroy();this.containerController.resetView(requirement)}};Platform.prototype.getPrimarySurface=function(){return this.containerController.surface};Platform.prototype.getOperationPluginViewInfo=function(){var _this=this;return{type:"pdi-browser",view:this.containerController.inputHandlerLayer.view,getScale:function(){return _this.containerController.inputHandlerLayer._inputHandler.getScale()}}};Platform.prototype.createLooper=function(fun){return new RafLooper_1.RafLooper(fun)};Platform.prototype.sendToExternal=function(playId,data){};Platform.prototype.registerAudioPlugins=function(plugins){return this.audioPluginManager.tryInstallPlugin(plugins)};Platform.prototype.setScale=function(xScale,yScale){this.containerController.changeScale(xScale,yScale)};Platform.prototype.notifyViewMoved=function(){};Platform.prototype.setMasterVolume=function(volume){if(this._audioManager)this._audioManager.setMasterVolume(volume)};Platform.prototype.getMasterVolume=function(){if(this._audioManager)return this._audioManager.getMasterVolume()};Platform.prototype.destroy=function(){this.setRendererRequirement(undefined);this.setMasterVolume(0)};return Platform}();exports.Platform=Platform},{"./AudioManager":28,"./ContainerController":29,"./RafLooper":32,"./ResourceFactory":33,"./asset/XHRTextAsset":38,"./plugin/AudioPluginManager":48,"./plugin/AudioPluginRegistry":49}],32:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.RafLooper=void 0;var RafLooper=function(){function RafLooper(fun){this._fun=fun;this._timerId=undefined;this._prev=0}RafLooper.prototype.start=function(){var _this=this;var onAnimationFrame=function(deltaTime){if(_this._timerId==null){return}_this._timerId=requestAnimationFrame(onAnimationFrame);_this._fun(deltaTime-_this._prev);_this._prev=deltaTime};var onFirstFrame=function(deltaTime){_this._timerId=requestAnimationFrame(onAnimationFrame);_this._fun(0);_this._prev=deltaTime};this._timerId=requestAnimationFrame(onFirstFrame)};RafLooper.prototype.stop=function(){cancelAnimationFrame(this._timerId);this._timerId=undefined;this._prev=0};return RafLooper}();exports.RafLooper=RafLooper},{}],33:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:true});exports.ResourceFactory=void 0;var g=require("@akashic/akashic-engine");var HTMLImageAsset_1=require("./asset/HTMLImageAsset");var HTMLVideoAsset_1=require("./asset/HTMLVideoAsset");var XHRTextAsset_1=require("./asset/XHRTextAsset");var XHRScriptAsset_1=require("./asset/XHRScriptAsset");var RenderingHelper_1=require("./canvas/RenderingHelper");var GlyphFactory_1=require("./canvas/GlyphFactory");var ResourceFactory=function(_super){__extends(ResourceFactory,_super);function ResourceFactory(param){var _this=_super.call(this)||this;_this._audioPluginManager=param.audioPluginManager;_this._audioManager=param.audioManager;_this._platform=param.platform;return _this}ResourceFactory.prototype.createAudioAsset=function(id,assetPath,duration,system,loop,hint){var activePlugin=this._audioPluginManager.getActivePlugin();var audioAsset=activePlugin.createAsset(id,assetPath,duration,system,loop,hint);if(audioAsset.onDestroyed){this._audioManager.registerAudioAsset(audioAsset);audioAsset.onDestroyed.handle(this,this._onAudioAssetDestroyed)}return audioAsset};ResourceFactory.prototype.createAudioPlayer=function(system){var activePlugin=this._audioPluginManager.getActivePlugin();return activePlugin.createPlayer(system,this._audioManager)};ResourceFactory.prototype.createImageAsset=function(id,assetPath,width,height){return new HTMLImageAsset_1.HTMLImageAsset(id,assetPath,width,height)};ResourceFactory.prototype.createVideoAsset=function(id,assetPath,width,height,system,loop,useRealSize){return new HTMLVideoAsset_1.HTMLVideoAsset(id,assetPath,width,height,system,loop,useRealSize)};ResourceFactory.prototype.createTextAsset=function(id,assetPath){return new XHRTextAsset_1.XHRTextAsset(id,assetPath)};ResourceFactory.prototype.createScriptAsset=function(id,assetPath){return new XHRScriptAsset_1.XHRScriptAsset(id,assetPath)};ResourceFactory.prototype.createSurface=function(width,height){return RenderingHelper_1.RenderingHelper.createBackSurface(width,height,this._platform,this._rendererCandidates)};ResourceFactory.prototype.createGlyphFactory=function(fontFamily,fontSize,baseline,fontColor,strokeWidth,strokeColor,strokeOnly,fontWeight){return new GlyphFactory_1.GlyphFactory(fontFamily,fontSize,baseline,fontColor,strokeWidth,strokeColor,strokeOnly,fontWeight)};ResourceFactory.prototype._onAudioAssetDestroyed=function(asset){this._audioManager.removeAudioAsset(asset)};return ResourceFactory}(g.ResourceFactory);exports.ResourceFactory=ResourceFactory},{"./asset/HTMLImageAsset":34,"./asset/HTMLVideoAsset":35,"./asset/XHRScriptAsset":37,"./asset/XHRTextAsset":38,"./canvas/GlyphFactory":41,"./canvas/RenderingHelper":42,"@akashic/akashic-engine":1}],34:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:true});exports.HTMLImageAsset=exports.ImageAssetSurface=void 0;var g=require("@akashic/akashic-engine");var ImageAssetSurface=function(_super){__extends(ImageAssetSurface,_super);function ImageAssetSurface(width,height,drawable){return _super.call(this,width,height,drawable)||this}ImageAssetSurface.prototype.renderer=function(){throw g.ExceptionFactory.createAssertionError("ImageAssetSurface cannot be rendered.")};ImageAssetSurface.prototype.isPlaying=function(){return false};return ImageAssetSurface}(g.Surface);exports.ImageAssetSurface=ImageAssetSurface;var HTMLImageAsset=function(_super){__extends(HTMLImageAsset,_super);function HTMLImageAsset(id,path,width,height){var _this=_super.call(this,id,path,width,height)||this;_this.data=undefined;_this._surface=undefined;return _this}HTMLImageAsset.prototype.destroy=function(){if(this._surface&&!this._surface.destroyed()){this._surface.destroy()}this.data=undefined;this._surface=undefined;_super.prototype.destroy.call(this)};HTMLImageAsset.prototype._load=function(loader){var _this=this;var image=new Image;image.onerror=function(){loader._onAssetError(_this,g.ExceptionFactory.createAssetLoadError("HTMLImageAsset unknown loading error"))};image.onload=function(){_this.data=image;loader._onAssetLoad(_this)};image.src=this.path};HTMLImageAsset.prototype.asSurface=function(){if(!this.data){throw g.ExceptionFactory.createAssertionError("ImageAssetImpl#asSurface: not yet loaded.")}if(this._surface){return this._surface}this._surface=new ImageAssetSurface(this.width,this.height,this.data);return this._surface};return HTMLImageAsset}(g.ImageAsset);exports.HTMLImageAsset=HTMLImageAsset},{"@akashic/akashic-engine":1}],35:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:true});exports.HTMLVideoAsset=void 0;var g=require("@akashic/akashic-engine");var HTMLVideoPlayer_1=require("./HTMLVideoPlayer");var VideoAssetSurface=function(_super){__extends(VideoAssetSurface,_super);function VideoAssetSurface(width,height,drawable){return _super.call(this,width,height,drawable,true)||this}VideoAssetSurface.prototype.renderer=function(){throw g.ExceptionFactory.createAssertionError("VideoAssetSurface cannot be rendered.")};VideoAssetSurface.prototype.isPlaying=function(){return false};return VideoAssetSurface}(g.Surface);var HTMLVideoAsset=function(_super){__extends(HTMLVideoAsset,_super);function HTMLVideoAsset(id,assetPath,width,height,system,loop,useRealSize){var _this=_super.call(this,id,assetPath,width,height,system,loop,useRealSize)||this;_this._player=new HTMLVideoPlayer_1.HTMLVideoPlayer;_this._surface=new VideoAssetSurface(width,height,null);return _this}HTMLVideoAsset.prototype.inUse=function(){return false};HTMLVideoAsset.prototype._load=function(loader){var _this=this;setTimeout(function(){loader._onAssetLoad(_this)},0)};HTMLVideoAsset.prototype.getPlayer=function(){return this._player};HTMLVideoAsset.prototype.asSurface=function(){return this._surface};return HTMLVideoAsset}(g.VideoAsset);exports.HTMLVideoAsset=HTMLVideoAsset},{"./HTMLVideoPlayer":36,"@akashic/akashic-engine":1}],36:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:true});exports.HTMLVideoPlayer=void 0;var g=require("@akashic/akashic-engine");var HTMLVideoPlayer=function(_super){__extends(HTMLVideoPlayer,_super);function HTMLVideoPlayer(loop){var _this=_super.call(this,loop)||this;_this.isDummy=true;return _this}HTMLVideoPlayer.prototype.play=function(videoAsset){};HTMLVideoPlayer.prototype.stop=function(){};HTMLVideoPlayer.prototype.changeVolume=function(volume){};return HTMLVideoPlayer}(g.VideoPlayer);exports.HTMLVideoPlayer=HTMLVideoPlayer},{"@akashic/akashic-engine":1}],37:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:true});exports.XHRScriptAsset=void 0;var g=require("@akashic/akashic-engine");var XHRLoader_1=require("../utils/XHRLoader");var XHRScriptAsset=function(_super){__extends(XHRScriptAsset,_super);function XHRScriptAsset(id,path){var _this=_super.call(this,id,path)||this;_this.script=undefined;return _this}XHRScriptAsset.prototype._load=function(handler){var _this=this;var loader=new XHRLoader_1.XHRLoader;loader.get(this.path,function(error,responseText){if(error){handler._onAssetError(_this,error);return}_this.script=responseText+"\n";handler._onAssetLoad(_this)})};XHRScriptAsset.prototype.execute=function(execEnv){var func=this._wrap();func(execEnv);return execEnv.module.exports};XHRScriptAsset.prototype._wrap=function(){var func=new Function("g",XHRScriptAsset.PRE_SCRIPT+this.script+XHRScriptAsset.POST_SCRIPT);return func};XHRScriptAsset.PRE_SCRIPT="(function(exports, require, module, __filename, __dirname) {";XHRScriptAsset.POST_SCRIPT="\n})(g.module.exports, g.module.require, g.module, g.filename, g.dirname);";return XHRScriptAsset}(g.ScriptAsset);exports.XHRScriptAsset=XHRScriptAsset},{"../utils/XHRLoader":62,"@akashic/akashic-engine":1}],38:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:true});exports.XHRTextAsset=void 0;var g=require("@akashic/akashic-engine");var XHRLoader_1=require("../utils/XHRLoader");var XHRTextAsset=function(_super){__extends(XHRTextAsset,_super);function XHRTextAsset(id,path){var _this=_super.call(this,id,path)||this;_this.data=undefined;return _this}XHRTextAsset.prototype._load=function(handler){var _this=this;var loader=new XHRLoader_1.XHRLoader;loader.get(this.path,function(error,responseText){if(error){handler._onAssetError(_this,error);return}_this.data=responseText;handler._onAssetLoad(_this)})};return XHRTextAsset}(g.TextAsset);exports.XHRTextAsset=XHRTextAsset},{"../utils/XHRLoader":62,"@akashic/akashic-engine":1}],39:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:true});exports.CanvasSurface=void 0;var g=require("@akashic/akashic-engine");var Context2DRenderer_1=require("./Context2DRenderer");var CanvasSurface=function(_super){__extends(CanvasSurface,_super);function CanvasSurface(width,height){var _this=this;var canvas=document.createElement("canvas");_this=_super.call(this,width,height,canvas)||this;canvas.width=width;canvas.height=height;_this.canvas=canvas;_this._context=canvas.getContext("2d");_this._renderer=undefined;return _this}CanvasSurface.prototype.destroy=function(){this.canvas.width=1;this.canvas.height=1;this.canvas=null;this._renderer=null;_super.prototype.destroy.call(this)};CanvasSurface.prototype.renderer=function(){if(!this._renderer){this._renderer=new Context2DRenderer_1.Context2DRenderer(this,this._context)}return this._renderer};CanvasSurface.prototype.getHTMLElement=function(){return this.canvas};CanvasSurface.prototype.changePhysicalScale=function(xScale,yScale){this.canvas.width=this.width*xScale;this.canvas.height=this.height*yScale;this._context.scale(xScale,yScale)};CanvasSurface.prototype.changeVisualScale=function(xScale,yScale){var canvasStyle=this.canvas.style;if("transform"in canvasStyle){canvasStyle.transformOrigin="0 0";canvasStyle.transform="scale("+xScale+","+yScale+")"}else if("webkitTransform"in canvasStyle){canvasStyle.webkitTransformOrigin="0 0";canvasStyle.webkitTransform="scale("+xScale+","+yScale+")"}else{canvasStyle.width=Math.floor(xScale*this.width)+"px";canvasStyle.height=Math.floor(yScale*this.width)+"px"}};CanvasSurface.prototype.isPlaying=function(){throw g.ExceptionFactory.createAssertionError("CanvasSurface#isPlaying() is not implemented")};return CanvasSurface}(g.Surface);exports.CanvasSurface=CanvasSurface},{"./Context2DRenderer":40,"@akashic/akashic-engine":1}],40:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:true});exports.Context2DRenderer=void 0;var g=require("@akashic/akashic-engine");var RenderingHelper_1=require("./RenderingHelper");var Context2DRenderer=function(_super){__extends(Context2DRenderer,_super);function Context2DRenderer(surface,context){var _this=_super.call(this)||this;_this.surface=surface;_this.context=context;return _this}Context2DRenderer.prototype.clear=function(){this.context.clearRect(0,0,this.surface.width,this.surface.height)};Context2DRenderer.prototype.drawImage=function(surface,offsetX,offsetY,width,height,canvasOffsetX,canvasOffsetY){this.context.drawImage(surface._drawable,offsetX,offsetY,width,height,canvasOffsetX,canvasOffsetY,width,height)};Context2DRenderer.prototype.drawSprites=function(surface,offsetX,offsetY,width,height,canvasOffsetX,canvasOffsetY,count){for(var i=0;i<count;++i){this.drawImage(surface,offsetX[i],offsetY[i],width[i],height[i],canvasOffsetX[i],canvasOffsetY[i])}};Context2DRenderer.prototype.drawSystemText=function(text,x,y,maxWidth,fontSize,textAlign,textBaseline,textColor,fontFamily,strokeWidth,strokeColor,strokeOnly){RenderingHelper_1.RenderingHelper.drawSystemTextByContext2D(this.context,text,x,y,maxWidth,fontSize,textAlign,textBaseline,textColor,fontFamily,strokeWidth,strokeColor,strokeOnly)};Context2DRenderer.prototype.translate=function(x,y){this.context.translate(x,y)};Context2DRenderer.prototype.transform=function(matrix){this.context.transform.apply(this.context,matrix)};Context2DRenderer.prototype.opacity=function(opacity){this.context.globalAlpha*=opacity};Context2DRenderer.prototype.save=function(){this.context.save()};Context2DRenderer.prototype.restore=function(){this.context.restore()};Context2DRenderer.prototype.fillRect=function(x,y,width,height,cssColor){var _fillStyle=this.context.fillStyle;this.context.fillStyle=cssColor;this.context.fillRect(x,y,width,height);this.context.fillStyle=_fillStyle};Context2DRenderer.prototype.setCompositeOperation=function(operation){this.context.globalCompositeOperation=RenderingHelper_1.RenderingHelper.toTextFromCompositeOperation(operation)};Context2DRenderer.prototype.setOpacity=function(opacity){this.context.globalAlpha=opacity};Context2DRenderer.prototype.setTransform=function(matrix){this.context.setTransform.apply(this.context,matrix)};return Context2DRenderer}(g.Renderer);exports.Context2DRenderer=Context2DRenderer},{"./RenderingHelper":42,"@akashic/akashic-engine":1}],41:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:true});exports.GlyphFactory=void 0;var g=require("@akashic/akashic-engine");var CanvasSurface_1=require("./CanvasSurface");function createGlyphRenderedSurface(code,fontSize,cssFontFamily,baselineHeight,marginW,marginH,needImageData,fontColor,strokeWidth,strokeColor,strokeOnly,fontWeight){var scale=fontSize<GlyphFactory._environmentMinimumFontSize?fontSize/GlyphFactory._environmentMinimumFontSize:1;var surfaceWidth=Math.ceil((fontSize+marginW*2)*scale);var surfaceHeight=Math.ceil((fontSize+marginH*2)*scale);var surface=new CanvasSurface_1.CanvasSurface(surfaceWidth,surfaceHeight);var canvas=surface.canvas;var context=canvas.getContext("2d");var str=code&4294901760?String.fromCharCode((code&4294901760)>>>16,code&65535):String.fromCharCode(code);var fontWeightValue=fontWeight===g.FontWeight.Bold?"bold ":"";context.save();context.font=fontWeightValue+fontSize+"px "+cssFontFamily;context.textAlign="left";context.textBaseline="alphabetic";context.lineJoin="bevel";if(scale!==1)context.scale(scale,scale);if(strokeWidth>0){context.lineWidth=strokeWidth;context.strokeStyle=strokeColor;context.strokeText(str,marginW,marginH+baselineHeight)}if(!strokeOnly){context.fillStyle=fontColor;context.fillText(str,marginW,marginH+baselineHeight)}var advanceWidth=context.measureText(str).width;context.restore();var result={surface:surface,advanceWidth:advanceWidth,imageData:needImageData?context.getImageData(0,0,canvas.width,canvas.height):undefined};return result}function calcGlyphArea(imageData){var sx=imageData.width;var sy=imageData.height;var ex=0;var ey=0;var currentPos=0;for(var y=0,height=imageData.height;y<height;y=y+1|0){for(var x=0,width=imageData.width;x<width;x=x+1|0){var a=imageData.data[currentPos+3];if(a!==0){if(x<sx){sx=x}if(x>ex){ex=x}if(y<sy){sy=y}if(y>ey){ey=y}}currentPos+=4}}var glyphArea=undefined;if(sx===imageData.width){glyphArea={x:0,y:0,width:0,height:0}}else{glyphArea={x:sx,y:sy,width:ex-sx+1,height:ey-sy+1}}return glyphArea}function isGlyphAreaEmpty(glyphArea){return glyphArea.width===0||glyphArea.height===0}function fontFamily2FontFamilyName(fontFamily){switch(fontFamily){case g.FontFamily.Monospace:return"monospace";case g.FontFamily.Serif:return"serif";default:return"sans-serif"}}var genericFontFamilyNames=["serif","sans-serif","monospace","cursive","fantasy","system-ui"];function quoteIfNotGeneric(name){if(genericFontFamilyNames.indexOf(name)!==-1){return name}else{return'"'+name+'"'}}function fontFamily2CSSFontFamily(fontFamily){if(typeof fontFamily==="number"){return fontFamily2FontFamilyName(fontFamily)}else if(typeof fontFamily==="string"){return quoteIfNotGeneric(fontFamily)}else{return fontFamily.map(function(font){if(typeof font==="string"){return quoteIfNotGeneric(font)}else{return fontFamily2FontFamilyName(font)}}).join(",")}}var GlyphFactory=function(_super){__extends(GlyphFactory,_super);function GlyphFactory(fontFamily,fontSize,baselineHeight,fontColor,strokeWidth,strokeColor,strokeOnly,fontWeight){var _this=_super.call(this,fontFamily,fontSize,baselineHeight,fontColor,strokeWidth,strokeColor,strokeOnly,fontWeight)||this;_this._glyphAreas={};_this._cssFontFamily=fontFamily2CSSFontFamily(fontFamily);var fallbackFontFamilyName=fontFamily2FontFamilyName(g.FontFamily.SansSerif);if(_this._cssFontFamily.indexOf(fallbackFontFamilyName)===-1){_this._cssFontFamily+=","+fallbackFontFamilyName}_this._marginW=Math.ceil(_this.fontSize*.3+_this.strokeWidth/2);_this._marginH=Math.ceil(_this.fontSize*.3+_this.strokeWidth/2);if(GlyphFactory._environmentMinimumFontSize===undefined){GlyphFactory._environmentMinimumFontSize=_this.measureMinimumFontSize()}return _this}GlyphFactory.prototype.create=function(code){var result;var glyphArea=this._glyphAreas[code];if(!glyphArea){result=createGlyphRenderedSurface(code,this.fontSize,this._cssFontFamily,this.baselineHeight,this._marginW,this._marginH,true,this.fontColor,this.strokeWidth,this.strokeColor,this.strokeOnly,this.fontWeight);glyphArea=calcGlyphArea(result.imageData);glyphArea.advanceWidth=result.advanceWidth;this._glyphAreas[code]=glyphArea}if(isGlyphAreaEmpty(glyphArea)){if(result){result.surface.destroy()}return new g.Glyph(code,0,0,0,0,0,0,glyphArea.advanceWidth,undefined,true)}else{if(!result){result=createGlyphRenderedSurface(code,this.fontSize,this._cssFontFamily,this.baselineHeight,this._marginW,this._marginH,false,this.fontColor,this.strokeWidth,this.strokeColor,this.strokeOnly,this.fontWeight)}return new g.Glyph(code,glyphArea.x,glyphArea.y,glyphArea.width,glyphArea.height,glyphArea.x-this._marginW,glyphArea.y-this._marginH,glyphArea.advanceWidth,result.surface,true)}};GlyphFactory.prototype.measureMinimumFontSize=function(){var fontSize=1;var str="M";var canvas=document.createElement("canvas");var context=canvas.getContext("2d");context.textAlign="left";context.textBaseline="alphabetic";context.lineJoin="bevel";var preWidth;context.font=fontSize+"px sans-serif";var width=context.measureText(str).width;do{preWidth=width;fontSize+=1;context.font=fontSize+"px sans-serif";width=context.measureText(str).width}while(preWidth===width||fontSize>50);return fontSize};return GlyphFactory}(g.GlyphFactory);exports.GlyphFactory=GlyphFactory},{"./CanvasSurface":39,"@akashic/akashic-engine":1}],42:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.RenderingHelper=void 0;var g=require("@akashic/akashic-engine");var SurfaceFactory_1=require("./SurfaceFactory");var RenderingHelper;(function(RenderingHelper){function toTextFromCompositeOperation(operation){var operationText;switch(operation){case g.CompositeOperation.SourceAtop:operationText="source-atop";break;case g.CompositeOperation.Lighter:operationText="lighter";break;case g.CompositeOperation.Copy:operationText="copy";break;default:operationText="source-over";break}return operationText}RenderingHelper.toTextFromCompositeOperation=toTextFromCompositeOperation;function toCompositeOperationFromText(operationText){var operation;switch(operationText){case"source-atop":operation=g.CompositeOperation.SourceAtop;break;case"lighter":operation=g.CompositeOperation.Lighter;break;case"copy":operation=g.CompositeOperation.Copy;break;default:operation=g.CompositeOperation.SourceOver;break}return operation}RenderingHelper.toCompositeOperationFromText=toCompositeOperationFromText;function drawSystemTextByContext2D(context,text,x,y,maxWidth,fontSize,textAlign,textBaseline,textColor,fontFamily,strokeWidth,strokeColor,strokeOnly){var fontFamilyValue;var textAlignValue;var textBaselineValue;context.save();switch(fontFamily){case g.FontFamily.Monospace:fontFamilyValue="monospace";break;case g.FontFamily.Serif:fontFamilyValue="serif";break;default:fontFamilyValue="sans-serif";break}context.font=fontSize+"px "+fontFamilyValue;switch(textAlign){case g.TextAlign.Right:textAlignValue="right";break;case g.TextAlign.Center:textAlignValue="center";break;default:textAlignValue="left";break}context.textAlign=textAlignValue;switch(textBaseline){case g.TextBaseline.Top:textBaselineValue="top";break;case g.TextBaseline.Middle:textBaselineValue="middle";break;case g.TextBaseline.Bottom:textBaselineValue="bottom";break;default:textBaselineValue="alphabetic";break}context.textBaseline=textBaselineValue;context.lineJoin="bevel";if(strokeWidth>0){context.lineWidth=strokeWidth;context.strokeStyle=strokeColor;if(typeof maxWidth==="undefined"){context.strokeText(text,x,y)}else{context.strokeText(text,x,y,maxWidth)}}if(!strokeOnly){context.fillStyle=textColor;if(typeof maxWidth==="undefined"){context.fillText(text,x,y)}else{context.fillText(text,x,y,maxWidth)}}context.restore()}RenderingHelper.drawSystemTextByContext2D=drawSystemTextByContext2D;function createPrimarySurface(width,height,rendererCandidates){return SurfaceFactory_1.SurfaceFactory.createPrimarySurface(width,height,rendererCandidates)}RenderingHelper.createPrimarySurface=createPrimarySurface;function createBackSurface(width,height,platform,rendererCandidates){return SurfaceFactory_1.SurfaceFactory.createBackSurface(width,height,platform,rendererCandidates)}RenderingHelper.createBackSurface=createBackSurface})(RenderingHelper=exports.RenderingHelper||(exports.RenderingHelper={}))},{"./SurfaceFactory":43,"@akashic/akashic-engine":1}],43:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.SurfaceFactory=void 0;var CanvasSurface_1=require("./CanvasSurface");var SurfaceFactory;(function(SurfaceFactory){function createPrimarySurface(width,height,rendererCandidates){return new CanvasSurface_1.CanvasSurface(width,height)}SurfaceFactory.createPrimarySurface=createPrimarySurface;function createBackSurface(width,height,platform,rendererCandidates){return new CanvasSurface_1.CanvasSurface(width,height)}SurfaceFactory.createBackSurface=createBackSurface})(SurfaceFactory=exports.SurfaceFactory||(exports.SurfaceFactory={}))},{"./CanvasSurface":39}],44:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.InputAbstractHandler=void 0;var g=require("@akashic/akashic-engine");var pdi=require("@akashic/akashic-pdi");var InputAbstractHandler=function(){function InputAbstractHandler(inputView,disablePreventDefault){if(Object.getPrototypeOf&&Object.getPrototypeOf(this)===InputAbstractHandler.prototype){throw new Error("InputAbstractHandler is abstract and should not be directly instantiated")}this.inputView=inputView;this.pointerEventLock={};this._xScale=1;this._yScale=1;this._disablePreventDefault=!!disablePreventDefault;this.pointTrigger=new g.Trigger}InputAbstractHandler.isSupported=function(){return false};InputAbstractHandler.prototype.start=function(){throw new Error("This method is abstract")};InputAbstractHandler.prototype.stop=function(){throw new Error("This method is abstract")};InputAbstractHandler.prototype.setScale=function(xScale,yScale){if(yScale===void 0){yScale=xScale}this._xScale=xScale;this._yScale=yScale};InputAbstractHandler.prototype.pointDown=function(identifier,pagePosition){this.pointTrigger.fire({type:0,identifier:identifier,offset:this.getOffsetFromEvent(pagePosition)});this.pointerEventLock[identifier]=true};InputAbstractHandler.prototype.pointMove=function(identifier,pagePosition){if(!this.pointerEventLock.hasOwnProperty(identifier+"")){return}this.pointTrigger.fire({type:1,identifier:identifier,offset:this.getOffsetFromEvent(pagePosition)})};InputAbstractHandler.prototype.pointUp=function(identifier,pagePosition){if(!this.pointerEventLock.hasOwnProperty(identifier+"")){return}this.pointTrigger.fire({type:2,identifier:identifier,offset:this.getOffsetFromEvent(pagePosition)});delete this.pointerEventLock[identifier]};InputAbstractHandler.prototype.getOffsetFromEvent=function(e){return{x:e.offsetX,y:e.offsetY}};InputAbstractHandler.prototype.getScale=function(){return{x:this._xScale,y:this._yScale}};return InputAbstractHandler}();exports.InputAbstractHandler=InputAbstractHandler},{"@akashic/akashic-engine":1,"@akashic/akashic-pdi":3}],45:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:true});exports.MouseHandler=void 0;var InputAbstractHandler_1=require("./InputAbstractHandler");var MouseHandler=function(_super){__extends(MouseHandler,_super);function MouseHandler(inputView,disablePreventDefault){var _this=_super.call(this,inputView,disablePreventDefault)||this;var identifier=1;_this.onMouseDown=function(e){if(e.button!==0)return;_this.eventTarget=e.target;_this.pointDown(identifier,e);window.addEventListener("mousemove",_this.onMouseMove,false);window.addEventListener("mouseup",_this.onMouseUp,false);if(!_this._disablePreventDefault){e.stopPropagation();e.preventDefault()}};_this.onMouseMove=function(e){if(e.target!==_this.eventTarget)return;_this.pointMove(identifier,e);if(!_this._disablePreventDefault){e.stopPropagation();e.preventDefault()}};_this.onMouseUp=function(e){if(e.target!==_this.eventTarget)return;_this.pointUp(identifier,e);window.removeEventListener("mousemove",_this.onMouseMove,false);window.removeEventListener("mouseup",_this.onMouseUp,false);if(!_this._disablePreventDefault){e.stopPropagation();e.preventDefault()}};return _this}MouseHandler.prototype.start=function(){this.inputView.addEventListener("mousedown",this.onMouseDown,false)};MouseHandler.prototype.stop=function(){this.inputView.removeEventListener("mousedown",this.onMouseDown,false)};return MouseHandler}(InputAbstractHandler_1.InputAbstractHandler);exports.MouseHandler=MouseHandler},{"./InputAbstractHandler":44}],46:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:true});exports.TouchHandler=void 0;var MouseHandler_1=require("./MouseHandler");var TouchHandler=function(_super){__extends(TouchHandler,_super);function TouchHandler(inputView,disablePreventDefault){var _this=_super.call(this,inputView,disablePreventDefault)||this;_this.onTouchDown=function(e){var touches=e.changedTouches;for(var i=0,len=touches.length;i<len;i++){var touch=touches[i];_this.pointDown(touch.identifier,_this.convertToPagePosition(touch))}if(!_this._disablePreventDefault){e.stopPropagation();if(e.cancelable)e.preventDefault()}};_this.onTouchMove=function(e){var touches=e.changedTouches;for(var i=0,len=touches.length;i<len;i++){var touch=touches[i];_this.pointMove(touch.identifier,_this.convertToPagePosition(touch))}if(!_this._disablePreventDefault){e.stopPropagation();if(e.cancelable)e.preventDefault()}};_this.onTouchUp=function(e){var touches=e.changedTouches;for(var i=0,len=touches.length;i<len;i++){var touch=touches[i];_this.pointUp(touch.identifier,_this.convertToPagePosition(touch))}if(!_this._disablePreventDefault){e.stopPropagation();if(e.cancelable)e.preventDefault()}};return _this}TouchHandler.prototype.start=function(){_super.prototype.start.call(this);this.inputView.addEventListener("touchstart",this.onTouchDown);this.inputView.addEventListener("touchmove",this.onTouchMove);this.inputView.addEventListener("touchend",this.onTouchUp)};TouchHandler.prototype.stop=function(){_super.prototype.stop.call(this);this.inputView.removeEventListener("touchstart",this.onTouchDown);this.inputView.removeEventListener("touchmove",this.onTouchMove);this.inputView.removeEventListener("touchend",this.onTouchUp)};TouchHandler.prototype.convertToPagePosition=function(e){var bounding=this.inputView.getBoundingClientRect();var scale=this.getScale();return{offsetX:(e.pageX-Math.round(window.pageXOffset+bounding.left))/scale.x,offsetY:(e.pageY-Math.round(window.pageYOffset+bounding.top))/scale.y}};return TouchHandler}(MouseHandler_1.MouseHandler);exports.TouchHandler=TouchHandler},{"./MouseHandler":45}],47:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.ProxyAudioPlugin=exports.WebAudioPlugin=exports.HTMLAudioPlugin=exports.AudioPluginRegistry=exports.g=exports.ResourceFactory=exports.Platform=void 0;var Platform_1=require("./Platform");Object.defineProperty(exports,"Platform",{enumerable:true,get:function(){return Platform_1.Platform}});var ResourceFactory_1=require("./ResourceFactory");Object.defineProperty(exports,"ResourceFactory",{enumerable:true,get:function(){return ResourceFactory_1.ResourceFactory}});var g=require("@akashic/akashic-engine");exports.g=g;var AudioPluginRegistry_1=require("./plugin/AudioPluginRegistry");Object.defineProperty(exports,"AudioPluginRegistry",{enumerable:true,get:function(){return AudioPluginRegistry_1.AudioPluginRegistry}});var AudioPluginManager_1=require("./plugin/AudioPluginManager");Object.defineProperty(exports,"AudioPluginManager",{enumerable:true,get:function(){return AudioPluginManager_1.AudioPluginManager}});var HTMLAudioPlugin_1=require("./plugin/HTMLAudioPlugin/HTMLAudioPlugin");Object.defineProperty(exports,"HTMLAudioPlugin",{enumerable:true,get:function(){return HTMLAudioPlugin_1.HTMLAudioPlugin}});var WebAudioPlugin_1=require("./plugin/WebAudioPlugin/WebAudioPlugin");Object.defineProperty(exports,"WebAudioPlugin",{enumerable:true,get:function(){return WebAudioPlugin_1.WebAudioPlugin}});var ProxyAudioPlugin_1=require("./plugin/ProxyAudioPlugin/ProxyAudioPlugin");Object.defineProperty(exports,"ProxyAudioPlugin",{enumerable:true,get:function(){return ProxyAudioPlugin_1.ProxyAudioPlugin}})},{"./Platform":31,"./ResourceFactory":33,"./plugin/AudioPluginManager":48,"./plugin/AudioPluginRegistry":49,"./plugin/HTMLAudioPlugin/HTMLAudioPlugin":53,"./plugin/ProxyAudioPlugin/ProxyAudioPlugin":56,"./plugin/WebAudioPlugin/WebAudioPlugin":61,"@akashic/akashic-engine":1}],48:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.AudioPluginManager=void 0;var AudioPluginManager=function(){function AudioPluginManager(){this._activePlugin=null}AudioPluginManager.prototype.getActivePlugin=function(){return this._activePlugin};AudioPluginManager.prototype.tryInstallPlugin=function(plugins){for(var i=0,len=plugins.length;i<len;i++){var p=plugins[i];if(p.isSupported){var PluginConstructor=p;if(PluginConstructor.isSupported()){this._activePlugin=new PluginConstructor;return true}}else{this._activePlugin=p;return true}}return false};return AudioPluginManager}();exports.AudioPluginManager=AudioPluginManager},{}],49:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.AudioPluginRegistry=void 0;var audioPlugins=[];exports.AudioPluginRegistry={addPlugin:function(plugin){if(audioPlugins.indexOf(plugin)===-1){audioPlugins.push(plugin)}},getRegisteredAudioPlugins:function(){return audioPlugins},clear:function(){audioPlugins=[]}}},{}],50:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:true});exports.HTMLAudioAsset=void 0;var g=require("@akashic/akashic-engine");var HTMLAudioAsset=function(_super){__extends(HTMLAudioAsset,_super);function HTMLAudioAsset(){return _super!==null&&_super.apply(this,arguments)||this}HTMLAudioAsset.prototype._load=function(loader){var _this=this;if(this.path==null){this.data=null;setTimeout(function(){return loader._onAssetLoad(_this)},0);return}var audio=new Audio;var startLoadingAudio=function(path,handlers){audio.autoplay=false;audio.preload="none";audio.src=path;_this._attachAll(audio,handlers);audio.preload="auto";setAudioLoadInterval(audio,handlers);audio.load()};var handlers={success:function(){_this._detachAll(audio,handlers);_this.data=audio;loader._onAssetLoad(_this);window.clearInterval(_this._intervalId)},error:function(){_this._detachAll(audio,handlers);_this.data=audio;loader._onAssetError(_this,g.ExceptionFactory.createAssetLoadError("HTMLAudioAsset loading error"));window.clearInterval(_this._intervalId)}};var setAudioLoadInterval=function(audio,handlers){_this._intervalCount=0;_this._intervalId=window.setInterval(function(){if(audio.readyState===4){handlers.success()}else{++_this._intervalCount;if(_this._intervalCount===600){handlers.error()}}},100)};if(this.path.slice(-4)===".aac"&&HTMLAudioAsset.supportedFormats.indexOf("mp4")!==-1){var altHandlers={success:handlers.success,error:function(){_this._detachAll(audio,altHandlers);window.clearInterval(_this._intervalId);var altPath=_this.path.slice(0,_this.path.length-4)+".mp4";startLoadingAudio(altPath,handlers)}};startLoadingAudio(this.path,altHandlers);return}startLoadingAudio(this.path,handlers)};HTMLAudioAsset.prototype.cloneElement=function(){return this.data?new Audio(this.data.src):null};HTMLAudioAsset.prototype._assetPathFilter=function(path){if(HTMLAudioAsset.supportedFormats.indexOf("ogg")!==-1){return g.PathUtil.addExtname(path,"ogg")}if(HTMLAudioAsset.supportedFormats.indexOf("aac")!==-1){return g.PathUtil.addExtname(path,"aac")}return null};HTMLAudioAsset.prototype._attachAll=function(audio,handlers){if(handlers.success){audio.addEventListener("canplaythrough",handlers.success,false)}if(handlers.error){audio.addEventListener("stalled",handlers.error,false);audio.addEventListener("error",handlers.error,false);audio.addEventListener("abort",handlers.error,false)}};HTMLAudioAsset.prototype._detachAll=function(audio,handlers){if(handlers.success){audio.removeEventListener("canplaythrough",handlers.success,false)}if(handlers.error){audio.removeEventListener("stalled",handlers.error,false);audio.removeEventListener("error",handlers.error,false);audio.removeEventListener("abort",handlers.error,false)}};return HTMLAudioAsset}(g.AudioAsset);exports.HTMLAudioAsset=HTMLAudioAsset},{"@akashic/akashic-engine":1}],51:[function(require,module,exports){"use strict";var state=0;var suspendedAudioElements=[];var HTMLAudioAutoplayHelper;(function(HTMLAudioAutoplayHelper){function setupChromeMEIWorkaround(audio){function playHandler(){switch(state){case 0:case 1:playSuspendedAudioElements();break;case 2:break;default:}state=2;clearTimeout(timer)}function suspendedHandler(){audio.removeEventListener("play",playHandler);switch(state){case 0:suspendedAudioElements.push(audio);state=1;setUserInteractListener();break;case 1:suspendedAudioElements.push(audio);break;case 2:audio.play();break;default:}}switch(state){case 0:audio.addEventListener("play",playHandler,true);var timer=setTimeout(suspendedHandler,100);break;case 1:suspendedAudioElements.push(audio);break;case 2:break;default:}}HTMLAudioAutoplayHelper.setupChromeMEIWorkaround=setupChromeMEIWorkaround})(HTMLAudioAutoplayHelper||(HTMLAudioAutoplayHelper={}));function resumeHandler(){playSuspendedAudioElements();clearUserInteractListener()}function setUserInteractListener(){document.addEventListener("keydown",resumeHandler,true);document.addEventListener("mousedown",resumeHandler,true);document.addEventListener("touchend",resumeHandler,true)}function clearUserInteractListener(){document.removeEventListener("keydown",resumeHandler);document.removeEventListener("mousedown",resumeHandler);document.removeEventListener("touchend",resumeHandler)}function playSuspendedAudioElements(){state=2;suspendedAudioElements.forEach(function(audio){return audio.play()});suspendedAudioElements=[]}module.exports=HTMLAudioAutoplayHelper},{}],52:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:true});exports.HTMLAudioPlayer=void 0;var g=require("@akashic/akashic-engine");var autoPlayHelper=require("./HTMLAudioAutoplayHelper");var HTMLAudioPlayer=function(_super){__extends(HTMLAudioPlayer,_super);function HTMLAudioPlayer(system,manager){var _this=_super.call(this,system)||this;_this._manager=manager;_this._endedEventHandler=function(){_this._onAudioEnded()};_this._onPlayEventHandler=function(){_this._onPlayEvent()};_this._dummyDurationWaitTimer=null;return _this}HTMLAudioPlayer.prototype.play=function(asset){if(this.currentAudio){this.stop()}var audio=asset.cloneElement();if(audio){autoPlayHelper.setupChromeMEIWorkaround(audio);audio.volume=this._calculateVolume();audio.play().catch(function(err){});audio.loop=asset.loop;audio.addEventListener("ended",this._endedEventHandler,false);audio.addEventListener("play",this._onPlayEventHandler,false);this._isWaitingPlayEvent=true;this._audioInstance=audio}else{this._dummyDurationWaitTimer=setTimeout(this._endedEventHandler,asset.duration)}_super.prototype.play.call(this,asset)};HTMLAudioPlayer.prototype.stop=function(){if(!this.currentAudio){return}this._clearEndedEventHandler();if(this._audioInstance){if(!this._isWaitingPlayEvent){this._audioInstance.pause();this._audioInstance=null}else{this._isStopRequested=true}}_super.prototype.stop.call(this)};HTMLAudioPlayer.prototype.changeVolume=function(volume){_super.prototype.changeVolume.call(this,volume);if(this._audioInstance){this._audioInstance.volume=this._calculateVolume()}};HTMLAudioPlayer.prototype._changeMuted=function(muted){_super.prototype._changeMuted.call(this,muted);if(this._audioInstance){this._audioInstance.volume=this._calculateVolume()}};HTMLAudioPlayer.prototype.notifyMasterVolumeChanged=function(){if(this._audioInstance){this._audioInstance.volume=this._calculateVolume()}};HTMLAudioPlayer.prototype._onAudioEnded=function(){this._clearEndedEventHandler();_super.prototype.stop.call(this)};HTMLAudioPlayer.prototype._clearEndedEventHandler=function(){if(this._audioInstance)this._audioInstance.removeEventListener("ended",this._endedEventHandler,false);if(this._dummyDurationWaitTimer!=null){clearTimeout(this._dummyDurationWaitTimer);this._dummyDurationWaitTimer=null}};HTMLAudioPlayer.prototype._onPlayEvent=function(){if(!this._isWaitingPlayEvent)return;this._isWaitingPlayEvent=false;if(this._isStopRequested){this._isStopRequested=false;this._audioInstance.pause();this._audioInstance=null}};HTMLAudioPlayer.prototype._calculateVolume=function(){return this._muted?0:this.volume*this._system.volume*this._manager.getMasterVolume()};return HTMLAudioPlayer}(g.AudioPlayer);exports.HTMLAudioPlayer=HTMLAudioPlayer},{"./HTMLAudioAutoplayHelper":51,"@akashic/akashic-engine":1}],53:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.HTMLAudioPlugin=void 0;var HTMLAudioAsset_1=require("./HTMLAudioAsset");var HTMLAudioPlayer_1=require("./HTMLAudioPlayer");var HTMLAudioPlugin=function(){function HTMLAudioPlugin(){this._supportedFormats=this._detectSupportedFormats();HTMLAudioAsset_1.HTMLAudioAsset.supportedFormats=this.supportedFormats}HTMLAudioPlugin.isSupported=function(){var audioElement=document.createElement("audio");var result=false;try{result=audioElement.canPlayType!==undefined}catch(e){}return result};Object.defineProperty(HTMLAudioPlugin.prototype,"supportedFormats",{get:function(){return this._supportedFormats},set:function(supportedFormats){this._supportedFormats=supportedFormats;HTMLAudioAsset_1.HTMLAudioAsset.supportedFormats=supportedFormats},enumerable:false,configurable:true});HTMLAudioPlugin.prototype.createAsset=function(id,assetPath,duration,system,loop,hint){return new HTMLAudioAsset_1.HTMLAudioAsset(id,assetPath,duration,system,loop,hint)};HTMLAudioPlugin.prototype.createPlayer=function(system,manager){return new HTMLAudioPlayer_1.HTMLAudioPlayer(system,manager)};HTMLAudioPlugin.prototype._detectSupportedFormats=function(){if(navigator.userAgent.indexOf("Edge/")!==-1)return["aac"];var audioElement=document.createElement("audio");var supportedFormats=[];try{var supportedExtensions=["ogg","aac","mp4"];for(var i=0,len=supportedExtensions.length;i<len;i++){var ext=supportedExtensions[i];var canPlay=audioElement.canPlayType("audio/"+ext);var supported=canPlay!=="no"&&canPlay!=="";if(supported){supportedFormats.push(ext)}}}catch(e){}return supportedFormats};return HTMLAudioPlugin}();exports.HTMLAudioPlugin=HTMLAudioPlugin},{"./HTMLAudioAsset":50,"./HTMLAudioPlayer":52}],54:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:true});exports.ProxyAudioAsset=void 0;var g=require("@akashic/akashic-engine");var ProxyAudioAsset=function(_super){__extends(ProxyAudioAsset,_super);function ProxyAudioAsset(handlerSet,id,assetPath,duration,system,loop,hint){var _this=_super.call(this,id,assetPath,duration,system,loop,hint)||this;_this._handlerSet=handlerSet;return _this}ProxyAudioAsset.prototype.destroy=function(){this._handlerSet.unloadAudioAsset(this.id);_super.prototype.destroy.call(this)};ProxyAudioAsset.prototype._load=function(loader){var _this=this;this._handlerSet.loadAudioAsset({id:this.id,assetPath:this.path,duration:this.duration,loop:this.loop,hint:this.hint},function(err){if(err){loader._onAssetError(_this,g.ExceptionFactory.createAssetLoadError(err))}else{loader._onAssetLoad(_this)}})};ProxyAudioAsset.prototype._assetPathFilter=function(path){return path};return ProxyAudioAsset}(g.AudioAsset);exports.ProxyAudioAsset=ProxyAudioAsset},{"@akashic/akashic-engine":1}],55:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:true});exports.ProxyAudioPlayer=void 0;var g=require("@akashic/akashic-engine");var ProxyAudioPlayer=function(_super){__extends(ProxyAudioPlayer,_super);function ProxyAudioPlayer(handlerSet,system,manager){var _this=_super.call(this,system)||this;_this._audioPlayerId=null;_this._handlerSet=handlerSet;_this._manager=manager;return _this}ProxyAudioPlayer.prototype.changeVolume=function(volume){_super.prototype.changeVolume.call(this,volume);this._notifyVolumeToHandler()};ProxyAudioPlayer.prototype._changeMuted=function(muted){_super.prototype._changeMuted.call(this,muted);this._notifyVolumeToHandler()};ProxyAudioPlayer.prototype.play=function(asset){if(this._audioPlayerId!=null){this.stop()}this._audioPlayerId="ap"+ProxyAudioPlayer._audioPlayerIdCounter++;this._handlerSet.createAudioPlayer({assetId:asset.id,audioPlayerId:this._audioPlayerId,isPlaying:true,volume:this._calculateVolume(),playbackRate:1});_super.prototype.play.call(this,asset)};ProxyAudioPlayer.prototype.stop=function(){if(this._audioPlayerId!=null){this._handlerSet.stopAudioPlayer(this._audioPlayerId);this._handlerSet.destroyAudioPlayer(this._audioPlayerId);this._audioPlayerId=null}_super.prototype.stop.call(this)};ProxyAudioPlayer.prototype.notifyMasterVolumeChanged=function(){this._notifyVolumeToHandler()};ProxyAudioPlayer.prototype._notifyVolumeToHandler=function(){if(this._audioPlayerId!=null){this._handlerSet.changeAudioVolume(this._audioPlayerId,this._calculateVolume())}};ProxyAudioPlayer.prototype._calculateVolume=function(){return this._muted?0:this.volume*this._system.volume*this._manager.getMasterVolume()};ProxyAudioPlayer._audioPlayerIdCounter=0;return ProxyAudioPlayer}(g.AudioPlayer);exports.ProxyAudioPlayer=ProxyAudioPlayer},{"@akashic/akashic-engine":1}],56:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.ProxyAudioPlugin=void 0;var ProxyAudioAsset_1=require("./ProxyAudioAsset");var ProxyAudioPlayer_1=require("./ProxyAudioPlayer");var ProxyAudioPlugin=function(){function ProxyAudioPlugin(handlerSet){this.supportedFormats=[];this._handlerSet=handlerSet}ProxyAudioPlugin.isSupported=function(){return true};ProxyAudioPlugin.prototype.createAsset=function(id,assetPath,duration,system,loop,hint){return new ProxyAudioAsset_1.ProxyAudioAsset(this._handlerSet,id,assetPath,duration,system,loop,hint)};ProxyAudioPlugin.prototype.createPlayer=function(system,manager){return new ProxyAudioPlayer_1.ProxyAudioPlayer(this._handlerSet,system,manager)};return ProxyAudioPlugin}();exports.ProxyAudioPlugin=ProxyAudioPlugin},{"./ProxyAudioAsset":54,"./ProxyAudioPlayer":55}],57:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:true});exports.WebAudioAsset=void 0;var g=require("@akashic/akashic-engine");var XHRLoader_1=require("../../utils/XHRLoader");var helper=require("./WebAudioHelper");var WebAudioAsset=function(_super){__extends(WebAudioAsset,_super);function WebAudioAsset(){return _super!==null&&_super.apply(this,arguments)||this}WebAudioAsset.prototype._load=function(loader){var _this=this;if(this.path==null){this.data=null;setTimeout(function(){return loader._onAssetLoad(_this)},0);return}var successHandler=function(decodedAudio){_this.data=decodedAudio;loader._onAssetLoad(_this)};var errorHandler=function(){loader._onAssetError(_this,g.ExceptionFactory.createAssetLoadError("WebAudioAsset unknown loading error"))};var onLoadArrayBufferHandler=function(response){var audioContext=helper.getAudioContext();audioContext.decodeAudioData(response,successHandler,errorHandler)};var xhrLoader=new XHRLoader_1.XHRLoader;var loadArrayBuffer=function(path,onSuccess,onFailed){xhrLoader.getArrayBuffer(path,function(error,response){error?onFailed(error):onSuccess(response)})};if(this.path.slice(-4)===".aac"){loadArrayBuffer(this.path,onLoadArrayBufferHandler,function(error){var altPath=_this.path.slice(0,_this.path.length-4)+".mp4";loadArrayBuffer(altPath,function(response){_this.path=altPath;onLoadArrayBufferHandler(response)},errorHandler)});return}loadArrayBuffer(this.path,onLoadArrayBufferHandler,errorHandler)};WebAudioAsset.prototype._assetPathFilter=function(path){if(WebAudioAsset.supportedFormats.indexOf("ogg")!==-1){return g.PathUtil.addExtname(path,"ogg")}if(WebAudioAsset.supportedFormats.indexOf("aac")!==-1){return g.PathUtil.addExtname(path,"aac")}return null};WebAudioAsset.supportedFormats=[];return WebAudioAsset}(g.AudioAsset);exports.WebAudioAsset=WebAudioAsset},{"../../utils/XHRLoader":62,"./WebAudioHelper":59,"@akashic/akashic-engine":1}],58:[function(require,module,exports){"use strict";var helper=require("./WebAudioHelper");var WebAudioAutoplayHelper;(function(WebAudioAutoplayHelper){function setupChromeMEIWorkaround(){var context=helper.getAudioContext();if(context&&typeof context.resume!=="function")return;var gain=helper.createGainNode(context);var osc=context.createOscillator();osc.type="sawtooth";osc.frequency.value=440;osc.connect(gain);osc.start(0);var contextState=context.state;osc.disconnect();if(contextState!=="running")setUserInteractListener()}WebAudioAutoplayHelper.setupChromeMEIWorkaround=setupChromeMEIWorkaround})(WebAudioAutoplayHelper||(WebAudioAutoplayHelper={}));function resumeHandler(){var context=helper.getAudioContext();context.resume();clearUserInteractListener()}function setUserInteractListener(){document.addEventListener("keydown",resumeHandler,true);document.addEventListener("mousedown",resumeHandler,true);document.addEventListener("touchend",resumeHandler,true)}function clearUserInteractListener(){document.removeEventListener("keydown",resumeHandler);document.removeEventListener("mousedown",resumeHandler);document.removeEventListener("touchend",resumeHandler)}module.exports=WebAudioAutoplayHelper},{"./WebAudioHelper":59}],59:[function(require,module,exports){"use strict";var AudioContext=window.AudioContext||window.webkitAudioContext;var singleContext=null;var WebAudioHelper;(function(WebAudioHelper){function getAudioContext(){if(!singleContext){singleContext=new AudioContext;WebAudioHelper._workAroundSafari()}return singleContext}WebAudioHelper.getAudioContext=getAudioContext;function createGainNode(context){if(context.createGain){return context.createGain()}return context.createGainNode()}WebAudioHelper.createGainNode=createGainNode;function createBufferNode(context){var sourceNode=context.createBufferSource();if(sourceNode.start){return sourceNode}sourceNode.start=sourceNode.noteOn;sourceNode.stop=sourceNode.noteOff;return sourceNode}WebAudioHelper.createBufferNode=createBufferNode;function _workAroundSafari(){document.addEventListener("touchstart",function touchInitializeHandler(){document.removeEventListener("touchstart",touchInitializeHandler);singleContext.createBufferSource().start(0)},true)}WebAudioHelper._workAroundSafari=_workAroundSafari})(WebAudioHelper||(WebAudioHelper={}));module.exports=WebAudioHelper},{}],60:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:true});exports.WebAudioPlayer=void 0;var g=require("@akashic/akashic-engine");var helper=require("./WebAudioHelper");var WebAudioPlayer=function(_super){__extends(WebAudioPlayer,_super);function WebAudioPlayer(system,manager){var _this=_super.call(this,system)||this;_this._audioContext=helper.getAudioContext();_this._manager=manager;_this._gainNode=helper.createGainNode(_this._audioContext);_this._gainNode.connect(_this._audioContext.destination);_this._sourceNode=undefined;_this._dummyDurationWaitTimer=null;_this._endedEventHandler=function(){_this._onAudioEnded()};return _this}WebAudioPlayer.prototype.changeVolume=function(volume){_super.prototype.changeVolume.call(this,volume);this._gainNode.gain.value=this._calculateVolume()};WebAudioPlayer.prototype._changeMuted=function(muted){_super.prototype._changeMuted.call(this,muted);this._gainNode.gain.value=this._calculateVolume()};WebAudioPlayer.prototype.play=function(asset){if(this.currentAudio){this.stop()}if(asset.data){var bufferNode=helper.createBufferNode(this._audioContext);bufferNode.loop=asset.loop;bufferNode.buffer=asset.data;this._gainNode.gain.value=this._calculateVolume();bufferNode.connect(this._gainNode);this._sourceNode=bufferNode;this._sourceNode.onended=this._endedEventHandler;this._sourceNode.start(0)}else{this._dummyDurationWaitTimer=setTimeout(this._endedEventHandler,asset.duration)}_super.prototype.play.call(this,asset)};WebAudioPlayer.prototype.stop=function(){if(!this.currentAudio){return}this._clearEndedEventHandler();if(this._sourceNode)this._sourceNode.stop(0);_super.prototype.stop.call(this)};WebAudioPlayer.prototype.notifyMasterVolumeChanged=function(){this._gainNode.gain.value=this._calculateVolume()};WebAudioPlayer.prototype._onAudioEnded=function(){this._clearEndedEventHandler();_super.prototype.stop.call(this)};WebAudioPlayer.prototype._clearEndedEventHandler=function(){if(this._sourceNode)this._sourceNode.onended=null;if(this._dummyDurationWaitTimer!=null){clearTimeout(this._dummyDurationWaitTimer);this._dummyDurationWaitTimer=null}};WebAudioPlayer.prototype._calculateVolume=function(){return this._muted?0:this.volume*this._system.volume*this._manager.getMasterVolume()};return WebAudioPlayer}(g.AudioPlayer);exports.WebAudioPlayer=WebAudioPlayer},{"./WebAudioHelper":59,"@akashic/akashic-engine":1}],61:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.WebAudioPlugin=void 0;var WebAudioAsset_1=require("./WebAudioAsset");var WebAudioPlayer_1=require("./WebAudioPlayer");var autoPlayHelper=require("./WebAudioAutoplayHelper");var WebAudioPlugin=function(){function WebAudioPlugin(){this.supportedFormats=this._detectSupportedFormats();autoPlayHelper.setupChromeMEIWorkaround()}WebAudioPlugin.isSupported=function(){if("AudioContext"in window){return true}else if("webkitAudioContext"in window){return true}return false};Object.defineProperty(WebAudioPlugin.prototype,"supportedFormats",{get:function(){return this._supportedFormats},set:function(supportedFormats){this._supportedFormats=supportedFormats;WebAudioAsset_1.WebAudioAsset.supportedFormats=supportedFormats},enumerable:false,configurable:true});WebAudioPlugin.prototype.createAsset=function(id,assetPath,duration,system,loop,hint){return new WebAudioAsset_1.WebAudioAsset(id,assetPath,duration,system,loop,hint)};WebAudioPlugin.prototype.createPlayer=function(system,manager){return new WebAudioPlayer_1.WebAudioPlayer(system,manager)};WebAudioPlugin.prototype._detectSupportedFormats=function(){if(navigator.userAgent.indexOf("Edge/")!==-1)return["aac"];var audioElement=document.createElement("audio");var supportedFormats=[];try{var supportedExtensions=["ogg","aac","mp4"];for(var i=0,len=supportedExtensions.length;i<len;i++){var ext=supportedExtensions[i];var canPlay=audioElement.canPlayType("audio/"+ext);var supported=canPlay!=="no"&&canPlay!=="";if(supported){supportedFormats.push(ext)}}}catch(e){}return supportedFormats};return WebAudioPlugin}();exports.WebAudioPlugin=WebAudioPlugin},{"./WebAudioAsset":57,"./WebAudioAutoplayHelper":58,"./WebAudioPlayer":60}],62:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.XHRLoader=void 0;var g=require("@akashic/akashic-engine");var XHRLoader=function(){function XHRLoader(options){if(options===void 0){options={}}this.timeout=options.timeout||15e3}XHRLoader.prototype.get=function(url,callback){this._getRequestObject({url:url,responseType:"text"},callback)};XHRLoader.prototype.getArrayBuffer=function(url,callback){this._getRequestObject({url:url,responseType:"arraybuffer"},callback)};XHRLoader.prototype._getRequestObject=function(requestObject,callback){var request=new XMLHttpRequest;request.open("GET",requestObject.url,true);request.responseType=requestObject.responseType;request.timeout=this.timeout;request.addEventListener("timeout",function(){callback(g.ExceptionFactory.createAssetLoadError("loading timeout"))},false);request.addEventListener("load",function(){if(request.status>=200&&request.status<300){var response=requestObject.responseType==="text"?request.responseText:request.response;callback(null,response)}else{callback(g.ExceptionFactory.createAssetLoadError("loading error. status: "+request.status))}},false);request.addEventListener("error",function(){callback(g.ExceptionFactory.createAssetLoadError("loading error. status: "+request.status))},false);request.send()};return XHRLoader}();exports.XHRLoader=XHRLoader},{"@akashic/akashic-engine":1}],63:[function(require,module,exports){(function(process,global){
/*!
 * @overview es6-promise - a tiny implementation of Promises/A+.
 * @copyright Copyright (c) 2014 Yehuda Katz, Tom Dale, Stefan Penner and contributors (Conversion to ES6 API by Jake Archibald)
 * @license   Licensed under MIT license
 *            See https://raw.githubusercontent.com/stefanpenner/es6-promise/master/LICENSE
 * @version   v4.2.8+1e68dce6
 */
(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?module.exports=factory():typeof define==="function"&&define.amd?define(factory):global.ES6Promise=factory()})(this,function(){"use strict";function objectOrFunction(x){var type=typeof x;return x!==null&&(type==="object"||type==="function")}function isFunction(x){return typeof x==="function"}var _isArray=void 0;if(Array.isArray){_isArray=Array.isArray}else{_isArray=function(x){return Object.prototype.toString.call(x)==="[object Array]"}}var isArray=_isArray;var len=0;var vertxNext=void 0;var customSchedulerFn=void 0;var asap=function asap(callback,arg){queue[len]=callback;queue[len+1]=arg;len+=2;if(len===2){if(customSchedulerFn){customSchedulerFn(flush)}else{scheduleFlush()}}};function setScheduler(scheduleFn){customSchedulerFn=scheduleFn}function setAsap(asapFn){asap=asapFn}var browserWindow=typeof window!=="undefined"?window:undefined;var browserGlobal=browserWindow||{};var BrowserMutationObserver=browserGlobal.MutationObserver||browserGlobal.WebKitMutationObserver;var isNode=typeof self==="undefined"&&typeof process!=="undefined"&&{}.toString.call(process)==="[object process]";var isWorker=typeof Uint8ClampedArray!=="undefined"&&typeof importScripts!=="undefined"&&typeof MessageChannel!=="undefined";function useNextTick(){return function(){return process.nextTick(flush)}}function useVertxTimer(){if(typeof vertxNext!=="undefined"){return function(){vertxNext(flush)}}return useSetTimeout()}function useMutationObserver(){var iterations=0;var observer=new BrowserMutationObserver(flush);var node=document.createTextNode("");observer.observe(node,{characterData:true});return function(){node.data=iterations=++iterations%2}}function useMessageChannel(){var channel=new MessageChannel;channel.port1.onmessage=flush;return function(){return channel.port2.postMessage(0)}}function useSetTimeout(){var globalSetTimeout=setTimeout;return function(){return globalSetTimeout(flush,1)}}var queue=new Array(1e3);function flush(){for(var i=0;i<len;i+=2){var callback=queue[i];var arg=queue[i+1];callback(arg);queue[i]=undefined;queue[i+1]=undefined}len=0}function attemptVertx(){try{var vertx=Function("return this")().require("vertx");vertxNext=vertx.runOnLoop||vertx.runOnContext;return useVertxTimer()}catch(e){return useSetTimeout()}}var scheduleFlush=void 0;if(isNode){scheduleFlush=useNextTick()}else if(BrowserMutationObserver){scheduleFlush=useMutationObserver()}else if(isWorker){scheduleFlush=useMessageChannel()}else if(browserWindow===undefined&&typeof require==="function"){scheduleFlush=attemptVertx()}else{scheduleFlush=useSetTimeout()}function then(onFulfillment,onRejection){var parent=this;var child=new this.constructor(noop);if(child[PROMISE_ID]===undefined){makePromise(child)}var _state=parent._state;if(_state){var callback=arguments[_state-1];asap(function(){return invokeCallback(_state,child,callback,parent._result)})}else{subscribe(parent,child,onFulfillment,onRejection)}return child}function resolve$1(object){var Constructor=this;if(object&&typeof object==="object"&&object.constructor===Constructor){return object}var promise=new Constructor(noop);resolve(promise,object);return promise}var PROMISE_ID=Math.random().toString(36).substring(2);function noop(){}var PENDING=void 0;var FULFILLED=1;var REJECTED=2;function selfFulfillment(){return new TypeError("You cannot resolve a promise with itself")}function cannotReturnOwn(){return new TypeError("A promises callback cannot return that same promise.")}function tryThen(then$$1,value,fulfillmentHandler,rejectionHandler){try{then$$1.call(value,fulfillmentHandler,rejectionHandler)}catch(e){return e}}function handleForeignThenable(promise,thenable,then$$1){asap(function(promise){var sealed=false;var error=tryThen(then$$1,thenable,function(value){if(sealed){return}sealed=true;if(thenable!==value){resolve(promise,value)}else{fulfill(promise,value)}},function(reason){if(sealed){return}sealed=true;reject(promise,reason)},"Settle: "+(promise._label||" unknown promise"));if(!sealed&&error){sealed=true;reject(promise,error)}},promise)}function handleOwnThenable(promise,thenable){if(thenable._state===FULFILLED){fulfill(promise,thenable._result)}else if(thenable._state===REJECTED){reject(promise,thenable._result)}else{subscribe(thenable,undefined,function(value){return resolve(promise,value)},function(reason){return reject(promise,reason)})}}function handleMaybeThenable(promise,maybeThenable,then$$1){if(maybeThenable.constructor===promise.constructor&&then$$1===then&&maybeThenable.constructor.resolve===resolve$1){handleOwnThenable(promise,maybeThenable)}else{if(then$$1===undefined){fulfill(promise,maybeThenable)}else if(isFunction(then$$1)){handleForeignThenable(promise,maybeThenable,then$$1)}else{fulfill(promise,maybeThenable)}}}function resolve(promise,value){if(promise===value){reject(promise,selfFulfillment())}else if(objectOrFunction(value)){var then$$1=void 0;try{then$$1=value.then}catch(error){reject(promise,error);return}handleMaybeThenable(promise,value,then$$1)}else{fulfill(promise,value)}}function publishRejection(promise){if(promise._onerror){promise._onerror(promise._result)}publish(promise)}function fulfill(promise,value){if(promise._state!==PENDING){return}promise._result=value;promise._state=FULFILLED;if(promise._subscribers.length!==0){asap(publish,promise)}}function reject(promise,reason){if(promise._state!==PENDING){return}promise._state=REJECTED;promise._result=reason;asap(publishRejection,promise)}function subscribe(parent,child,onFulfillment,onRejection){var _subscribers=parent._subscribers;var length=_subscribers.length;parent._onerror=null;_subscribers[length]=child;_subscribers[length+FULFILLED]=onFulfillment;_subscribers[length+REJECTED]=onRejection;if(length===0&&parent._state){asap(publish,parent)}}function publish(promise){var subscribers=promise._subscribers;var settled=promise._state;if(subscribers.length===0){return}var child=void 0,callback=void 0,detail=promise._result;for(var i=0;i<subscribers.length;i+=3){child=subscribers[i];callback=subscribers[i+settled];if(child){invokeCallback(settled,child,callback,detail)}else{callback(detail)}}promise._subscribers.length=0}function invokeCallback(settled,promise,callback,detail){var hasCallback=isFunction(callback),value=void 0,error=void 0,succeeded=true;if(hasCallback){try{value=callback(detail)}catch(e){succeeded=false;error=e}if(promise===value){reject(promise,cannotReturnOwn());return}}else{value=detail}if(promise._state!==PENDING){}else if(hasCallback&&succeeded){resolve(promise,value)}else if(succeeded===false){reject(promise,error)}else if(settled===FULFILLED){fulfill(promise,value)}else if(settled===REJECTED){reject(promise,value)}}function initializePromise(promise,resolver){try{resolver(function resolvePromise(value){resolve(promise,value)},function rejectPromise(reason){reject(promise,reason)})}catch(e){reject(promise,e)}}var id=0;function nextId(){return id++}function makePromise(promise){promise[PROMISE_ID]=id++;promise._state=undefined;promise._result=undefined;promise._subscribers=[]}function validationError(){return new Error("Array Methods must be provided an Array")}var Enumerator=function(){function Enumerator(Constructor,input){this._instanceConstructor=Constructor;this.promise=new Constructor(noop);if(!this.promise[PROMISE_ID]){makePromise(this.promise)}if(isArray(input)){this.length=input.length;this._remaining=input.length;this._result=new Array(this.length);if(this.length===0){fulfill(this.promise,this._result)}else{this.length=this.length||0;this._enumerate(input);if(this._remaining===0){fulfill(this.promise,this._result)}}}else{reject(this.promise,validationError())}}Enumerator.prototype._enumerate=function _enumerate(input){for(var i=0;this._state===PENDING&&i<input.length;i++){this._eachEntry(input[i],i)}};Enumerator.prototype._eachEntry=function _eachEntry(entry,i){var c=this._instanceConstructor;var resolve$$1=c.resolve;if(resolve$$1===resolve$1){var _then=void 0;var error=void 0;var didError=false;try{_then=entry.then}catch(e){didError=true;error=e}if(_then===then&&entry._state!==PENDING){this._settledAt(entry._state,i,entry._result)}else if(typeof _then!=="function"){this._remaining--;this._result[i]=entry}else if(c===Promise$1){var promise=new c(noop);if(didError){reject(promise,error)}else{handleMaybeThenable(promise,entry,_then)}this._willSettleAt(promise,i)}else{this._willSettleAt(new c(function(resolve$$1){return resolve$$1(entry)}),i)}}else{this._willSettleAt(resolve$$1(entry),i)}};Enumerator.prototype._settledAt=function _settledAt(state,i,value){var promise=this.promise;if(promise._state===PENDING){this._remaining--;if(state===REJECTED){reject(promise,value)}else{this._result[i]=value}}if(this._remaining===0){fulfill(promise,this._result)}};Enumerator.prototype._willSettleAt=function _willSettleAt(promise,i){var enumerator=this;subscribe(promise,undefined,function(value){return enumerator._settledAt(FULFILLED,i,value)},function(reason){return enumerator._settledAt(REJECTED,i,reason)})};return Enumerator}();function all(entries){return new Enumerator(this,entries).promise}function race(entries){var Constructor=this;if(!isArray(entries)){return new Constructor(function(_,reject){return reject(new TypeError("You must pass an array to race."))})}else{return new Constructor(function(resolve,reject){var length=entries.length;for(var i=0;i<length;i++){Constructor.resolve(entries[i]).then(resolve,reject)}})}}function reject$1(reason){var Constructor=this;var promise=new Constructor(noop);reject(promise,reason);return promise}function needsResolver(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function needsNew(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}var Promise$1=function(){function Promise(resolver){this[PROMISE_ID]=nextId();this._result=this._state=undefined;this._subscribers=[];if(noop!==resolver){typeof resolver!=="function"&&needsResolver();this instanceof Promise?initializePromise(this,resolver):needsNew()}}Promise.prototype.catch=function _catch(onRejection){return this.then(null,onRejection)};Promise.prototype.finally=function _finally(callback){var promise=this;var constructor=promise.constructor;if(isFunction(callback)){return promise.then(function(value){return constructor.resolve(callback()).then(function(){return value})},function(reason){return constructor.resolve(callback()).then(function(){throw reason})})}return promise.then(callback,callback)};return Promise}();Promise$1.prototype.then=then;Promise$1.all=all;Promise$1.race=race;Promise$1.resolve=resolve$1;Promise$1.reject=reject$1;Promise$1._setScheduler=setScheduler;Promise$1._setAsap=setAsap;Promise$1._asap=asap;function polyfill(){var local=void 0;if(typeof global!=="undefined"){local=global}else if(typeof self!=="undefined"){local=self}else{try{local=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}}var P=local.Promise;if(P){var promiseToString=null;try{promiseToString=Object.prototype.toString.call(P.resolve())}catch(e){}if(promiseToString==="[object Promise]"&&!P.cast){return}}local.Promise=Promise$1}Promise$1.polyfill=polyfill;Promise$1.Promise=Promise$1;return Promise$1})}).call(this,require("_process"),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{_process:64}],64:[function(require,module,exports){var process=module.exports={};var cachedSetTimeout;var cachedClearTimeout;function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}(function(){try{if(typeof setTimeout==="function"){cachedSetTimeout=setTimeout}else{cachedSetTimeout=defaultSetTimout}}catch(e){cachedSetTimeout=defaultSetTimout}try{if(typeof clearTimeout==="function"){cachedClearTimeout=clearTimeout}else{cachedClearTimeout=defaultClearTimeout}}catch(e){cachedClearTimeout=defaultClearTimeout}})();function runTimeout(fun){if(cachedSetTimeout===setTimeout){return setTimeout(fun,0)}if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout){cachedSetTimeout=setTimeout;return setTimeout(fun,0)}try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}function runClearTimeout(marker){if(cachedClearTimeout===clearTimeout){return clearTimeout(marker)}if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout){cachedClearTimeout=clearTimeout;return clearTimeout(marker)}try{return cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}var queue=[];var draining=false;var currentQueue;var queueIndex=-1;function cleanUpNextTick(){if(!draining||!currentQueue){return}draining=false;if(currentQueue.length){queue=currentQueue.concat(queue)}else{queueIndex=-1}if(queue.length){drainQueue()}}function drainQueue(){if(draining){return}var timeout=runTimeout(cleanUpNextTick);draining=true;var len=queue.length;while(len){currentQueue=queue;queue=[];while(++queueIndex<len){if(currentQueue){currentQueue[queueIndex].run()}}queueIndex=-1;len=queue.length}currentQueue=null;draining=false;runClearTimeout(timeout)}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1){for(var i=1;i<arguments.length;i++){args[i-1]=arguments[i]}}queue.push(new Item(fun,args));if(queue.length===1&&!draining){runTimeout(drainQueue)}};function Item(fun,array){this.fun=fun;this.array=array}Item.prototype.run=function(){this.fun.apply(null,this.array)};process.title="browser";process.browser=true;process.env={};process.argv=[];process.version="";process.versions={};function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.prependListener=noop;process.prependOnceListener=noop;process.listeners=function(name){return[]};process.binding=function(name){throw new Error("process.binding is not supported")};process.cwd=function(){return"/"};process.chdir=function(dir){throw new Error("process.chdir is not supported")};process.umask=function(){return 0}},{}],65:[function(require,module,exports){module.exports={gameDriver:require("@akashic/game-driver"),akashicEngine:require("@akashic/akashic-engine"),pdiBrowser:require("@akashic/pdi-browser")}},{"@akashic/akashic-engine":1,"@akashic/game-driver":4,"@akashic/pdi-browser":27}]},{},[65])(65)});