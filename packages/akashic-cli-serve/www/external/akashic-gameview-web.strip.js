!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this;t.agv=e()}}(function(){return function(){function e(t,n,r){function i(a,s){if(!n[a]){if(!t[a]){var l="function"==typeof require&&require;if(!s&&l)return l(a,!0);if(o)return o(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var h=n[a]={exports:{}};t[a][0].call(h.exports,function(e){var n=t[a][1][e];return i(n||e)},h,h.exports,e,t,n,r)}return n[a].exports}for(var o="function"==typeof require&&require,a=0;a<r.length;a++)i(r[a]);return i}return e}()({1:[function(e,t,n){var r=e("./SharedObject"),i=e("./DomElement"),o=e("./Error"),a=function(){function e(e){this._contents={};this._nextContentId=1;this.vars={};var t=new i.GameViewElement(e.container);e.sharedObject?this._gameViewShared=e.sharedObject:this._gameViewShared=new r.GameViewSharedObject({baseDownloader:e.baseDownloader});this._gameContentShared=new r.GameContentSharedObject({gameViewElement:t,gameViewWidth:e.width,gameViewHeight:e.height});t.setViewSize(e.width,e.height)}e.prototype.addContent=function(e){if(null!=e.id)throw o.ErrorFactory.createInvalidOperationError("content already added: "+e.id);e.id=this._nextContentId++;e.start(this._gameViewShared,this._gameContentShared);this._contents[e.id+""]=e};e.prototype.removeContent=function(e){if(null==e.id)throw o.ErrorFactory.createInvalidOperationError("content already removed");e.destroy();delete this._contents[e.id+""];e.id=null};e.prototype.removeAllContents=function(){var e=this;Object.keys(this._contents).forEach(function(t){e.removeContent(e._contents[t])})};e.prototype.setSocketOptions=function(e){this._gameViewShared.sessionManager.setSocketOptions(e)};e.prototype.registerExternalPlugin=function(e){this._gameViewShared.pluginManager.register(e)};e.prototype.setViewSize=function(e,t){this._gameContentShared.viewWidth=e;this._gameContentShared.viewHeight=t;this._gameContentShared.gameViewElement.setViewSize(e,t)};e.prototype.getViewSize=function(){return{width:this._gameContentShared.viewWidth,height:this._gameContentShared.viewHeight}};e.prototype.getContentById=function(e){return this._contents[e+""]};e.prototype.getGameViewSharedObject=function(){return this._gameViewShared};return e}();n.AkashicGameView=a},{"./DomElement":4,"./Error":6,"./SharedObject":12}],2:[function(e,t,n){function r(e){var t=e.naturalWidth,n=e.naturalHeight;return{x:a(e,t),y:s(e,n),width:t,height:n}}function i(e){return{x:0,y:0,width:e.outerWidth,height:e.outerHeight}}function o(e){var t=e.outerWidth/e.naturalWidth,n=e.outerHeight/e.naturalHeight,r=Math.min(t,n),i=e.naturalWidth*r,o=e.naturalHeight*r;return{x:a(e,i),y:s(e,o),width:i,height:o}}function a(e,t){switch(e.horizontalAlignment){case l.HorizontalAlignment.Left:return 0;case l.HorizontalAlignment.Center:return(e.outerWidth-t)/2;case l.HorizontalAlignment.Right:return e.outerWidth-t;default:return 0}}function s(e,t){switch(e.verticalAlignment){case l.VerticalAlignment.Top:return 0;case l.VerticalAlignment.Center:return(e.outerHeight-t)/2;case l.VerticalAlignment.Bottom:return e.outerHeight-t;default:return 0}}var l=e("@akashic/akashic-gameview");n.calcNoneLayout=r;n.calcFillLayout=i;n.calcAspectFitLayout=o},{"@akashic/akashic-gameview":16}],3:[function(e,t,n){var r=e("@akashic/akashic-gameview"),i=e("./utils"),o=e("./Error"),a=function(){function e(e,t){this._gameContentShared=null;this._gameViewShared=null;this._contentLoadListeners=new i.ObjectList;this._errorListeners=new i.ObjectList;this._contentDestroyListeners=new i.ObjectList;this._contentArea=void 0;this._contentAreaNeedsUpdate=!1;this._zIndex=void 0;this._zIndexNeedsUpdate=!1;this._contentLayout={scaleMode:r.ScaleMode.AspectFit,verticalAlignment:r.VerticalAlignment.Center,horizontalAlignment:r.HorizontalAlignment.Center,passthroughEvent:!0,backgroundColor:"transparent"};this._contentLayoutNeedsUpdate=!1;this._visibility=!0;this._visibilityNeedsUpdate=!1;this._dataBus=null;this.id=null;this.vars={};this.type=t;this._contentUrl=e.contentUrl;null!=e.contentArea&&this.setContentArea(e.contentArea);null!=e.zIndex&&this.setZIndex(e.zIndex);null!=e.contentLayout&&this.setContentLayout(e.contentLayout)}e.prototype.destroy=function(){this._contentDestroyListeners.forEach(function(e){return e.onDestroy()})};e.prototype.addContentLoadListener=function(e){this._contentLoadListeners.addItem(e)};e.prototype.removeContentLoadListener=function(e){this._contentLoadListeners.removeItem(e)};e.prototype.addErrorListener=function(e){this._errorListeners.addItem(e)};e.prototype.removeErrorListener=function(e){this._errorListeners.removeItem(e)};e.prototype.addContentDestroyListener=function(e){this._contentDestroyListeners.addItem(e)};e.prototype.removeContentDestroyListener=function(e){this._contentDestroyListeners.removeItem(e)};e.prototype.setContentArea=function(e){this._contentArea=i.assignObject(this._contentArea||{},e);this._contentAreaNeedsUpdate=!0;this._update()};e.prototype.getContentArea=function(){return i.assignObject({},this._contentArea)};e.prototype.setZIndex=function(e){this._zIndex=e;this._zIndexNeedsUpdate=!0;this._update()};e.prototype.getZIndex=function(){return this._zIndex};e.prototype.moveTopMost=function(){if(this._gameContentShared)this.setZIndex(this._gameContentShared.largestZIndex+1);else{var e=o.ErrorFactory.createInvalidOperationError("moveTopMost");this._errorListeners.forEach(function(t){return t.onError(e)})}};e.prototype.setContentLayout=function(e){this._contentLayout=i.assignObject(this._contentLayout||{},e);this._contentLayoutNeedsUpdate=!0;this._update()};e.prototype.getContentLayout=function(){return i.assignObject({},this._contentLayout)};e.prototype.hide=function(){if(this._visibility!==!1){this._visibility=!1;this._visibilityNeedsUpdate=!0;this._update()}};e.prototype.show=function(){if(this._visibility!==!0){this._visibility=!0;this._visibilityNeedsUpdate=!0;this._update()}};e.prototype.isVisible=function(){return this._visibility};e.prototype.getDataBus=function(){return this._dataBus};return e}();n.Content=a},{"./Error":6,"./utils":15,"@akashic/akashic-gameview":16}],4:[function(e,t,n){var r=function(){function e(e){var t=document.createElement("div");t.style.position="relative";t.style.overflow="hidden";t.style.pointerEvents="none";e.appendChild(t);this._parent=e;this._htmlElement=t}e.prototype.appendChild=function(e){this._htmlElement.appendChild(e)};e.prototype.removeChild=function(e){this._htmlElement.removeChild(e)};e.prototype.destroy=function(){this._parent.removeChild(this._htmlElement)};e.prototype.setViewSize=function(e,t){this._htmlElement.style.width=e+"px";this._htmlElement.style.height=t+"px"};return e}();n.GameViewElement=r;var i=function(){function e(e,t,n){var r=document.createElement("iframe");r.style.position="absolute";r.style.borderStyle="none";r.style.pointerEvents="auto";r.addEventListener("load",function(){setTimeout(function(){n()},0)});r.src=t;e.appendChild(r);this._parent=e;this._htmlElement=r}e.prototype.destroy=function(){this._parent.removeChild(this._htmlElement)};e.prototype.setContentArea=function(e){this._htmlElement.style.left=e.x+"px";this._htmlElement.style.top=e.y+"px";this._htmlElement.style.width=e.width+"px";this._htmlElement.style.height=e.height+"px"};e.prototype.setContentLayout=function(e){this._htmlElement.style.backgroundColor=e.backgroundColor};e.prototype.setZIndex=function(e){this._htmlElement.style.zIndex=e+""};e.prototype.setVisibility=function(e){this._htmlElement.style.display=e?"block":"none"};e.prototype.getContentWindow=function(){return this._htmlElement.contentWindow};return e}();n.WebContentElement=i;var o=function(){function e(e,t){var n=document.createElement("div");n.style.position="absolute";n.style.overflow="hidden";n.style.pointerEvents="auto";var r=document.createElement("div");r.style.position="absolute";r.style.overflow="hidden";r.style.pointerEvents="auto";n.appendChild(r);e.appendChild(n);this._parent=e;this._outerHtmlElement=n;this._innerHtmlElement=r;setTimeout(function(){return t(r)},0)}e.prototype.destroy=function(){this._parent.removeChild(this._outerHtmlElement)};e.prototype.setInnerSize=function(e){this._innerHtmlElement.style.left=e.x+"px";this._innerHtmlElement.style.top=e.y+"px";this._innerHtmlElement.style.width=e.width+"px";this._innerHtmlElement.style.height=e.height+"px"};e.prototype.setContentArea=function(e){this._outerHtmlElement.style.left=e.x+"px";this._outerHtmlElement.style.top=e.y+"px";this._outerHtmlElement.style.width=e.width+"px";this._outerHtmlElement.style.height=e.height+"px"};e.prototype.setContentLayout=function(e){this._outerHtmlElement.style.backgroundColor=e.backgroundColor;this._outerHtmlElement.style.pointerEvents=e.passthroughEvent?"none":"auto"};e.prototype.setZIndex=function(e){this._outerHtmlElement.style.zIndex=e+""};e.prototype.setVisibility=function(e){this._outerHtmlElement.style.display=e?"block":"none"};return e}();n.GameContentElement=o},{}],5:[function(e,t,n){var r=function(){function e(e){void 0===e&&(e=15e3);this.defaultTimeOut=e;this._createXmlHttpRequest=function(){return new XMLHttpRequest}}e.prototype.start=function(e,t){var n=this._createXmlHttpRequest();n.open("GET",e);n.responseType="text";n.timeout=this.defaultTimeOut;n.addEventListener("load",function(r){n.status>=200&&n.status<300?t(null,n.responseText):t(new Error("request failed: "+e),null)});n.addEventListener("error",function(n){return t(new Error("request error: "+e),null)});n.addEventListener("timeout",function(n){return t(new Error("request timed out: "+e),null)});n.send();return{cancel:function(){n.readyState!==n.DONE&&n.abort()},isFinished:function(){return n.readyState===n.DONE}}};return e}();n.XhrDownloader=r;var i=function(){function e(e,t){void 0===e&&(e=new r);void 0===t&&(t=2);this.baseDownloader=e;this.defaultRetry=t}e.prototype.start=function(e,t){var n=this,r={count:this.defaultRetry},i={cancel:function(){},isFinished:function(){return!1}},o=function(){var a=n.baseDownloader.start(e,function(e,n){null!=e?--r.count<=0?t(e,n):setTimeout(function(){return o()},0):t(null,n)});i.cancel=a.cancel;i.isFinished=a.isFinished};setTimeout(function(){return o()},0);return i};return e}();n.RetryDownloader=i},{}],6:[function(e,t,n){var r;!function(e){function t(e){return function(t){var n=new Error(e);n.name=e;n.cause=t;return n}}e.createInvalidOperationError=t("InvalidOperation");e.createGameDriverError=t("GameDriverError");e.createLoadMuduleError=t("LoadMuduleError");e.createPlaylogError=t("PlaylogError");e.createHttpRequestError=t("HttpRequestError");e.createInvalidGameError=t("InvalidGameError");e.createAbortGameError=t("AbortGameError")}(r=n.ErrorFactory||(n.ErrorFactory={}))},{}],7:[function(e,t,n){var r=function(){function e(){this._externalPlugin={}}e.prototype.register=function(e){this._externalPlugin[e.name]=e};e.prototype.find=function(e){return this._externalPlugin[e]};return e}();n.ExternalPluginManager=r},{}],8:[function(e,t,n){var r=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},i=e("@akashic/akashic-gameview"),o=e("@cross-border-bridge/memory-queue"),a=e("@cross-border-bridge/memory-queue-data-bus"),s=e("./Content"),l=e("./DomElement"),u=e("./GameLoader"),h=e("./utils"),d=e("./Error"),c=e("./CalcLayout"),p=function(e){function t(t){e.call(this,t,"game");this._skippingListeners=new h.ObjectList;this._loadStartTime=0;this._loader=null;this._element=null;this._isRunning=!1;this._naturalWidth=0;this._naturalHeight=0;this._replayData=null;this._replayTargetTimeFunc=null;this._contentUrl=t.contentUrl;this._player=t.player;this._playConfig=t.playConfig;this._argument=t.argument;this._pauseOnStart=t.pause;this._initialEvents=t.initialEvents;this._customizer=t.gameLoaderCustomizer}r(t,e);t.prototype.start=function(e,t){var n=this;this._loadStartTime=(new Date).getTime();this._gameViewShared=e;this._gameContentShared=t;this._loader=new u.GameLoader({shared:e,customizer:this._customizer});this._element=new l.GameContentElement(t.gameViewElement,function(e){return n._startLoader(e)});null==this._contentArea&&this.setContentArea({x:0,y:0,width:t.viewWidth,height:t.viewHeight});null==this._zIndex&&this.setZIndex(++t.largestZIndex);null==this._dataBus&&this._initDataBus()};t.prototype._startLoader=function(e){var t=this;if(this._loader){this._replayTargetTimeFunc&&void 0===this._playConfig.replayTargetTimeFunc&&(this._playConfig.replayTargetTimeFunc=this._replayTargetTimeFunc);this._loader.start({parentHtmlElement:e,contentUrl:this._contentUrl,initialEvents:this._initialEvents,argument:this._argument,pause:this._pauseOnStart,player:this._player,playConfig:this._playConfig,gameCreatedHandler:function(e){if(t._loader){t._naturalWidth=e.width;t._naturalHeight=e.height;t._contentLayoutNeedsUpdate=!0;t._isRunning=!0;t._update();t._loader.engineConfig.external.forEach(function(n){var r=t._gameViewShared.pluginManager.find(n);null!=r&&setTimeout(function(){t._loader&&r.onload(e,t.getPluginDataBus(),t)},0)});e.skippingChangedTrigger&&e.skippingChangedTrigger.handle(function(e){t._skippingListeners.forEach(function(t){return t.onSkip(e)})});var n=((new Date).getTime()-t._loadStartTime)/1e3;t._contentLoadListeners.forEach(function(e){return e.onLoad(n)})}},errorHandler:function(e){return t._errorListeners.forEach(function(t){return t.onError(e)})},gameFinishedHandler:function(){t._isRunning=!1},replayData:this._replayData||this._playConfig.replayData})}};t.prototype._update=function(){if(null!=this._element){if(this._contentAreaNeedsUpdate||this._contentLayoutNeedsUpdate){this._element.setContentArea(this._contentArea);this._element.setContentLayout(this._contentLayout);var e,t={outerWidth:this._contentArea.width,outerHeight:this._contentArea.height,naturalWidth:this._naturalWidth,naturalHeight:this._naturalHeight,horizontalAlignment:this._contentLayout.horizontalAlignment,verticalAlignment:this._contentLayout.verticalAlignment};switch(this._contentLayout.scaleMode){case i.ScaleMode.AspectFit:e=c.calcAspectFitLayout(t);break;case i.ScaleMode.Fill:e=c.calcFillLayout(t);break;default:e=c.calcNoneLayout(t)}this._element.setInnerSize(e);if(this._isRunning&&this._loader){this._loader.platform.setScale(e.width/this._naturalWidth,e.height/this._naturalHeight);this._loader.platform.notifyViewMoved()}this._contentAreaNeedsUpdate=!1;this._contentLayoutNeedsUpdate=!1}if(this._zIndexNeedsUpdate){this._element.setZIndex(this._zIndex);this._gameContentShared.largestZIndex=Math.max(this._gameContentShared.largestZIndex,this._zIndex);this._zIndexNeedsUpdate=!1}if(this._visibilityNeedsUpdate){this._element.setVisibility(this._visibility);this._visibilityNeedsUpdate=!1}}};t.prototype._initDataBus=function(){var e=new o.MemoryQueue,t=new o.MemoryQueue,n=new a.MemoryQueueDataBus(t,e),r=new a.MemoryQueueDataBus(e,t);this._dataBus=n;this._pluginDataBus=r};t.prototype.destroy=function(){if(this._loader){this._loader.stopGame();this._loader=void 0;this._element.destroy();this._element=void 0;this._dataBus.destroy();this._dataBus=void 0;this._pluginDataBus.destroy();this._pluginDataBus=void 0;e.prototype.destroy.call(this)}};t.prototype.pause=function(){this._loader?this._loader.pauseGame():this._fireInvalidOperationError("pause")};t.prototype.resume=function(){this._loader?this._loader.resumeGame():this._fireInvalidOperationError("resume")};t.prototype.isPaused=function(){return this._loader?this._loader.isPaused():!!this._pauseOnStart};t.prototype.setExecutionMode=function(e){this._loader&&this._loader.setExecutionMode(e)||this._fireInvalidOperationError("setExecutionMode")};t.prototype.getExecutionMode=function(){return this._loader?this._loader.getExecutionMode():null};t.prototype.setReplayTargetTimeFunc=function(e){this._loader&&this._loader.setReplayTargetTimeFunc(e)||this._fireInvalidOperationError("setReplayTargetTimeFunc")};t.prototype.getReplayTargetTimeFunc=function(){return this._loader?this._loader.getReplayTargetTimeFunc():null};t.prototype.setReplayOriginDate=function(e){this._loader&&this._loader.setReplayOriginDate(e)||this._fireInvalidOperationError("setReplayOriginDate")};t.prototype.getReplayOriginDate=function(){return this._loader?this._loader.getReplayOriginDate():null};t.prototype.getAverageFramePerSecond=function(e){var t=this;this._loader?setTimeout(function(){return e(t._loader?t._loader.fps:0)},0):this._fireInvalidOperationError("getAverageFramePerSecond")};t.prototype.addSkippingListener=function(e){this._skippingListeners.addItem(e)};t.prototype.removeSkippingListener=function(e){this._skippingListeners.removeItem(e)};t.prototype.sendEvents=function(e){this._loader?this._loader.sendEvents(e):this._fireInvalidOperationError("sendEvents")};t.prototype.getPlayOriginDate=function(){return this._loader?this._loader.getPlayOriginDate():null};t.prototype.getGameVars=function(e,t){var n=this;this._loader?setTimeout(function(){return t(n._loader&&n._loader.game.vars&&n._loader.game.vars[e])},0):this._fireInvalidOperationError("getGameVars")};t.prototype.getGame=function(){if(this._loader)return this._loader.game;this._fireInvalidOperationError("getGame")};t.prototype.getGameDriver=function(){if(this._loader)return this._loader.driver;this._fireInvalidOperationError("getGameDriver")};t.prototype.getPluginDataBus=function(){return this._pluginDataBus};t.prototype.dumpPlaylog=function(){return this._loader.dumpPlaylog()};t.prototype.replay=function(e,t){this._replayData=e||this.dumpPlaylog();this._replayTargetTimeFunc=t||null;this.destroy();this.start(this._gameViewShared,this._gameContentShared)};t.prototype.getGameContentSize=function(){var e=this.getGame();return{width:e.width,height:e.height}};t.prototype.setGameContentSize=function(e){var t=this.getGameDriver();if(t&&t.resetPrimarySurface){t.resetPrimarySurface(e.width,e.height);this._naturalWidth=e.width;this._naturalHeight=e.height}else this._fireInvalidOperationError("setGameContentSize")};t.prototype.getMasterVolume=function(){if(this._loader){var e=this._loader.platform;if(e&&e.getMasterVolume)return e.getMasterVolume()}this._fireInvalidOperationError("getMasterVolume")};t.prototype.setMasterVolume=function(e){if(this._loader){var t=this._loader.platform;if(t&&t.setMasterVolume){t.setMasterVolume(e);return}}this._fireInvalidOperationError("setMasterVolume")};t.prototype._fireInvalidOperationError=function(e){var t=d.ErrorFactory.createInvalidOperationError(e);this._errorListeners.forEach(function(e){return e.onError(t)})};return t}(s.Content);n.GameContent=p},{"./CalcLayout":2,"./Content":3,"./DomElement":4,"./Error":6,"./GameLoader":9,"./utils":15,"@akashic/akashic-gameview":16,"@cross-border-bridge/memory-queue":18,"@cross-border-bridge/memory-queue-data-bus":17}],9:[function(e,t,n){var r=e("@akashic/akashic-gameview"),i=e("./Error"),o=function(){function e(e){var t=this;this._playId=null;this._playToken="";this._agvExecutionMode=null;this._playlogServerUrl="";this._protocol=r.ProtocolType.WebSocket;this._amflowClient=null;this._g=null;this._GameDriver=null;this._PdiBrowser=null;this._usingCustomAmflow=!1;this._rawLoadGameConfiguration=null;this._isLoadEnded=!1;this._isPaused=!1;this.isTestbed=!1;this.engineConfig=null;this.game=null;this.driver=null;this.platform=null;this.fps=0;this._onSessionManagerError=function(e){t._param.errorHandler(i.ErrorFactory.createPlaylogError(e))};this._shared=e.shared;this._customizer=e.customizer}e.prototype.start=function(e){this._param=e;this._isPaused=!!e.pause;this._downloadEngineConfig()};e.prototype._downloadEngineConfig=function(){var e=this;this._customizer&&null!=this._customizer.overwriteEngineConfig?this._parseEngineConfig(this._customizer.overwriteEngineConfig):this._shared.downloader.start(this._param.contentUrl,function(t,n){t?e._param.errorHandler(i.ErrorFactory.createHttpRequestError(t)):e._parseEngineConfig(n)})};e.prototype._parseEngineConfig=function(e){var t=this;try{this.engineConfig=JSON.parse(e)}catch(n){this._param.errorHandler(i.ErrorFactory.createInvalidGameError(n));return}null==this.engineConfig.engine_urls&&(this.engineConfig.engine_urls=[]);null==this.engineConfig.external&&(this.engineConfig.external=[]);setTimeout(function(){return t._downloadScripts()},0)};e.prototype._detectEngineFileObject=function(e){var t=window,n=null,r=null,o=null,a=null,s=e.filter(function(e){return/.*\/engineFilesV.*\.js$/.test(e)})[0];if(s){var l=s.match(/.*\/(engineFilesV.*)\.js$/);if(l){var u=t[l[1]];n=u.akashicEngine;r=u.gameDriver;o=u.pdiBrowser}}var h=e.filter(function(e){return/.*\/playlogClientV.*\.js$/.test(e)})[0];if(h){var l=h.match(/.*\/(playlogClientV.*)\.js$/);l&&(a=t[l[1]])}if(n&&r&&o&&a)return{g:n,GameDriver:r,PdiBrowser:o,PlaylogClient:a};var d=null;try{n=t.require("@akashic/akashic-engine");r=t.require("@akashic/game-driver");o=t.require("@akashic/pdi-browser");try{a=t.require("@akashic/playlog-client")}catch(c){}if(n&&r&&o)return{g:n,GameDriver:r,PdiBrowser:o,PlaylogClient:a}}catch(c){d=c}this._param.errorHandler(i.ErrorFactory.createLoadMuduleError(d||new Error("unknown failure for require()")));return null};e.prototype._downloadScripts=function(){var e=this,t=this.engineConfig.engine_urls.concat();this.engineConfig.external.forEach(function(n){var r=e._shared.pluginManager.find(n);null!=r&&null!=r.scriptUrls&&r.scriptUrls.forEach(function(e){return t.push(e)})});this._shared.scriptManager.appendScripts(t,function(n){if(n)e._param.errorHandler(i.ErrorFactory.createHttpRequestError(n));else{var r=e._detectEngineFileObject(t);if(r){e._g=r.g;e._GameDriver=r.GameDriver;e._PdiBrowser=r.PdiBrowser;r.PlaylogClient&&!e._shared.sessionManager.isInitialized()&&e._shared.sessionManager.initialize(r.PlaylogClient);e._playId=e._param.playConfig.playId;e._agvExecutionMode=e._param.playConfig.executionMode;e.isTestbed="playlogServerUrl"in e._param.playConfig;e._param.replayData?setTimeout(function(){return e._startReplayGame()},0):e.isTestbed?setTimeout(function(){return e._startPlaylogGame()},0):setTimeout(function(){return e._startStandaloneGame()},0)}}})};e.prototype._startReplayGame=function(){var e=this;this._amflowClient=new this._GameDriver.MemoryAmflowClient({playId:this._playId,tickList:this._param.replayData.tickList,startPoints:this._param.replayData.startPoints});setTimeout(function(){return e._startGame()},0)};e.prototype._startStandaloneGame=function(){var e=this;if(this._customizer&&this._customizer.createCustomAmflowClient){this._amflowClient=this._customizer.createCustomAmflowClient();this._usingCustomAmflow=!0}else this._amflowClient=new this._GameDriver.MemoryAmflowClient({playId:this._playId});setTimeout(function(){return e._startGame()},0)};e.prototype._startPlaylogGame=function(){var e=this,t=this._param.playConfig;this._playToken=t.playToken;this._playlogServerUrl=t.playlogServerUrl;this._protocol=t.protocol||r.ProtocolType.WebSocket;if(this._customizer&&this._customizer.createCustomAmflowClient){this._amflowClient=this._customizer.createCustomAmflowClient();this._usingCustomAmflow=!0;setTimeout(function(){return e._startGame()},0)}else this._createPlaylogClient()};e.prototype._createPlaylogClient=function(){var e=this;this._shared.sessionManager.getSession(this._playlogServerUrl,this._protocol,{playId:this._playId,token:this._playToken},function(t,n,r){if(t)e._param.errorHandler(i.ErrorFactory.createPlaylogError(t));else{e._shared.sessionManager.addErrorHandler(e._playlogServerUrl,e._onSessionManagerError);n.createClient({usePrimaryChannel:r},function(t,n){if(t)e._param.errorHandler(i.ErrorFactory.createPlaylogError(t));else{e._amflowClient=n;setTimeout(function(){return e._startGame()},0)}})}})};e.prototype._startGame=function(){var e=this,t=this._createPlatform(),n=this._createGameDriver(t);n.gameCreatedTrigger.handle(function(t){e.game=t;"abortTrigger"in e.game&&e.game.abortTrigger.handle(function(){e._param.errorHandler(i.ErrorFactory.createAbortGameError())});e._param.gameCreatedHandler(t)});this.driver=n;this.platform=t;setTimeout(function(){return e._startGameDriver(n)},0)};e.prototype._createPlatform=function(){var e=this,t=null;try{var n=this._PdiBrowser,r=this._customizer&&this._customizer.createCustomAudioPlugins?this._customizer.createCustomAudioPlugins():[n.WebAudioPlugin,n.HTMLAudioPlugin];t=new n.Platform({amflow:this._amflowClient,containerView:this._param.parentHtmlElement,audioPlugins:r});this._customizer&&this._customizer.platformCustomizer&&this._customizer.platformCustomizer(t,{g:this._g});this._rawLoadGameConfiguration=t.loadGameConfiguration;t.loadGameConfiguration=function(t,n){e._customLoadGameConfiguration(t,n)}}catch(o){this._param.errorHandler(i.ErrorFactory.createLoadMuduleError(o));return}return t};e.prototype._customLoadGameConfiguration=function(e,t){var n=this,r="<agvw-queryparam>",i="<agvw-configuration>";if(e!==r)e!==i?-1===this._param.contentUrl.indexOf("?")?this._rawLoadGameConfiguration(e,t):setTimeout(function(){return t(null,{definitions:[{url:i,basePath:n._getAssetBase()},r]})},0):this._rawLoadGameConfiguration(this.engineConfig.content_url,t);else{var o=this._param.contentUrl.slice(this._param.contentUrl.indexOf("?")+1),a=o.split("&").reduce(function(e,t){var n=t.split("=");try{e[n[0]]=JSON.parse(decodeURIComponent(n[1]))}catch(r){}return e},{});setTimeout(function(){return t(null,a)},0)}};e.prototype._createGameDriver=function(e){var t=this,n=new this._GameDriver.GameDriver({platform:e,player:this._param.player,errorHandler:function(e){return t._param.errorHandler(i.ErrorFactory.createGameDriverError(e))}});return n};e.prototype._startGameDriver=function(e){var t=this;this.driver.initialize(this._createInitializeParameter(),function(e){if(e)t._param.errorHandler(i.ErrorFactory.createGameDriverError(e));else{t._param.replayData||t._sendinitialEvents();t._isPaused||t.driver.startGame();t._isLoadEnded=!0}})};e.prototype._createInitializeParameter=function(){var e=this._agvExecutionMode===r.ExecutionMode.Active&&!this._param.replayData,t=this._param.replayData||this._agvExecutionMode===r.ExecutionMode.Replay,n=this._isPaused,i=e?this._GameDriver.ExecutionMode.Active:this._GameDriver.ExecutionMode.Passive,o=t?this._createLoopConfigurationForReplay(this._param.playConfig.replayTargetTimeFunc,this._param.playConfig.replayOriginDate):this._createLoopConfigurationForRealtime(this._param.playConfig.replayTargetTimeFunc,this._param.playConfig.replayOriginDate);return{configurationUrl:this.engineConfig.content_url,assetBase:this._getAssetBase(),profiler:this._getProfiler(),gameArgs:this._param.argument,driverConfiguration:{playId:this._playId,playToken:this._playToken,executionMode:i,eventBufferMode:{isSender:!n&&!e&&!t,isReceiver:e,isDiscarder:n}},loopConfiguration:o}};e.prototype._getAssetBase=function(){var e=this.engineConfig.asset_base_url;if(null==e){var t=this.engineConfig.content_url;e=t.substr(0,t.lastIndexOf("/"))+"/"}return e};e.prototype._getProfiler=function(){var e=this,t=null;this._GameDriver.SimpleProfiler&&(t=new this._GameDriver.SimpleProfiler({interval:200,getValueHandler:function(t){e.fps=t.framePerSecond.ave}}));return t};e.prototype._sendinitialEvents=function(){var e=this;if(this._param.initialEvents)try{this._param.initialEvents.forEach(function(t){return e._amflowClient.sendEvent(t)})}catch(t){this._param.errorHandler(i.ErrorFactory.createPlaylogError(t))}};e.prototype.pauseGame=function(){if(!this._isPaused){this._isPaused=!0;if(this._isLoadEnded){this.driver._eventBuffer.setMode({isSender:!1,isDiscarder:!0});this.driver.stopGame();this.game._setMuted(!0)}}};e.prototype.resumeGame=function(){if(this._isPaused){this._isPaused=!1;if(this._isLoadEnded){this.driver.startGame();var e=this._agvExecutionMode===r.ExecutionMode.Active,t=this._agvExecutionMode===r.ExecutionMode.Replay;this.driver._eventBuffer.setMode({isSender:!e&&!t,isDiscarder:!1});this.game._setMuted(!1)}}};e.prototype.isPaused=function(){return this._isPaused};e.prototype.stopGame=function(){var e=this;if(this.driver){this.game&&this.game.audio&&Object.keys(this.game.audio).forEach(function(t){return e.game.audio[t].stopAll()});this.driver.stopGame();this.driver.initialize({driverConfiguration:{playId:null},configurationUrl:null},function(){if(e.isTestbed&&!e._usingCustomAmflow){e._shared.sessionManager.removeErrorHandler(e._playlogServerUrl,e._onSessionManagerError);e._shared.sessionManager.releaseSession(e._playlogServerUrl)}e._amflowClient=null;e._g=null;e._GameDriver=null;e._PdiBrowser=null;e.game=null;e.platform=null;e._onSessionManagerError=null;e.driver.destroy?e.driver.destroy().then(function(){return e._param.gameFinishedHandler()}):setTimeout(function(){return e._param.gameFinishedHandler()})})}else this._param&&setTimeout(function(){return e._param.gameFinishedHandler()})};e.prototype.sendEvents=function(e){var t=this;try{e.forEach(function(e){return t._amflowClient.sendEvent(e)})}catch(n){this._param.errorHandler(i.ErrorFactory.createPlaylogError(n))}};e.prototype.dumpPlaylog=function(){return this.isTestbed||!this._amflowClient.dump?null:this._amflowClient.dump()};e.prototype.setExecutionMode=function(e){if(!this.driver)return!1;if(!this.driver._gameLoop||!this.driver._eventBuffer)return!1;if(this._agvExecutionMode===e)return!0;this._agvExecutionMode=e;var t=this._agvExecutionMode===r.ExecutionMode.Active,n=this._agvExecutionMode===r.ExecutionMode.Replay,i=t?this._GameDriver.ExecutionMode.Active:this._GameDriver.ExecutionMode.Passive,o=n?this._createLoopConfigurationForReplay():this._createLoopConfigurationForRealtime();this.driver._gameLoop.setExecutionMode(i);this.driver._gameLoop.setLoopConfiguration(o);this.driver._eventBuffer.setMode({isSender:!t&&!n,isReceiver:t});return!0};e.prototype._createLoopConfigurationForRealtime=function(t,n){return{loopMode:this._GameDriver.LoopMode.Realtime,delayIgnoreThreshold:e.REALTIME_DELAY_IGNORE_THRESHOLD,jumpTryThreshold:e.REALTIME_JUMP_TRY_THRESHOLD,targetTimeFunc:t,originDate:n}};e.prototype._createLoopConfigurationForReplay=function(e,t){return{loopMode:this._GameDriver.LoopMode.Replay,delayIgnoreThreshold:Number.MAX_VALUE,jumpTryThreshold:Number.MAX_VALUE,targetTimeFunc:e,originDate:t}};e.prototype.getExecutionMode=function(){return this._agvExecutionMode};e.prototype.setReplayTargetTimeFunc=function(e){if(!this.driver||!this.driver._gameLoop)return!1;this.driver._gameLoop.setLoopConfiguration({targetTimeFunc:e});return!0};e.prototype.getReplayTargetTimeFunc=function(){if(!this.driver)return null;var e=this.driver.getLoopConfiguration();return e?e.targetTimeFunc:null};e.prototype.setReplayOriginDate=function(e){if(!this.driver||!this.driver._gameLoop)return!1;this.driver._gameLoop.setLoopConfiguration({originDate:e});return!0};e.prototype.getReplayOriginDate=function(){if(!this.driver)return null;var e=this.driver.getLoopConfiguration();return e?e.originDate:null};e.prototype.getPlayOriginDate=function(){if(!this.driver||!this.driver._gameLoop)return null;var e=this.driver._gameLoop._startedAt;return e?e:null};e.REALTIME_DELAY_IGNORE_THRESHOLD=6;e.REALTIME_JUMP_TRY_THRESHOLD=3e4;return e}();n.GameLoader=o},{"./Error":6,"@akashic/akashic-gameview":16}],10:[function(e,t,n){var r=function(){function e(t){this._loadedTable=Object.create(null);this._loadingTable=Object.create(null);this._loadFunc=t||e._addScriptElement}e._addScriptElement=function(e,t){var n=document.createElement("script");n.src=e;n.addEventListener("load",function(){t(null)});n.addEventListener("error",function(){t(new Error("failed to load script: "+e))});document.head.appendChild(n)};e.prototype.appendScripts=function(e,t){var n=this,r=[],i=e.length;e.forEach(function(e){n._appendScript(e,function(n){n&&r.push(e);--i;i>0||t(0===r.length?null:new Error("failed to load scripts: "+r.join(", ")));
})})};e.prototype._appendScript=function(e,t){var n=this;if(this._loadedTable[e])setTimeout(function(){return t(null)},0);else if(this._loadingTable[e])this._loadingTable[e].push(t);else{this._loadingTable[e]=[t];this._loadFunc(e,function(t){t||(n._loadedTable[e]=!0);var r=n._loadingTable[e];delete n._loadingTable[e];r.forEach(function(e){return e(t)})})}};return e}();n.ScriptManager=r},{}],11:[function(e,t,n){var r=e("@akashic/akashic-gameview"),i=function(){function e(){this._activeSessionTable={};this._playlogClient=null;this._socketOpts=null}e.prototype.isInitialized=function(){return!!this._playlogClient};e.prototype.initialize=function(e){this._playlogClient=e};e.prototype.setSocketOptions=function(e){this._socketOpts=e};e.prototype.getSession=function(e,t,n,i){var o=this;if(this._playlogClient){var a=this._activeSessionTable[e];if(null==a){var s=t===r.ProtocolType.EngineIO?this._playlogClient.Socket.Type.EngineIO:this._playlogClient.Socket.Type.WebSocket,l=new this._playlogClient.Session(e,{socketType:s,validationData:n,socketOpts:this._socketOpts});l.on("error",function(t){var n=o._activeSessionTable[e];null!=n&&n.errorHandlers.forEach(function(e){return e(t)})});l.open(function(t){if(t)setTimeout(function(){i(t,null,!0)},0);else{o._activeSessionTable[e]={session:l,refCount:1,errorHandlers:[]};setTimeout(function(){i(null,l,!0)},0)}})}else{++a.refCount;setTimeout(function(){i(null,a.session,!1)},0)}}else setTimeout(function(){return i(new Error("playlog-client not initialized"),null,!0)})};e.prototype.addErrorHandler=function(e,t){var n=this._activeSessionTable[e];null!=n&&n.errorHandlers.push(t)};e.prototype.removeErrorHandler=function(e,t){var n=this._activeSessionTable[e];null!=n&&(n.errorHandlers=n.errorHandlers.filter(function(e){return e!==t}))};e.prototype.releaseSession=function(e){var t=this._activeSessionTable[e];if(null!=t&&--t.refCount<1){t.session.close(function(){});this._activeSessionTable[e]=null}};return e}();n.SessionManager=i},{"@akashic/akashic-gameview":16}],12:[function(e,t,n){var r=e("./ExternalPluginManager"),i=e("./SessionManager"),o=e("./Downloader"),a=e("./ScriptManager"),s=function(){function e(e){this.pluginManager=new r.ExternalPluginManager;this.sessionManager=new i.SessionManager;this.scriptManager=new a.ScriptManager;this.downloader=new o.RetryDownloader(e?e.baseDownloader:void 0)}return e}();n.GameViewSharedObject=s;var l=function(){function e(e){this.gameViewElement=e.gameViewElement;this.largestZIndex=0;this.viewWidth=e.gameViewWidth;this.viewHeight=e.gameViewHeight}return e}();n.GameContentSharedObject=l},{"./Downloader":5,"./ExternalPluginManager":7,"./ScriptManager":10,"./SessionManager":11}],13:[function(e,t,n){var r=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},i=e("@cross-border-bridge/post-message-data-bus"),o=e("./Content"),a=e("./DomElement"),s=function(e){function t(t){e.call(this,t,"web");this._element=null}r(t,e);t.prototype.start=function(e,t){var n=this,r=(new Date).getTime();this._gameViewShared=e;this._gameContentShared=t;this._element=new a.WebContentElement(t.gameViewElement,this._contentUrl,function(){var e=((new Date).getTime()-r)/1e3;n._dataBus=new i.PostMessageDataBus(n._element.getContentWindow());n._contentLoadListeners.forEach(function(t){return t.onLoad(e)})});null==this._contentArea&&this.setContentArea({x:0,y:0,width:t.viewWidth,height:t.viewHeight});null==this._zIndex&&this.setZIndex(++t.largestZIndex)};t.prototype._update=function(){if(null!=this._element){if(this._contentAreaNeedsUpdate){this._element.setContentArea(this._contentArea);this._contentAreaNeedsUpdate=!1}if(this._zIndexNeedsUpdate){this._element.setZIndex(this._zIndex);this._gameContentShared.largestZIndex=Math.max(this._gameContentShared.largestZIndex,this._zIndex);this._zIndexNeedsUpdate=!1}if(this._contentLayoutNeedsUpdate){this._element.setContentLayout(this._contentLayout);this._contentLayoutNeedsUpdate=!1}if(this._visibilityNeedsUpdate){this._element.setVisibility(this._visibility);this._visibilityNeedsUpdate=!1}}};t.prototype.destroy=function(){this._element.destroy();e.prototype.destroy.call(this)};return t}(o.Content);n.WebContent=s},{"./Content":3,"./DomElement":4,"@cross-border-bridge/post-message-data-bus":19}],14:[function(e,t,n){var r=e("@akashic/akashic-gameview");n.ScaleMode=r.ScaleMode;n.VerticalAlignment=r.VerticalAlignment;n.HorizontalAlignment=r.HorizontalAlignment;n.ExecutionMode=r.ExecutionMode;n.ProtocolType=r.ProtocolType;var i=e("./AkashicGameViewWeb");n.AkashicGameView=i.AkashicGameView;var o=e("./SharedObject");n.GameViewSharedObject=o.GameViewSharedObject;n.GameContentSharedObject=o.GameContentSharedObject;var a=e("./Content");n.Content=a.Content;var s=e("./Downloader");n.XhrDownloader=s.XhrDownloader;n.RetryDownloader=s.RetryDownloader;var l=e("./WebContent");n.WebContent=l.WebContent;var u=e("./GameContent");n.GameContent=u.GameContent;var h=e("./utils");n.ObjectList=h.ObjectList},{"./AkashicGameViewWeb":1,"./Content":3,"./Downloader":5,"./GameContent":8,"./SharedObject":12,"./WebContent":13,"./utils":15,"@akashic/akashic-gameview":16}],15:[function(e,t,n){function r(e,t){Object.keys(t).forEach(function(n){e[n]=t[n]});return e}var i=function(){function e(){this._objectList=[]}e.prototype.addItem=function(e){this._objectList.push(e)};e.prototype.removeItem=function(e){this._objectList=this._objectList.filter(function(t){return t!==e})};e.prototype.removeAllItems=function(){this._objectList=[]};e.prototype.forEach=function(e){this._objectList.forEach(e)};return e}();n.ObjectList=i;n.assignObject=r},{}],16:[function(e,t,n){!function(e){e[e.None=0]="None";e[e.Fill=1]="Fill";e[e.AspectFit=2]="AspectFit"}(n.ScaleMode||(n.ScaleMode={}));n.ScaleMode;!function(e){e[e.Top=0]="Top";e[e.Center=1]="Center";e[e.Bottom=2]="Bottom"}(n.VerticalAlignment||(n.VerticalAlignment={}));n.VerticalAlignment;!function(e){e[e.Left=0]="Left";e[e.Center=1]="Center";e[e.Right=2]="Right"}(n.HorizontalAlignment||(n.HorizontalAlignment={}));n.HorizontalAlignment;!function(e){e[e.Active=0]="Active";e[e.Passive=1]="Passive";e[e.Replay=2]="Replay"}(n.ExecutionMode||(n.ExecutionMode={}));n.ExecutionMode;!function(e){e[e.WebSocket=0]="WebSocket";e[e.EngineIO=1]="EngineIO"}(n.ProtocolType||(n.ProtocolType={}));n.ProtocolType},{}],17:[function(e,t,n){
// Copyright © 2017 DWANGO Co., Ltd.
var r=function(){function e(e,t){this._sender=e;this._receiver=t;this._handlers=[];var n=this;this._receiver.setHandler(function(){for(var e=0,t=n._handlers;e<t.length;e++){var r=t[e];r.apply(n,arguments)}})}e.prototype.send=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];this._sender.send.apply(this._sender,e)};e.prototype.addHandler=function(e){this._handlers.push(e)};e.prototype.removeHandler=function(e){var t=this._handlers.indexOf(e);0>t||this._handlers.splice(t,1)};e.prototype.removeAllHandlers=function(){this._handlers=[]};e.prototype.destroy=function(){this.removeAllHandlers();this._receiver.setHandler(void 0)};return e}();n.MemoryQueueDataBus=r},{}],18:[function(e,t,n){
// Copyright © 2017 DWANGO Co., Ltd.
var r=function(){function e(e){this._handler=e}e.prototype.setHandler=function(e){this._handler=e};e.prototype.send=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];this._handler&&this._handler.apply(null,e)};return e}();n.MemoryQueue=r},{}],19:[function(e,t,n){function r(e){Object.keys(l).length||window.addEventListener("message",o);var t=s.indexOf(e._target);-1===t&&(t=s.push(e._target)-1);l[t]||(l[t]=[]);l[t].push(e)}function i(e){var t=s.indexOf(e._target);if(-1!==t){l[t]=l[t].filter(function(t){return t!==e});if(!l[t].length){delete l[t];s[t]=null}Object.keys(l).length||window.removeEventListener("message",o)}}function o(e){var t=s.indexOf(e.source);if(-1!==t){var n=null;try{n=JSON.parse(e.data)}catch(r){return}l[t].forEach(function(e){e._onMessage(n)})}}
// Copyright © 2017 DWANGO Co., Ltd.
var a=function(){function e(e){this._target=e;this._handlers=[]}e.prototype.send=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];this._target&&this._target.postMessage(JSON.stringify(e),"*")};e.prototype.addHandler=function(e){if(this._target){0===this._handlers.length&&r(this);this._handlers.push(e)}};e.prototype.removeHandler=function(e){if(this._target){var t=this._handlers.indexOf(e);if(!(0>t)){this._handlers.splice(t,1);0===this._handlers.length&&i(this)}}};e.prototype.removeAllHandlers=function(){if(this._target&&0!==this._handlers.length){this._handlers=[];i(this)}};e.prototype._onMessage=function(e){if(this._target&&0!==this._handlers.length){for(var t=[],n=0,r=this._handlers;n<r.length;n++){var i=r[n],o=i.apply(null,e);o&&t.push(i)}for(var a=0;a<t.length;a++){var i=t[a];this.removeHandler(i)}}};e.prototype.destroy=function(){if(this._target){this.removeAllHandlers();this._target=void 0}};return e}();n.PostMessageDataBus=a;var s=[],l={}},{}]},{},[14])(14)});